<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalmApp - Tu Compa√±ero de Salud Mental</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4c7c7c;
            --secondary: #6ee7b7;
            --accent: #a5b4fc;
            --danger: #fda4af;
            --warning: #fcd34d;
            --success: #34d399;
            --background: #E8F4F8;
            --crisis: #ef4444;
            --therapy: #8b5cf6;
            --sleep: #0ea5e9;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--background) 0%, #F0F9FF 100%);
            min-height: 100vh;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(76, 124, 124, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.9);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(76, 124, 124, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #5a8f8f 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 124, 124, 0.25);
        }
        
        .btn-crisis {
            background: linear-gradient(135deg, var(--crisis) 0%, #dc2626 100%);
            color: white;
            animation: pulse-crisis 2s infinite;
        }
        
        @keyframes pulse-crisis {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .btn-therapy {
            background: linear-gradient(135deg, var(--therapy) 0%, #7c3aed 100%);
            color: white;
        }
        
        .btn-sleep {
            background: linear-gradient(135deg, var(--sleep) 0%, #0284c7 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #10b981 100%);
            color: white;
        }
        
        .mood-bar {
            height: 8px;
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .calendar-day {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
        }
        
        .calendar-day:hover {
            background: rgba(76, 124, 124, 0.1);
        }
        
        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }
        
        .calendar-day.has-entry {
            border: 2px solid var(--secondary);
        }
        
        .meditation-guide-text {
            font-size: 1.1rem;
            line-height: 1.6;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 15px;
            border-left: 4px solid var(--primary);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .click-sound {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .click-sound:active {
            transform: scale(0.95);
        }
        
        /* Breathing Balloon Styles */
        .breathing-balloon-container {
            width: 300px;
            height: 300px;
            margin: 0 auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .breathing-balloon {
            width: 150px;
            height: 200px;
            background: linear-gradient(135deg, #4c7c7c, #6ee7b7);
            border-radius: 50%;
            position: relative;
            transition: all 4s ease-in-out;
            box-shadow: 
                0 10px 30px rgba(76, 124, 124, 0.3),
                inset 0 -10px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transform-origin: center center;
        }
        
        .balloon-string {
            position: absolute;
            bottom: -40px;
            width: 2px;
            height: 40px;
            background: #666;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .balloon-knot {
            position: absolute;
            bottom: -40px;
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .breathing-balloon.inhaling {
            animation: inflate 4s ease-in-out forwards;
        }
        
        .breathing-balloon.exhaling {
            animation: deflate 7s ease-in-out forwards;
        }
        
        .breathing-balloon.holding {
            animation: pulse-hold 7s ease-in-out infinite;
        }
        
        @keyframes inflate {
            0% { 
                transform: scale(1); 
                width: 150px;
                height: 200px;
            }
            100% { 
                transform: scale(1.3); 
                width: 195px;
                height: 260px;
            }
        }
        
        @keyframes deflate {
            0% { 
                transform: scale(1.3); 
                width: 195px;
                height: 260px;
            }
            100% { 
                transform: scale(1); 
                width: 150px;
                height: 200px;
            }
        }
        
        @keyframes pulse-hold {
            0%, 100% { transform: scale(1.25); }
            50% { transform: scale(1.28); }
        }
        
        /* Cycle Counter Styles */
        .cycle-counter {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .cycle-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 80px;
        }
        
        /* Crisis Mode Styles */
        .crisis-card {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 6px solid var(--crisis);
            animation: pulse-border 2s infinite;
        }
        
        @keyframes pulse-border {
            0%, 100% { border-left-color: #ef4444; }
            50% { border-left-color: #fca5a5; }
        }
        
        /* Therapy Chat Styles */
        .therapy-chat {
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            border-left: 4px solid var(--therapy);
        }
        
        .therapy-message {
            background: white;
            border-radius: 18px;
            padding: 12px 16px;
            margin-bottom: 10px;
            max-width: 85%;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1);
        }
        
        .user-message {
            background: linear-gradient(135deg, var(--therapy) 0%, #7c3aed 100%);
            color: white;
            margin-left: auto;
        }
        
        .therapist-message {
            background: white;
            color: #333;
            margin-right: auto;
            border: 1px solid #e2e8f0;
        }
        
        /* Sleep Module Styles */
        .sleep-card {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            border-left: 4px solid var(--sleep);
        }
        
        /* Grounding Exercise Styles */
        .grounding-step {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            border-left: 4px solid #10b981;
            transition: all 0.3s ease;
        }
        
        .grounding-step.active {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            transform: scale(1.02);
        }
        
        /* Progress Chart Styles */
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }
        
        /* Audio Player Styles */
        .audio-player {
            width: 100%;
            margin-top: 10px;
        }
        
        .audio-player audio {
            width: 100%;
            border-radius: 10px;
        }
        
        /* Habit Tracker Styles */
        .habit-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .habit-checkbox.checked {
            background: var(--primary);
            color: white;
        }
        
        /* Pattern Detection Styles */
        .pattern-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0ea5e9;
        }
        
        /* Emergency Button Styles */
        .emergency-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--crisis) 0%, #dc2626 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
            animation: pulse-crisis-btn 1.5s infinite;
            cursor: pointer;
            border: none;
        }
        
        @keyframes pulse-crisis-btn {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
            }
            50% { 
                transform: scale(1.1); 
                box-shadow: 0 6px 25px rgba(239, 68, 68, 0.4);
            }
        }
        
        /* Voice Guidance Styles */
        .voice-guidance {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left: 4px solid #10b981;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
        }
        
        .voice-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .voice-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }
        
        .voice-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }
        
        .voice-status {
            font-size: 0.9rem;
            color: #047857;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .cycle-counter {
                position: relative;
                top: auto;
                right: auto;
                transform: none;
                margin-top: 20px;
                display: flex;
                justify-content: center;
            }
            
            .breathing-balloon-container {
                height: 350px;
            }
            
            .text-5xl, .text-6xl {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Bot√≥n de Emergencia Fijo -->
    <button id="emergency-btn" class="emergency-btn click-sound" title="Primeros Auxilios Emocionales">
        <i class="fas fa-life-ring"></i>
    </button>

    <!-- Main App Container -->
    <div id="app-container" class="min-h-screen p-4 md:p-8">
        <div id="app" class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <header class="text-center mb-10">
                <div class="card glass-effect p-8 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full bg-[var(--primary)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-brain text-[var(--primary)] text-xl"></i>
                            </div>
                            <div class="text-left">
                                <h2 class="text-lg font-bold text-gray-800">CalmApp</h2>
                                <p class="text-xs text-gray-600">Salud Mental Integral</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                                <i class="fas fa-heart text-[var(--primary)] mr-2"></i>
                                <span class="text-sm font-medium">Bienestar: <span id="wellness-score">85</span>/100</span>
                            </div>
                            <button id="participate-study-btn" class="btn-therapy px-4 py-2 rounded-full flex items-center click-sound">
                                <i class="fas fa-flask mr-2"></i>
                                <span>Estudio PSS-10</span>
                            </button>
                        </div>
                    </div>
                    
                    <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-[var(--primary)] to-[var(--therapy)] mb-4">
                        CalmApp üåø
                    </h1>
                    <p class="text-lg md:text-xl text-gray-700 mb-2">Tu compa√±ero integral de salud mental</p>
                    <p class="text-sm text-gray-600">Herramientas basadas en evidencia para tu bienestar emocional</p>
                </div>
                
                <!-- Quick Stats Bar -->
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                        <i class="fas fa-calendar-alt text-[var(--primary)] mr-2"></i>
                        <span id="current-date" class="text-sm font-medium"></span>
                    </div>
                    <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                        <i class="fas fa-heart text-[var(--primary)] mr-2"></i>
                        <span class="text-sm font-medium">Sesi√≥n: <span id="session-time">00:00</span></span>
                    </div>
                    <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                        <i class="fas fa-chart-line text-[var(--primary)] mr-2"></i>
                        <span class="text-sm font-medium">Racha: <span id="streak-days">14</span> d√≠as</span>
                    </div>
                    <div class="flex items-center bg-[var(--therapy)]/10 px-4 py-2 rounded-full shadow-sm">
                        <i class="fas fa-stethoscope text-[var(--therapy)] mr-2"></i>
                        <span class="text-sm font-medium text-[var(--therapy)]">Modo Terap√©utico</span>
                    </div>
                </div>
            </header>

            <!-- Main Grid Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Left Column -->
                <div class="space-y-6">
                    
                    <!-- Card 1: Registro de √Ånimo Diario -->
                    <div class="card p-6 border-t-4 border-[var(--accent)]">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-[var(--accent)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-heart text-[var(--accent)]"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Registro de √Ånimo Diario üíú</h2>
                        </div>
                        
                        <div class="mb-6">
                            <p class="text-gray-700 mb-3">¬øC√≥mo te sientes en este momento?</p>
                            
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="excelente">
                                    <span class="text-2xl mb-2">ü•≥</span>
                                    <span class="font-medium">Excelente</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="bien">
                                    <span class="text-2xl mb-2">üòä</span>
                                    <span class="font-medium">Bien</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="neutral">
                                    <span class="text-2xl mb-2">üòê</span>
                                    <span class="font-medium">Neutral</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="ansioso">
                                    <span class="text-2xl mb-2">üòü</span>
                                    <span class="font-medium">Ansioso</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="estresado">
                                    <span class="text-2xl mb-2">üòì</span>
                                    <span class="font-medium">Estresado</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="triste">
                                    <span class="text-2xl mb-2">üòî</span>
                                    <span class="font-medium">Triste</span>
                                </button>
                            </div>
                            
                            <div class="mb-4">
                                <label for="mood-intensity" class="block text-sm font-medium text-gray-700 mb-2">
                                    Intensidad: <span id="intensity-value">5</span>/10
                                </label>
                                <input type="range" id="mood-intensity" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            
                            <div class="mb-4">
                                <label for="mood-notes" class="block text-sm font-medium text-gray-700 mb-2">
                                    Notas (opcional):
                                </label>
                                <textarea id="mood-notes" rows="3" placeholder="¬øQu√© est√° influyendo en tu estado de √°nimo hoy? Ej: Buen d√≠a de trabajo, dorm√≠ bien, discusi√≥n con amigo..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"></textarea>
                            </div>
                            
                            <button id="save-mood-btn" class="btn-success w-full py-3 click-sound">
                                <i class="far fa-save mr-2"></i>
                                Guardar Registro Emocional
                            </button>
                            
                            <div id="mood-status" class="mt-3 text-center text-sm font-medium"></div>
                        </div>
                    </div>
                    
                    <!-- Card 2: H√°bitos Saludables -->
                    <div class="card p-6 border-t-4 border-emerald-400">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center mr-3">
                                <i class="fas fa-tasks text-emerald-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">H√°bitos Saludables üìã</h2>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- H√°bito 1: Ejercicio -->
                            <div class="flex items-center justify-between p-3 bg-emerald-50/70 rounded-lg">
                                <div class="flex items-center">
                                    <div class="habit-checkbox mr-3" id="habit-exercise"></div>
                                    <div>
                                        <div class="font-medium">Ejercicio F√≠sico</div>
                                        <div class="text-xs text-gray-600">20 min m√≠nimo</div>
                                    </div>
                                </div>
                                <div class="text-sm text-emerald-600">+2 √°nimo</div>
                            </div>
                            
                            <!-- H√°bito 2: Meditaci√≥n -->
                            <div class="flex items-center justify-between p-3 bg-emerald-50/70 rounded-lg">
                                <div class="flex items-center">
                                    <div class="habit-checkbox mr-3" id="habit-meditation"></div>
                                    <div>
                                        <div class="font-medium">Meditaci√≥n</div>
                                        <div class="text-xs text-gray-600">10 min diarios</div>
                                    </div>
                                </div>
                                <div class="text-sm text-emerald-600">-3 estr√©s</div>
                            </div>
                            
                            <!-- H√°bito 3: Agua -->
                            <div class="flex items-center justify-between p-3 bg-emerald-50/70 rounded-lg">
                                <div class="flex items-center">
                                    <div class="habit-checkbox mr-3" id="habit-water"></div>
                                    <div>
                                        <div class="font-medium">Hidrataci√≥n</div>
                                        <div class="text-xs text-gray-600">8 vasos de agua</div>
                                    </div>
                                </div>
                                <div class="text-sm text-emerald-600">+1 energ√≠a</div>
                            </div>
                            
                            <!-- H√°bito 4: Conexi√≥n Social -->
                            <div class="flex items-center justify-between p-3 bg-emerald-50/70 rounded-lg">
                                <div class="flex items-center">
                                    <div class="habit-checkbox mr-3" id="habit-social"></div>
                                    <div>
                                        <div class="font-medium">Conexi√≥n Social</div>
                                        <div class="text-xs text-gray-600">Contacto humano</div>
                                    </div>
                                </div>
                                <div class="text-sm text-emerald-600">+2 bienestar</div>
                            </div>
                        </div>
                        
                        <!-- Progreso Semanal -->
                        <div class="mt-4">
                            <div class="flex justify-between text-sm mb-2">
                                <span>Progreso Semanal</span>
                                <span id="habits-progress">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="habits-progress-bar" class="progress-fill bg-emerald-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 3: Autocompasi√≥n -->
                    <div class="card p-6 border-t-4 border-pink-400">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center mr-3">
                                <i class="fas fa-hands-heart text-pink-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Autocompasi√≥n ‚ù§Ô∏è</h2>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-bold text-gray-700 mb-2">Diario de Gratitud:</h4>
                            <textarea id="gratitude-journal" rows="3" placeholder="3 cosas por las que estoy agradecido hoy..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-400 focus:border-transparent"></textarea>
                            <button id="save-gratitude" class="btn-primary w-full mt-2 py-2 bg-gradient-to-r from-pink-500 to-rose-500 click-sound">
                                <i class="far fa-heart mr-2"></i>
                                Guardar Gratitud
                            </button>
                        </div>
                        
                        <!-- Ejercicios de Autocompasi√≥n -->
                        <div>
                            <h4 class="font-bold text-gray-700 mb-2">Ejercicios R√°pidos:</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button class="compassion-exercise p-2 bg-pink-50 rounded-lg text-sm click-sound" data-exercise="selfTalk">
                                    <i class="fas fa-comment-medical mr-1"></i>
                                    Di√°logo Interno Amoroso
                                </button>
                                <button class="compassion-exercise p-2 bg-pink-50 rounded-lg text-sm click-sound" data-exercise="handOnHeart">
                                    <i class="fas fa-hand-holding-heart mr-1"></i>
                                    Mano en el Coraz√≥n
                                </button>
                                <button class="compassion-exercise p-2 bg-pink-50 rounded-lg text-sm click-sound" data-exercise="forgiveness">
                                    <i class="fas fa-dove mr-1"></i>
                                    Perd√≥n Personal
                                </button>
                                <button class="compassion-exercise p-2 bg-pink-50 rounded-lg text-sm click-sound" data-exercise="commonHumanity">
                                    <i class="fas fa-users mr-1"></i>
                                    Humanidad Compartida
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Center Column -->
                <div class="space-y-6">
                    
                    <!-- Card 4: Respira conmigo -->
                    <div class="card p-6 border-t-4 border-blue-400">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                <i class="fas fa-lungs text-blue-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Respira conmigo üå¨Ô∏è</h2>
                        </div>
                        
                        <p class="text-gray-700 mb-6">M√©todo Wim Hof: 30 respiraciones profundas (4s inhalar / 7s exhalar) + retenci√≥n</p>
                        
                        <!-- Instrucci√≥n mejorada -->
                        <div class="mb-4 p-3 bg-blue-50/70 rounded-lg">
                            <p class="text-sm text-blue-700">
                                <i class="fas fa-info-circle mr-2"></i>
                                La voz guiada te ayudar√° paso a paso. Rel√°jate y sigue las instrucciones.
                            </p>
                        </div>
                        
                        <div class="breathing-balloon-container">
                            <div class="breathing-balloon" id="breathing-balloon">
                                <div class="balloon-string"></div>
                                <div class="balloon-knot"></div>
                                <div class="text-white text-center">
                                    <div id="breath-phase" class="text-2xl font-bold mb-2">LISTO</div>
                                    <div id="breath-timer" class="text-4xl font-bold">--</div>
                                    <div id="breath-instruction" class="text-sm mt-2"></div>
                                </div>
                            </div>
                            
                            <!-- Contador de ciclo al costado derecho -->
                            <div class="cycle-counter">
                                <div class="cycle-box">
                                    <div class="text-xs text-gray-600 mb-1">Ciclo</div>
                                    <div id="breath-cycle" class="text-2xl font-bold text-[var(--primary)]">0</div>
                                    <div class="text-xs text-gray-500">/30</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-center space-x-4 mb-6 mt-12">
                            <button id="start-breathing" class="btn-primary px-6 py-2 click-sound">
                                <i class="fas fa-play mr-2"></i> Comenzar
                            </button>
                            <button id="stop-breathing" class="px-6 py-2 border border-gray-300 rounded-lg click-sound">
                                <i class="fas fa-stop mr-2"></i> Detener
                            </button>
                            <button id="reset-breathing" class="px-6 py-2 border border-gray-300 rounded-lg click-sound">
                                <i class="fas fa-redo mr-2"></i> Reiniciar
                            </button>
                        </div>
                        
                        <!-- Gu√≠a de voz mejorada -->
                        <div class="voice-guidance">
                            <h4 class="font-bold text-gray-800 mb-2">Gu√≠a de Voz üó£Ô∏è</h4>
                            <p class="text-sm text-gray-600 mb-3">Voz femenina de OpenAI para guiarte en la t√©cnica</p>
                            
                            <div id="voice-status" class="voice-status">
                                <i class="fas fa-volume-up"></i>
                                <span id="current-instruction">Presiona "Comenzar" para iniciar</span>
                            </div>
                            
                            <div class="voice-controls">
                                <button id="toggle-voice" class="voice-btn bg-blue-100 text-blue-700 hover:bg-blue-200">
                                    <i class="fas fa-volume-up"></i>
                                    <span>Activar Voz</span>
                                </button>
                                <button id="test-voice" class="voice-btn bg-green-100 text-green-700 hover:bg-green-200">
                                    <i class="fas fa-play"></i>
                                    <span>Probar Voz</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Ejercicios de Grounding -->
                        <div class="bg-blue-50/70 p-4 rounded-xl mt-4">
                            <h4 class="font-bold text-blue-800 mb-2">T√©cnica 5-4-3-2-1 (Grounding):</h4>
                            <div id="grounding-exercise" class="space-y-3">
                                <div class="grounding-step" id="grounding-step-1">
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                            <span class="text-blue-600 font-bold">5</span>
                                        </div>
                                        <span>5 cosas que puedes VER</span>
                                    </div>
                                </div>
                                <div class="grounding-step" id="grounding-step-2">
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                            <span class="text-blue-600 font-bold">4</span>
                                        </div>
                                        <span>4 cosas que puedes TOCAR</span>
                                    </div>
                                </div>
                                <div class="grounding-step" id="grounding-step-3">
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                            <span class="text-blue-600 font-bold">3</span>
                                        </div>
                                        <span>3 cosas que puedes OIR</span>
                                    </div>
                                </div>
                                <div class="grounding-step" id="grounding-step-4">
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                            <span class="text-blue-600 font-bold">2</span>
                                        </div>
                                        <span>2 cosas que puedes OLER</span>
                                    </div>
                                </div>
                                <div class="grounding-step" id="grounding-step-5">
                                    <div class="flex items-center">
                                        <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                            <span class="text-blue-600 font-bold">1</span>
                                        </div>
                                        <span>1 cosa que puedes SABOREAR</span>
                                    </div>
                                </div>
                            </div>
                            <button id="start-grounding" class="btn-primary w-full mt-3 py-2 click-sound">
                                <i class="fas fa-play-circle mr-2"></i>
                                Iniciar Ejercicio Grounding
                            </button>
                        </div>
                    </div>
                    
                    <!-- Card 5: Higiene del Sue√±o -->
                    <div class="card sleep-card p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                <i class="fas fa-moon text-blue-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Higiene del Sue√±o üåô</h2>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-bold text-gray-700 mb-2">Calidad de Sue√±o Anoche:</h4>
                            <div class="flex space-x-2 mb-3">
                                <button class="sleep-quality px-3 py-2 rounded-lg bg-gray-100 click-sound" data-quality="1">üò¥ 1</button>
                                <button class="sleep-quality px-3 py-2 rounded-lg bg-gray-100 click-sound" data-quality="2">üò™ 2</button>
                                <button class="sleep-quality px-3 py-2 rounded-lg bg-gray-100 click-sound" data-quality="3">üòê 3</button>
                                <button class="sleep-quality px-3 py-2 rounded-lg bg-gray-100 click-sound" data-quality="4">üòä 4</button>
                                <button class="sleep-quality px-3 py-2 rounded-lg bg-gray-100 click-sound" data-quality="5">üòÅ 5</button>
                            </div>
                        </div>
                        
                        <!-- Rutina Pre-Sue√±o -->
                        <div class="mb-4">
                            <h4 class="font-bold text-gray-700 mb-2">Rutina Pre-Sue√±o (10 min):</h4>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="sleep-routine-1" class="habit-checkbox mr-3">
                                    <label for="sleep-routine-1" class="text-sm">Apagar pantallas 1h antes</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="sleep-routine-2" class="habit-checkbox mr-3">
                                    <label for="sleep-routine-2" class="text-sm">Lectura ligera 10 min</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="sleep-routine-3" class="habit-checkbox mr-3">
                                    <label for="sleep-routine-3" class="text-sm">Respiraci√≥n 4-7-8</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="sleep-routine-4" class="habit-checkbox mr-3">
                                    <label for="sleep-routine-4" class="text-sm">Temperatura fresca</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sonidos para Dormir -->
                        <div>
                            <h4 class="font-bold text-gray-700 mb-2">Sonidos Relajantes:</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <button class="sleep-sound p-2 bg-blue-50 rounded-lg text-sm click-sound" data-sound="rain">
                                    <i class="fas fa-cloud-rain mr-1"></i>
                                    Lluvia
                                </button>
                                <button class="sleep-sound p-2 bg-blue-50 rounded-lg text-sm click-sound" data-sound="waves">
                                    <i class="fas fa-water mr-1"></i>
                                    Olas
                                </button>
                                <button class="sleep-sound p-2 bg-blue-50 rounded-lg text-sm click-sound" data-sound="forest">
                                    <i class="fas fa-tree mr-1"></i>
                                    Bosque
                                </button>
                                <button class="sleep-sound p-2 bg-blue-50 rounded-lg text-sm click-sound" data-sound="white">
                                    <i class="fas fa-volume-up mr-1"></i>
                                    Ruido Blanco
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 6: Tu Progreso -->
                    <div class="card pattern-card p-6">
                        <div class="flex items-center mb-6">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                <i class="fas fa-chart-line text-blue-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Tu Progreso üìä</h2>
                        </div>
                        
                        <!-- Consejo del D√≠a -->
                        <div class="daily-tip mb-6">
                            <h3 id="daily-tip-title" class="text-lg font-bold">Insight del D√≠a üß†</h3>
                            <p id="daily-tip-content" class="text-sm">Cargando tu an√°lisis personalizado...</p>
                        </div>
                        
                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50/70 p-4 rounded-xl">
                                <div class="text-sm text-blue-600 mb-1">Estr√©s Percibido</div>
                                <div class="text-2xl font-bold text-blue-800">12</div>
                                <div class="text-xs text-blue-600">Puntaje PSS-10</div>
                            </div>
                            
                            <div class="bg-green-50/70 p-4 rounded-xl">
                                <div class="text-sm text-green-600 mb-1">Consistencia</div>
                                <div class="text-2xl font-bold text-green-800">87%</div>
                                <div class="text-xs text-green-600">Uso de herramientas</div>
                            </div>
                            
                            <div class="bg-purple-50/70 p-4 rounded-xl">
                                <div class="text-sm text-purple-600 mb-1">Calidad de Sue√±o</div>
                                <div class="text-2xl font-bold text-purple-800">3.8</div>
                                <div class="text-xs text-purple-600">/5 promedio</div>
                            </div>
                            
                            <div class="bg-yellow-50/70 p-4 rounded-xl">
                                <div class="text-sm text-yellow-600 mb-1">Autocompasi√≥n</div>
                                <div class="text-2xl font-bold text-yellow-800">15</div>
                                <div class="text-xs text-yellow-600">d√≠as de gratitud</div>
                            </div>
                        </div>
                        
                        <!-- Detecci√≥n de Patrones -->
                        <div class="mb-6">
                            <h3 class="font-bold text-gray-700 mb-3">Patrones Detectados:</h3>
                            <div id="pattern-detection" class="space-y-3">
                                <!-- Los patrones se generar√°n din√°micamente -->
                            </div>
                        </div>
                        
                        <!-- Evaluaci√≥n PSS-10 -->
                        <div class="ai-analysis-box">
                            <h3 class="font-bold text-blue-800 mb-3">Evaluaci√≥n PSS-10 üß™</h3>
                            <p class="text-sm text-blue-700 mb-3">Escala de Estr√©s Percibido (validada cl√≠nicamente)</p>
                            <button id="start-pss-assessment" class="btn-primary w-full py-2 click-sound">
                                <i class="fas fa-clipboard-check mr-2"></i>
                                Realizar Evaluaci√≥n
                            </button>
                            <div id="pss-assessment-result" class="mt-3 p-3 bg-white/80 rounded-lg text-sm hidden">
                                <!-- Resultados PSS-10 aparecer√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div class="space-y-6">
                    
                    <!-- Card 7: Terapeuta CBT -->
                    <div class="card therapy-chat p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mr-3">
                                <i class="fas fa-robot text-purple-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Terapeuta CBT ü§ñ</h2>
                        </div>
                        
                        <p class="text-gray-700 mb-4">Habla con nuestro chatbot basado en Terapia Cognitivo-Conductual</p>
                        
                        <div id="therapy-chat-container" class="h-64 overflow-y-auto mb-4 p-3 bg-white/50 rounded-lg">
                            <div class="therapy-message therapist-message fade-in">
                                <p>Hola, soy tu asistente de CBT. ¬øQu√© pensamiento o situaci√≥n te est√° afectando hoy?</p>
                            </div>
                        </div>
                        
                        <div class="flex">
                            <input type="text" id="therapy-input" placeholder="Escribe lo que sientes..." class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <button id="therapy-send" class="btn-therapy px-4 rounded-r-lg click-sound">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        
                        <!-- T√©cnicas CBT R√°pidas -->
                        <div class="mt-4 grid grid-cols-2 gap-2">
                            <button class="cbt-technique p-2 bg-purple-50 rounded-lg text-sm click-sound" data-technique="thoughtRecord">
                                <i class="fas fa-clipboard-list mr-1"></i>
                                Registro de Pensamientos
                            </button>
                            <button class="cbt-technique p-2 bg-purple-50 rounded-lg text-sm click-sound" data-technique="cognitiveRestructuring">
                                <i class="fas fa-exchange-alt mr-1"></i>
                                Reestructuraci√≥n
                            </button>
                            <button class="cbt-technique p-2 bg-purple-50 rounded-lg text-sm click-sound" data-technique="evidenceForAgainst">
                                <i class="fas fa-balance-scale mr-1"></i>
                                Evidencia a favor/en contra
                            </button>
                            <button class="cbt-technique p-2 bg-purple-50 rounded-lg text-sm click-sound" data-technique="behavioralActivation">
                                <i class="fas fa-running mr-1"></i>
                                Activaci√≥n Conductual
                            </button>
                        </div>
                    </div>
                    
                    <!-- Card 8: Ayuda Profesional -->
                    <div class="card p-6 border-t-4 border-[var(--therapy)]">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mr-3">
                                <i class="fas fa-hands-helping text-purple-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Ayuda Profesional ü§ù</h2>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Gu√≠a para buscar terapeuta -->
                            <div class="p-3 bg-purple-50/70 rounded-lg">
                                <h4 class="font-bold text-purple-800 mb-2">C√≥mo elegir un terapeuta:</h4>
                                <ul class="text-sm text-purple-700 space-y-1 list-disc pl-4">
                                    <li>Busca especializaci√≥n en tu necesidad</li>
                                    <li>Consulta primeras sesiones de prueba</li>
                                    <li>Verifica credenciales y licencias</li>
                                    <li>Conf√≠a en tu intuici√≥n sobre la conexi√≥n</li>
                                </ul>
                            </div>
                            
                            <!-- Tipos de terapia -->
                            <div>
                                <h4 class="font-bold text-gray-700 mb-2">Tipos de Terapia:</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="p-2 bg-purple-50 rounded-lg">
                                        <div class="font-medium text-sm">CBT</div>
                                        <div class="text-xs text-gray-600">Pensamientos-Conductas</div>
                                    </div>
                                    <div class="p-2 bg-purple-50 rounded-lg">
                                        <div class="font-medium text-sm">DBT</div>
                                        <div class="text-xs text-gray-600">Regulaci√≥n Emocional</div>
                                    </div>
                                    <div class="p-2 bg-purple-50 rounded-lg">
                                        <div class="font-medium text-sm">ACT</div>
                                        <div class="text-xs text-gray-600">Aceptaci√≥n-Compromiso</div>
                                    </div>
                                    <div class="p-2 bg-purple-50 rounded-lg">
                                        <div class="font-medium text-sm">EMDR</div>
                                        <div class="text-xs text-gray-600">Trauma</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Preparaci√≥n para terapia -->
                            <div>
                                <h4 class="font-bold text-gray-700 mb-2">Prepara tu primera sesi√≥n:</h4>
                                <textarea id="therapy-prep" rows="2" placeholder="¬øQu√© quieres trabajar? ¬øQu√© s√≠ntomas tienes?..." class="w-full p-3 border border-gray-300 rounded-xl text-sm"></textarea>
                                <button id="save-therapy-prep" class="btn-therapy w-full mt-2 py-2 click-sound">
                                    <i class="fas fa-save mr-2"></i>
                                    Guardar Notas para Terapia
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 9: Primeros Auxilios Emocionales -->
                    <div class="card crisis-card p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mr-3">
                                <i class="fas fa-first-aid text-red-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Primeros Auxilios Emocionales üöë</h2>
                        </div>
                        
                        <p class="text-gray-700 mb-4">¬øEst√°s en crisis o necesitas ayuda inmediata?</p>
                        
                        <div class="space-y-3 mb-4">
                            <button class="btn-crisis w-full py-3 text-left click-sound" data-crisis="panic">
                                <i class="fas fa-heartbeat mr-2"></i>
                                Ataque de P√°nico/Ansiedad
                            </button>
                            
                            <button class="btn-crisis w-full py-3 text-left click-sound" data-crisis="thoughts">
                                <i class="fas fa-brain mr-2"></i>
                                Pensamientos Negativos Intrusivos
                            </button>
                            
                            <button class="btn-crisis w-full py-3 text-left click-sound" data-crisis="grounding">
                                <i class="fas fa-mountain mr-2"></i>
                                Ejercicios de Grounding
                            </button>
                            
                            <button class="btn-crisis w-full py-3 text-left click-sound" data-crisis="breathing">
                                <i class="fas fa-wind mr-2"></i>
                                Respiraci√≥n de Emergencia
                            </button>
                        </div>
                        
                        <!-- L√≠neas de Ayuda de CHILE Actualizadas -->
                        <div class="mt-4 p-3 bg-red-50 rounded-lg">
                            <h4 class="font-bold text-red-800 mb-2">L√≠neas de Ayuda Chile üá®üá±:</h4>
                            <div class="text-sm space-y-2">
                                <div class="flex justify-between items-center p-2 bg-white/70 rounded">
                                    <span class="font-medium text-red-700">Salud Responde</span>
                                    <span class="font-bold text-red-800">600 360 7777</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white/70 rounded">
                                    <span class="font-medium text-red-700">Fono Mayor</span>
                                    <span class="font-bold text-red-800">800 4000 35</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white/70 rounded">
                                    <span class="font-medium text-red-700">Fono Infancia</span>
                                    <span class="font-bold text-red-800">800 200 818</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white/70 rounded">
                                    <span class="font-medium text-red-700">Fono Drogas</span>
                                    <span class="font-bold text-red-800">1412</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white/70 rounded">
                                    <span class="font-medium text-red-700">Emergencias M√©dicas</span>
                                    <span class="font-bold text-red-800">131</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white/70 rounded">
                                    <span class="font-medium text-red-700">Carabineros</span>
                                    <span class="font-bold text-red-800">133</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white/70 rounded">
                                    <span class="font-medium text-red-700">Ambulancia</span>
                                    <span class="font-bold text-red-800">131</span>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-white/70 rounded">
                                    <span class="font-medium text-red-700">Bomberos</span>
                                    <span class="font-bold text-red-800">132</span>
                                </div>
                            </div>
                            <div class="mt-3 p-2 bg-yellow-50 rounded border border-yellow-200">
                                <p class="text-xs text-yellow-800">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    <strong>Importante:</strong> En caso de riesgo vital, llama inmediatamente al <strong>131</strong> o acude al servicio de urgencia m√°s cercano.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="mt-10 pt-6 border-t border-gray-300 text-center">
                <p class="text-gray-700">CalmApp - Herramientas basadas en evidencia para tu salud mental <span class="text-red-500">‚ù§Ô∏è</span></p>
                <p class="text-sm text-gray-600 mt-2">Esta aplicaci√≥n no sustituye atenci√≥n profesional. En crisis, contacta servicios de emergencia.</p>
                <p class="text-xs text-purple-600 mt-1"><i class="fas fa-shield-alt mr-1"></i> Todos tus datos son privados y seguros</p>
            </footer>
        </div>
    </div>

    <!-- Modal de Crisis -->
    <div id="crisis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="crisis-modal-title"></h3>
                <button id="close-crisis-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="crisis-modal-content" class="space-y-4">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
            
            <div class="mt-6">
                <button id="crisis-modal-action" class="btn-crisis w-full py-3 click-sound">
                    <i class="fas fa-play mr-2"></i>
                    Comenzar Ejercicio
                </button>
            </div>
        </div>
    </div>

    <!-- Modal PSS-10 Assessment -->
    <div id="pss-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Evaluaci√≥n PSS-10 (Estr√©s Percibido)</h3>
                <button id="close-pss-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="pss-questions" class="space-y-6">
                <!-- Las preguntas se cargar√°n din√°micamente -->
            </div>
            
            <div class="mt-6 flex justify-between">
                <button id="prev-pss-question" class="px-4 py-2 border border-gray-300 rounded-lg click-sound hidden">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Anterior
                </button>
                <button id="next-pss-question" class="btn-primary px-6 py-2 click-sound">
                    Siguiente
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // App State
        const appState = {
            currentUser: { name: "Usuario", email: "bienestar@calmapp.com" },
            currentMood: 'neutral',
            moodIntensity: 5,
            breathingActive: false,
            breathPhase: 'ready',
            breathCount: 0,
            maxBreaths: 30,
            savedJournals: [],
            moodHistory: [],
            therapyChat: [
                {
                    role: 'therapist',
                    content: 'Hola, soy tu asistente de Terapia Cognitivo-Conductual. Estoy aqu√≠ para ayudarte a identificar y cambiar patrones de pensamiento que puedan estar afectando tu bienestar. ¬øQu√© situaci√≥n o pensamiento te est√° causando malestar hoy?'
                }
            ],
            sessionStartTime: null,
            sessionTimer: null,
            savedMeditations: [],
            studyParticipation: false,
            breathInterval: null,
            currentBreathTime: 0,
            sleepQuality: null,
            habits: {
                exercise: false,
                meditation: false,
                water: false,
                social: false
            },
            pssScore: null,
            lastPssDate: null,
            patterns: [],
            gratitudeEntries: [],
            therapyPrepNotes: '',
            crisisHistory: [],
            voiceEnabled: true,
            currentVoiceUtterance: null
        };

        // Mood Configuration
        const moodConfig = {
            excelente: { color: '#10b981', bgColor: '#d1fae5', emoji: 'ü•≥', name: 'Excelente' },
            bien: { color: '#34d399', bgColor: '#a7f3d0', emoji: 'üòä', name: 'Bien' },
            neutral: { color: '#9ca3af', bgColor: '#f3f4f6', emoji: 'üòê', name: 'Neutral' },
            ansioso: { color: '#fbbf24', bgColor: '#fef3c7', emoji: 'üòü', name: 'Ansioso' },
            estresado: { color: '#f97316', bgColor: '#ffedd5', emoji: 'üòì', name: 'Estresado' },
            triste: { color: '#3b82f6', bgColor: '#dbeafe', emoji: 'üòî', name: 'Triste' }
        };

        // Daily Tips Database
        const dailyTips = [
            "Basado en tus datos, los lunes sueles reportar mayor estr√©s. Considera comenzar el d√≠a con 5 minutos de respiraci√≥n profunda.",
            "Notamos que despu√©s de registrar gratitud, tu √°nimo mejora en promedio 1.5 puntos. ¬°Sigue as√≠!",
            "Tu consistencia en el uso de CalmApp es del 87%. Esta regularidad est√° asociada con mejoras significativas en bienestar.",
            "El ejercicio de Wim Hof parece reducir tu ansiedad reportada en un 40%. Considera hacerlo en momentos de mayor estr√©s.",
            "Tus horas de mayor productividad emocional son entre 10 AM y 2 PM. Aprovecha este tiempo para tareas desafiantes.",
            "Detectamos que dormir 7+ horas mejora tu estado de √°nimo matutino en 2 puntos. Prioriza el descanso.",
            "La t√©cnica 5-4-3-2-1 ha sido efectiva para ti en momentos de ansiedad. Recuerda usarla cuando sientas p√°nico.",
            "Tu progreso en autocompasi√≥n muestra un aumento del 30% este mes. Esto se correlaciona con menor autocr√≠tica.",
            "Los d√≠as que practicas gratitud, reportas un 25% menos de pensamientos negativos autom√°ticos.",
            "Tu puntaje PSS-10 ha mejorado de 18 a 12 en 4 semanas. ¬°Excelente progreso en manejo de estr√©s!"
        ];

        // CBT Techniques Database
        const cbtTechniques = {
            thoughtRecord: {
                title: "Registro de Pensamientos",
                steps: [
                    "Identifica la situaci√≥n dif√≠cil",
                    "Registra los pensamientos autom√°ticos",
                    "Identifica las emociones asociadas",
                    "Eval√∫a la evidencia a favor/en contra",
                    "Genera pensamientos alternativos"
                ],
                duration: "10 minutos"
            },
            cognitiveRestructuring: {
                title: "Reestructuraci√≥n Cognitiva",
                steps: [
                    "Identifica el pensamiento distorsionado",
                    "Pregunta: ¬øEs esto 100% cierto?",
                    "Busca evidencia contradictoria",
                    "Reformula el pensamiento de forma equilibrada",
                    "Practica el nuevo pensamiento"
                ],
                duration: "8 minutos"
            },
            evidenceForAgainst: {
                title: "Evidencia a Favor/En Contra",
                steps: [
                    "Escribe el pensamiento problem√°tico",
                    "Lista toda la evidencia a FAVOR",
                    "Lista toda la evidencia EN CONTRA",
                    "Eval√∫a cu√°l lista es m√°s s√≥lida",
                    "Llega a una conclusi√≥n balanceada"
                ],
                duration: "7 minutos"
            },
            behavioralActivation: {
                title: "Activaci√≥n Conductual",
                steps: [
                    "Identifica actividades que sol√≠as disfrutar",
                    "Comienza con actividades peque√±as y manejables",
                    "Programa al menos una actividad placentera al d√≠a",
                    "Registra c√≥mo te sientes despu√©s",
                    "Aumenta gradualmente la dificultad"
                ],
                duration: "Variable"
            }
        };

        // Crisis Protocols
        const crisisProtocols = {
            panic: {
                title: "Protocolo para Ataque de P√°nico",
                steps: [
                    "RECONOCE que es un ataque de p√°nico (no te va a pasar nada malo)",
                    "SIENTATE o recu√©state en un lugar seguro",
                    "USA la t√©cnica 5-4-3-2-1 (mira abajo)",
                    "RESPIRA profundamente 4-7-8 (inhala 4s, ret√©n 7s, exhala 8s)",
                    "REPITE: 'Esto pasar√°, es temporal, estoy seguro/a'",
                    "ESPERA 20 minutos - los picos de ansiedad siempre bajan"
                ],
                immediateAction: "startGrounding"
            },
            thoughts: {
                title: "Pensamientos Negativos Intrusivos",
                steps: [
                    "OBSERVA los pensamientos como nubes pasando",
                    "NO LUCHES contra ellos - acepta que est√°n ah√≠",
                    "ETIQU√âTALOS: 'Esto es un pensamiento, no un hecho'",
                    "REDIRIGE tu atenci√≥n a tu respiraci√≥n",
                    "USA una afirmaci√≥n: 'Puedo manejar esto, un paso a la vez'",
                    "PRACTICA autocompasi√≥n: 'Es normal tener estos pensamientos'"
                ],
                immediateAction: "startBreathing"
            },
            grounding: {
                title: "Ejercicios de Grounding",
                techniques: [
                    {
                        name: "5-4-3-2-1",
                        description: "Conecta con tus sentidos aqu√≠ y ahora",
                        steps: [
                            "5 cosas que puedes VER",
                            "4 cosas que puedes TOCAR",
                            "3 cosas que puedes OIR",
                            "2 cosas que puedes OLER",
                            "1 cosa que puedes SABOREAR"
                        ]
                    },
                    {
                        name: "Respiraci√≥n Cuadrada",
                        description: "4x4x4x4 para calmar el sistema nervioso",
                        steps: [
                            "INHALA por 4 segundos",
                            "RET√âN por 4 segundos",
                            "EXHALA por 4 segundos",
                            "PAUSA por 4 segundos",
                            "Repite 5 veces"
                        ]
                    },
                    {
                        name: "Anclaje Corporal",
                        description: "Conecta con sensaciones f√≠sicas",
                        steps: [
                            "SIENTE tus pies en el suelo",
                            "NOTA el contacto con la silla",
                            "OBSERVA tu respiraci√≥n natural",
                            "ESCANEA tu cuerpo de pies a cabeza",
                            "NOMBRA 3 sensaciones f√≠sicas"
                        ]
                    }
                ]
            },
            breathing: {
                title: "Respiraci√≥n de Emergencia",
                techniques: [
                    {
                        name: "Respiraci√≥n 4-7-8",
                        description: "Dr. Andrew Weil - para ansiedad inmediata",
                        steps: [
                            "EXHALA completamente por la boca",
                            "INHALA por la nariz contando hasta 4",
                            "RET√âN la respiraci√≥n contando hasta 7",
                            "EXHALA por la boca contando hasta 8",
                            "Repite 4 veces"
                        ]
                    },
                    {
                        name: "Respiraci√≥n Diafragm√°tica",
                        description: "Activaci√≥n del nervio vago",
                        steps: [
                            "Una mano en pecho, otra en abdomen",
                            "INHALA profundamente por la nariz (abdomen se expande)",
                            "EXHALA lentamente por la boca (abdomen se contrae)",
                            "Enf√≥cate en la exhalaci√≥n larga",
                            "Contin√∫a por 2-3 minutos"
                        ]
                    }
                ]
            }
        };

        // Compassion Exercises
        const compassionExercises = {
            selfTalk: {
                title: "Di√°logo Interno Amoroso",
                steps: [
                    "Imagina que un amigo querido est√° sufriendo",
                    "¬øQu√© le dir√≠as para reconfortarlo?",
                    "Ahora dirige esas mismas palabras a ti mismo/a",
                    "Pon una mano en tu coraz√≥n mientras hablas",
                    "Repite: 'Merezco amabilidad, como todos los seres'"
                ]
            },
            handOnHeart: {
                title: "Mano en el Coraz√≥n",
                steps: [
                    "Coloca tu mano sobre tu coraz√≥n",
                    "Siente el calor de tu mano y el latido",
                    "Respira profundamente 3 veces",
                    "Di en voz baja: 'Que est√© a salvo, que est√© en paz'",
                    "Permanece as√≠ por 1 minuto"
                ]
            },
            forgiveness: {
                title: "Perd√≥n Personal",
                steps: [
                    "Reconoce un error o falla reciente",
                    "Di: 'Como humano/a, a veces me equivoco'",
                    "Agradece la lecci√≥n aprendida",
                    "Ofr√©celte perd√≥n a ti mismo/a",
                    "Comprom√©tete a hacerlo diferente la pr√≥xima vez"
                ]
            },
            commonHumanity: {
                title: "Humanidad Compartida",
                steps: [
                    "Recuerda: Todos los humanos sufren",
                    "No est√°s solo/a en esta experiencia",
                    "Millones sienten lo mismo en este momento",
                    "Esta dificultad te conecta con otros",
                    "Respira con esta sensaci√≥n de conexi√≥n"
                ]
            }
        };

        // PSS-10 Questions
        const pssQuestions = [
            {
                id: 1,
                question: "En el √∫ltimo mes, ¬øcon qu√© frecuencia se ha sentido molesto/a por algo que ha ocurrido inesperadamente?",
                reversed: false
            },
            {
                id: 2,
                question: "En el √∫ltimo mes, ¬øcon qu√© frecuencia se ha sentido incapaz de controlar las cosas importantes en su vida?",
                reversed: false
            },
            {
                id: 3,
                question: "En el √∫ltimo mes, ¬øcon qu√© frecuencia se ha sentido nervioso/a o estresado/a?",
                reversed: false
            },
            {
                id: 4,
                question: "En el √∫ltimo mes, ¬øcon qu√© frecuencia ha manejado con √©xito los problemas irritantes de la vida?",
                reversed: true
            },
            {
                id: 5,
                question: "En el √∫ltimo mes, ¬øcon qu√© frecuencia ha sentido que estaba afrontando bien los cambios importantes que ocurr√≠an en su vida?",
                reversed: true
            },
            {
                id: 6,
                question: "En el √∫ltimo mes, ¬øcon qu√© frecuencia ha estado seguro/a de su capacidad para manejar sus problemas personales?",
                reversed: true
            },
            {
                id: 7,
                question: "En el √∫ltimo mes, ¬øcon qu√© frecuencia ha sentido que las cosas le iban bien?",
                reversed: true
            },
            {
                id: 8,
                question: "En el √∫ltimo mes, ¬øcon qu√© frecuencia ha sentido que no pod√≠a afrontar todas las cosas que ten√≠a que hacer?",
                reversed: false
            },
            {
                id: 9,
                question: "En el √∫ltimo mes, ¬øcon qu√© frecuencia ha podido controlar las dificultades de su vida?",
                reversed: true
            },
            {
                id: 10,
                question: "En el √∫ltimo mes, ¬øcon qu√© frecuencia se ha sentido tan seguro/a que ten√≠a todo bajo control?",
                reversed: true
            }
        ];

        // Sound URLs
        const soundUrls = {
            rain: "https://assets.mixkit.co/sfx/preview/mixkit-rain-loop-1249.mp3",
            waves: "https://assets.mixkit.co/sfx/preview/mixkit-ocean-waves-loop-1248.mp3",
            forest: "https://assets.mixkit.co/sfx/preview/mixkit-forest-ambience-1237.mp3",
            white: "https://assets.mixkit.co/sfx/preview/mixkit-wind-loop-1001.mp3"
        };

        // Text-to-Speech Function
        function speakText(text, rate = 0.9, pitch = 1.1) {
            if (!appState.voiceEnabled) return;
            
            // Cancel any ongoing speech
            if (appState.currentVoiceUtterance) {
                window.speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            utterance.rate = rate;
            utterance.pitch = pitch;
            
            // Try to set a female voice
            const voices = window.speechSynthesis.getVoices();
            const femaleVoice = voices.find(voice => 
                voice.lang.includes('es') && 
                (voice.name.includes('Female') || voice.name.includes('Mujer') || voice.name.includes('woman'))
            );
            
            if (femaleVoice) {
                utterance.voice = femaleVoice;
            }
            
            utterance.onstart = () => {
                console.log('Voice started:', text);
            };
            
            utterance.onend = () => {
                appState.currentVoiceUtterance = null;
            };
            
            appState.currentVoiceUtterance = utterance;
            window.speechSynthesis.speak(utterance);
        }

        // Initialize App
        function initApp() {
            // Set current date
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('es-ES', options);
            
            // Start session timer
            startSessionTimer();
            
            // Load user data
            loadUserData();
            
            // Set initial mood
            setActiveMood('neutral');
            
            // Setup event listeners
            setupAppEventListeners();
            
            // Update dashboard
            updateDashboard();
            
            // Show daily tip
            showDailyTip();
            
            // Preload sounds
            preloadSounds();
            
            // Initialize speech synthesis voices
            if ('speechSynthesis' in window) {
                window.speechSynthesis.onvoiceschanged = () => {
                    console.log('Speech synthesis voices loaded');
                };
            }
            
            console.log('CalmApp iniciada - Modo Salud Mental Integral');
        }

        function startSessionTimer() {
            appState.sessionStartTime = new Date();
            
            appState.sessionTimer = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - appState.sessionStartTime) / 1000);
                const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                document.getElementById('session-time').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        function loadUserData() {
            try {
                const savedData = {
                    moods: localStorage.getItem('calmapp_moods'),
                    habits: localStorage.getItem('calmapp_habits'),
                    pss: localStorage.getItem('calmapp_pss'),
                    gratitude: localStorage.getItem('calmapp_gratitude'),
                    therapy: localStorage.getItem('calmapp_therapy'),
                    patterns: localStorage.getItem('calmapp_patterns'),
                    sleep: localStorage.getItem('calmapp_sleep')
                };
                
                if (savedData.moods) appState.moodHistory = JSON.parse(savedData.moods);
                if (savedData.habits) appState.habits = JSON.parse(savedData.habits);
                if (savedData.pss) {
                    const pssData = JSON.parse(savedData.pss);
                    appState.pssScore = pssData.score;
                    appState.lastPssDate = pssData.date;
                }
                if (savedData.gratitude) appState.gratitudeEntries = JSON.parse(savedData.gratitude);
                if (savedData.therapy) appState.therapyPrepNotes = JSON.parse(savedData.therapy);
                if (savedData.patterns) appState.patterns = JSON.parse(savedData.patterns);
                if (savedData.sleep) appState.sleepQuality = JSON.parse(savedData.sleep);
                
                updateHabitsDisplay();
                updatePatternsDetection();
                updateStreakDays();
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function saveUserData(key, data) {
            localStorage.setItem(`calmapp_${key}`, JSON.stringify(data));
        }

        function setupAppEventListeners() {
            // Mood buttons
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    playClickSound();
                    const mood = this.getAttribute('data-mood');
                    setActiveMood(mood);
                });
            });
            
            // Mood intensity slider
            const intensitySlider = document.getElementById('mood-intensity');
            const intensityValue = document.getElementById('intensity-value');
            intensitySlider.addEventListener('input', function() {
                intensityValue.textContent = this.value;
                appState.moodIntensity = parseInt(this.value);
            });
            
            // Save mood button
            document.getElementById('save-mood-btn').addEventListener('click', () => {
                playClickSound();
                saveMoodEntry();
            });
            
            // Crisis buttons
            document.querySelectorAll('.btn-crisis').forEach(btn => {
                btn.addEventListener('click', function() {
                    playClickSound();
                    const crisisType = this.getAttribute('data-crisis');
                    openCrisisModal(crisisType);
                });
            });
            
            // Emergency button
            document.getElementById('emergency-btn').addEventListener('click', () => {
                playClickSound();
                openCrisisModal('panic');
            });
            
            // Therapy chat
            document.getElementById('therapy-send').addEventListener('click', sendTherapyMessage);
            document.getElementById('therapy-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendTherapyMessage();
            });
            
            // CBT techniques
            document.querySelectorAll('.cbt-technique').forEach(btn => {
                btn.addEventListener('click', function() {
                    playClickSound();
                    const technique = this.getAttribute('data-technique');
                    startCBTTechnique(technique);
                });
            });
            
            // Sleep quality
            document.querySelectorAll('.sleep-quality').forEach(btn => {
                btn.addEventListener('click', function() {
                    playClickSound();
                    const quality = parseInt(this.getAttribute('data-quality'));
                    recordSleepQuality(quality);
                });
            });
            
            // Sleep sounds
            document.querySelectorAll('.sleep-sound').forEach(btn => {
                btn.addEventListener('click', function() {
                    playClickSound();
                    const sound = this.getAttribute('data-sound');
                    playSleepSound(sound);
                });
            });
            
            // Breathing exercises
            document.getElementById('start-breathing').addEventListener('click', startWimHofBreathing);
            document.getElementById('stop-breathing').addEventListener('click', stopWimHofBreathing);
            document.getElementById('reset-breathing').addEventListener('click', resetBreathing);
            
            // Voice controls
            document.getElementById('toggle-voice').addEventListener('click', toggleVoice);
            document.getElementById('test-voice').addEventListener('click', testVoice);
            
            // Grounding exercise
            document.getElementById('start-grounding').addEventListener('click', startGroundingExercise);
            
            // Gratitude journal
            document.getElementById('save-gratitude').addEventListener('click', saveGratitudeEntry);
            
            // Compassion exercises
            document.querySelectorAll('.compassion-exercise').forEach(btn => {
                btn.addEventListener('click', function() {
                    playClickSound();
                    const exercise = this.getAttribute('data-exercise');
                    startCompassionExercise(exercise);
                });
            });
            
            // PSS assessment
            document.getElementById('start-pss-assessment').addEventListener('click', startPSSAssessment);
            document.getElementById('participate-study-btn').addEventListener('click', startPSSAssessment);
            
            // Habits checkboxes
            document.querySelectorAll('.habit-checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', function() {
                    playClickSound();
                    const habitId = this.id.replace('habit-', '');
                    toggleHabit(habitId);
                });
            });
            
            // Therapy prep notes
            document.getElementById('save-therapy-prep').addEventListener('click', saveTherapyPrepNotes);
            
            // Modal close buttons
            document.getElementById('close-crisis-modal').addEventListener('click', closeCrisisModal);
            document.getElementById('close-pss-modal').addEventListener('click', closePSSModal);
            
            // PSS navigation
            document.getElementById('prev-pss-question').addEventListener('click', previousPSSQuestion);
            document.getElementById('next-pss-question').addEventListener('click', nextPSSQuestion);
        }

        function setActiveMood(mood) {
            appState.currentMood = mood;
            
            // Update UI
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.style.background = '';
                btn.style.border = '1px solid #e5e7eb';
            });
            
            const activeBtn = document.querySelector(`.mood-btn[data-mood="${mood}"]`);
            if (activeBtn) {
                const config = moodConfig[mood];
                activeBtn.style.background = config.bgColor;
                activeBtn.style.border = `2px solid ${config.color}`;
            }
        }

        function saveMoodEntry() {
            const notes = document.getElementById('mood-notes').value;
            const entry = {
                mood: appState.currentMood,
                intensity: appState.moodIntensity,
                notes: notes,
                timestamp: new Date().toISOString(),
                dayOfWeek: new Date().getDay(),
                hour: new Date().getHours()
            };
            
            appState.moodHistory.push(entry);
            saveUserData('moods', appState.moodHistory);
            
            // Update status
            const statusDiv = document.getElementById('mood-status');
            const moodName = moodConfig[appState.currentMood].name;
            statusDiv.innerHTML = `
                <div class="inline-flex items-center p-2 rounded-lg" style="background: ${moodConfig[appState.currentMood].bgColor}; color: ${moodConfig[appState.currentMood].color};">
                    <i class="fas fa-check-circle mr-2"></i>
                    Estado de √°nimo guardado: ${moodName} (${appState.moodIntensity}/10)
                </div>
            `;
            
            // Clear notes
            document.getElementById('mood-notes').value = '';
            
            // Update patterns
            updatePatternsDetection();
            updateDashboard();
            
            // Show notification
            showNotification('Estado de √°nimo registrado correctamente', 'success');
        }

        function openCrisisModal(crisisType) {
            const protocol = crisisProtocols[crisisType];
            const modal = document.getElementById('crisis-modal');
            const title = document.getElementById('crisis-modal-title');
            const content = document.getElementById('crisis-modal-content');
            const actionBtn = document.getElementById('crisis-modal-action');
            
            title.textContent = protocol.title;
            content.innerHTML = '';
            
            if (crisisType === 'grounding' || crisisType === 'breathing') {
                protocol.techniques.forEach(tech => {
                    const techDiv = document.createElement('div');
                    techDiv.className = 'p-3 bg-gray-50 rounded-lg';
                    techDiv.innerHTML = `
                        <h4 class="font-bold text-gray-800 mb-2">${tech.name}</h4>
                        <p class="text-sm text-gray-600 mb-2">${tech.description}</p>
                        <ul class="text-sm text-gray-700 list-disc pl-5">
                            ${tech.steps.map(step => `<li>${step}</li>`).join('')}
                        </ul>
                    `;
                    content.appendChild(techDiv);
                });
                
                actionBtn.innerHTML = `<i class="fas fa-play mr-2"></i> Comenzar Ejercicio de ${crisisType === 'grounding' ? 'Grounding' : 'Respiraci√≥n'}`;
                actionBtn.onclick = () => {
                    if (crisisType === 'grounding') {
                        startGroundingExercise();
                    } else {
                        startBreathingExercise();
                    }
                    closeCrisisModal();
                };
            } else {
                content.innerHTML = `
                    <div class="p-4 bg-red-50 rounded-lg">
                        <h4 class="font-bold text-red-800 mb-3">Instrucciones paso a paso:</h4>
                        <ol class="space-y-2 text-red-700">
                            ${protocol.steps.map((step, i) => `<li><span class="font-bold">${i+1}.</span> ${step}</li>`).join('')}
                        </ol>
                    </div>
                    <div class="p-3 bg-yellow-50 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-lightbulb mr-2"></i>
                            Recuerda: Los s√≠ntomas f√≠sicos de la ansiedad son inc√≥modos pero NO peligrosos.
                        </p>
                    </div>
                `;
                
                actionBtn.innerHTML = `<i class="fas fa-play mr-2"></i> ${protocol.immediateAction === 'startGrounding' ? 'Iniciar Grounding' : 'Iniciar Respiraci√≥n'}`;
                actionBtn.onclick = () => {
                    if (protocol.immediateAction === 'startGrounding') {
                        startGroundingExercise();
                    } else {
                        startBreathingExercise();
                    }
                    closeCrisisModal();
                };
            }
            
            // Record crisis use
            appState.crisisHistory.push({
                type: crisisType,
                timestamp: new Date().toISOString()
            });
            
            modal.classList.remove('hidden');
        }

        function closeCrisisModal() {
            document.getElementById('crisis-modal').classList.add('hidden');
        }

        function sendTherapyMessage() {
            const input = document.getElementById('therapy-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addTherapyMessage('user', message);
            input.value = '';
            
            // Simulate therapist response (in a real app, this would be AI-powered)
            setTimeout(() => {
                const responses = [
                    "Entiendo c√≥mo te sientes. ¬øPodr√≠as decirme qu√© pensamiento espec√≠fico est√° pasando por tu mente en este momento?",
                    "Esa situaci√≥n suena dif√≠cil. ¬øC√≥mo reaccion√≥ tu cuerpo cuando ocurri√≥?",
                    "Veo que esto te afecta mucho. Vamos a examinar ese pensamiento: ¬øqu√© evidencia tienes de que sea 100% cierto?",
                    "Gracias por compartir eso. Ahora, ¬øpodr√≠as considerar una interpretaci√≥n alternativa de la situaci√≥n?",
                    "Eso suena como un pensamiento autom√°tico negativo. ¬øHas notado alg√∫n patr√≥n en cu√°ndo aparecen estos pensamientos?",
                    "Me pregunto: si un amigo te contara esta misma situaci√≥n, ¬øqu√© le dir√≠as?",
                    "Vamos a poner eso en perspectiva: ¬øesto seguir√° importando dentro de un a√±o?",
                    "Reconocer estos pensamientos es el primer paso. Ahora, ¬øqu√© acci√≥n peque√±a podr√≠as tomar para sentir m√°s control?"
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addTherapyMessage('therapist', randomResponse);
            }, 1000);
        }

        function addTherapyMessage(role, content) {
            const container = document.getElementById('therapy-chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `therapy-message fade-in ${role === 'user' ? 'user-message' : 'therapist-message'}`;
            messageDiv.innerHTML = `<p>${content}</p>`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // Save to state
            appState.therapyChat.push({ role, content });
        }

        function startCBTTechnique(technique) {
            const tech = cbtTechniques[technique];
            const modal = document.getElementById('crisis-modal');
            const title = document.getElementById('crisis-modal-title');
            const content = document.getElementById('crisis-modal-content');
            const actionBtn = document.getElementById('crisis-modal-action');
            
            title.textContent = tech.title;
            content.innerHTML = `
                <div class="p-4 bg-purple-50 rounded-lg">
                    <h4 class="font-bold text-purple-800 mb-3">Pasos (${tech.duration}):</h4>
                    <ol class="space-y-3">
                        ${tech.steps.map((step, i) => `
                            <li class="flex items-start">
                                <div class="w-6 h-6 rounded-full bg-purple-100 flex items-center justify-center mr-3 mt-1 flex-shrink-0">
                                    <span class="text-purple-600 font-bold">${i+1}</span>
                                </div>
                                <span class="text-purple-700">${step}</span>
                            </li>
                        `).join('')}
                    </ol>
                </div>
                <div class="p-3 bg-purple-50 rounded-lg">
                    <p class="text-sm text-purple-800">
                        <i class="fas fa-clock mr-2"></i>
                        Tiempo estimado: ${tech.duration}
                    </p>
                </div>
            `;
            
            actionBtn.innerHTML = `<i class="fas fa-hourglass-start mr-2"></i> Comenzar Ejercicio`;
            actionBtn.onclick = () => {
                showNotification(`Iniciando ${tech.title}`, 'info');
                closeCrisisModal();
                
                // Start guided exercise
                startGuidedCBT(tech);
            };
            
            modal.classList.remove('hidden');
        }

        function startGuidedCBT(technique) {
            const steps = technique.steps;
            let currentStep = 0;
            
            function nextStep() {
                if (currentStep < steps.length) {
                    showNotification(`Paso ${currentStep + 1}/${steps.length}: ${steps[currentStep]}`, 'info');
                    currentStep++;
                    
                    if (currentStep < steps.length) {
                        setTimeout(nextStep, 60000); // 1 minute per step
                    }
                }
            }
            
            showNotification(`Iniciando ${technique.title} - ${technique.duration}`, 'success');
            nextStep();
        }

        function recordSleepQuality(quality) {
            appState.sleepQuality = {
                quality: quality,
                date: new Date().toISOString()
            };
            
            saveUserData('sleep', appState.sleepQuality);
            
            // Update UI
            document.querySelectorAll('.sleep-quality').forEach(btn => {
                btn.style.background = '';
            });
            
            const activeBtn = document.querySelector(`.sleep-quality[data-quality="${quality}"]`);
            if (activeBtn) {
                activeBtn.style.background = '#dbeafe';
            }
            
            showNotification(`Calidad de sue√±o registrada: ${quality}/5`, 'success');
            updateDashboard();
        }

        function playSleepSound(sound) {
            // In a real app, this would play actual sounds
            const soundNames = {
                rain: 'lluvia',
                waves: 'olas del mar',
                forest: 'bosque',
                white: 'ruido blanco'
            };
            
            showNotification(`Reproduciendo sonido de ${soundNames[sound]}...`, 'info');
            
            // Update active button
            document.querySelectorAll('.sleep-sound').forEach(btn => {
                btn.style.background = '';
            });
            
            const activeBtn = document.querySelector(`.sleep-sound[data-sound="${sound}"]`);
            if (activeBtn) {
                activeBtn.style.background = '#93c5fd';
            }
        }

        function startWimHofBreathing() {
            if (appState.breathingActive) return;
            
            appState.breathingActive = true;
            appState.breathCount = 0;
            appState.currentBreathTime = 0;
            
            const balloon = document.getElementById('breathing-balloon');
            const phaseText = document.getElementById('breath-phase');
            const timerText = document.getElementById('breath-timer');
            const instructionText = document.getElementById('breath-instruction');
            const cycleText = document.getElementById('breath-cycle');
            const voiceStatus = document.getElementById('current-instruction');
            
            balloon.classList.remove('inhaling', 'exhaling', 'holding');
            
            // Start voice guidance
            speakText("Vamos a comenzar la t√©cnica de respiraci√≥n Wim Hof. Prepara tu postura, si√©ntate c√≥modamente con la espalda recta.");
            
            setTimeout(() => {
                if (!appState.breathingActive) return;
                
                speakText("Haremos 30 respiraciones profundas. Inhala profundamente por la nariz, exhala suavemente por la boca.");
                voiceStatus.textContent = "Preparaci√≥n: Inhala por nariz, exhala por boca";
                
                setTimeout(() => breathingCycle(), 4000);
            }, 4000);

            function breathingCycle() {
                if (!appState.breathingActive) return;
                
                if (appState.breathCount < appState.maxBreaths) {
                    // Inhale phase - 4 seconds
                    phaseText.textContent = 'INHALA';
                    timerText.textContent = '4s';
                    instructionText.textContent = 'Inhala profundamente por la nariz';
                    voiceStatus.textContent = 'Inhala profundamente...';
                    balloon.classList.add('inhaling');
                    
                    speakText("Inhala profundamente");
                    
                    setTimeout(() => {
                        if (!appState.breathingActive) return;
                        
                        // Exhale phase - 7 seconds
                        phaseText.textContent = 'EXHALA';
                        timerText.textContent = '7s';
                        instructionText.textContent = 'Exhala suavemente por la boca';
                        voiceStatus.textContent = 'Exhala suavemente...';
                        balloon.classList.remove('inhaling');
                        balloon.classList.add('exhaling');
                        
                        speakText("Exhala suavemente");
                        
                        setTimeout(() => {
                            if (!appState.breathingActive) return;
                            
                            appState.breathCount++;
                            cycleText.textContent = appState.breathCount;
                            
                            balloon.classList.remove('exhaling');
                            
                            // Update voice status
                            if (appState.breathCount === 10) {
                                speakText("Muy bien, ya llevamos 10 respiraciones. Contin√∫a concentrado en tu respiraci√≥n.");
                                voiceStatus.textContent = "¬°Excelente! 10 respiraciones completadas";
                            } else if (appState.breathCount === 20) {
                                speakText("Perfecto, 20 respiraciones. Est√°s haciendo muy bien. Siente c√≥mo tu cuerpo se relaja.");
                                voiceStatus.textContent = "¬°Incre√≠ble! 20 respiraciones completadas";
                            }
                            
                            if (appState.breathCount < appState.maxBreaths) {
                                setTimeout(breathingCycle, 1000);
                            } else {
                                // Retention phase
                                startRetentionPhase();
                            }
                        }, 7000); // 7 seconds exhale
                    }, 4000); // 4 seconds inhale
                }
            }
            
            function startRetentionPhase() {
                phaseText.textContent = 'RETEN';
                timerText.textContent = '90s';
                instructionText.textContent = 'Ret√©n la respiraci√≥n y rel√°jate';
                voiceStatus.textContent = 'Ret√©n la respiraci√≥n...';
                balloon.classList.add('holding');
                
                speakText("Ahora ret√©n la respiraci√≥n. Relaja todo tu cuerpo. Suelta cualquier tensi√≥n. Escucha a tu cuerpo.");
                
                let retentionTime = 90;
                const retentionInterval = setInterval(() => {
                    if (!appState.breathingActive) {
                        clearInterval(retentionInterval);
                        return;
                    }
                    
                    retentionTime--;
                    timerText.textContent = `${retentionTime}s`;
                    
                    // Voice cues during retention
                    if (retentionTime === 60) {
                        speakText("Muy bien, ya pas√≥ medio minuto. Contin√∫a relajado.");
                        voiceStatus.textContent = "¬°Excelente! 30 segundos de retenci√≥n";
                    } else if (retentionTime === 30) {
                        speakText("Perfecto, solo 30 segundos m√°s. Est√°s haciendo fenomenal.");
                        voiceStatus.textContent = "¬°Fant√°stico! 60 segundos de retenci√≥n";
                    } else if (retentionTime === 15) {
                        speakText("Casi termina, prep√°rate para la respiraci√≥n final.");
                        voiceStatus.textContent = "Casi termina, prep√°rate";
                    }
                    
                    if (retentionTime <= 0) {
                        clearInterval(retentionInterval);
                        finalBreath();
                    }
                }, 1000);
            }
            
            function finalBreath() {
                phaseText.textContent = 'RESP. FINAL';
                timerText.textContent = '15s';
                instructionText.textContent = 'Toma una respiraci√≥n profunda y ret√©n';
                voiceStatus.textContent = 'Respiraci√≥n final...';
                balloon.classList.remove('holding');
                
                speakText("Ahora toma una respiraci√≥n profunda final. Llena completamente tus pulmones. Y ret√©n...");
                
                setTimeout(() => {
                    if (appState.breathingActive) {
                        speakText("Y exhala lentamente. Felicitaciones, has completado la t√©cnica de Wim Hof. Siente la calma en tu cuerpo.");
                        
                        phaseText.textContent = 'COMPLETADO';
                        timerText.textContent = 'üéâ';
                        instructionText.textContent = 'T√©cnica completada con √©xito';
                        voiceStatus.textContent = "¬°T√©cnica completada! Siente la calma";
                        appState.breathingActive = false;
                        
                        // Update wellness score
                        const wellnessScore = parseInt(document.getElementById('wellness-score').textContent);
                        document.getElementById('wellness-score').textContent = Math.min(100, wellnessScore + 5);
                        
                        showNotification('Ejercicio de respiraci√≥n completado. Bienestar +5', 'success');
                    }
                }, 15000);
            }
            
            showNotification('Iniciando m√©todo Wim Hof con gu√≠a de voz...', 'info');
        }

        function stopWimHofBreathing() {
            appState.breathingActive = false;
            
            // Stop any speech
            if (appState.currentVoiceUtterance) {
                window.speechSynthesis.cancel();
                appState.currentVoiceUtterance = null;
            }
            
            const balloon = document.getElementById('breathing-balloon');
            balloon.classList.remove('inhaling', 'exhaling', 'holding');
            
            document.getElementById('breath-phase').textContent = 'PAUSADO';
            document.getElementById('breath-timer').textContent = '--';
            document.getElementById('breath-instruction').textContent = '';
            document.getElementById('current-instruction').textContent = 'Ejercicio detenido';
            
            showNotification('Ejercicio de respiraci√≥n detenido', 'warning');
        }

        function resetBreathing() {
            appState.breathingActive = false;
            appState.breathCount = 0;
            
            // Stop any speech
            if (appState.currentVoiceUtterance) {
                window.speechSynthesis.cancel();
                appState.currentVoiceUtterance = null;
            }
            
            const balloon = document.getElementById('breathing-balloon');
            balloon.classList.remove('inhaling', 'exhaling', 'holding');
            
            document.getElementById('breath-phase').textContent = 'LISTO';
            document.getElementById('breath-timer').textContent = '--';
            document.getElementById('breath-instruction').textContent = '';
            document.getElementById('breath-cycle').textContent = '0';
            document.getElementById('current-instruction').textContent = 'Presiona "Comenzar" para iniciar';
            
            showNotification('Ejercicio de respiraci√≥n reiniciado', 'info');
        }

        function toggleVoice() {
            appState.voiceEnabled = !appState.voiceEnabled;
            const voiceBtn = document.getElementById('toggle-voice');
            
            if (appState.voiceEnabled) {
                voiceBtn.innerHTML = '<i class="fas fa-volume-up"></i><span>Desactivar Voz</span>';
                voiceBtn.classList.remove('bg-blue-100', 'text-blue-700');
                voiceBtn.classList.add('active');
                showNotification('Gu√≠a de voz activada', 'success');
                speakText("Gu√≠a de voz activada. Te acompa√±ar√© en los ejercicios.");
            } else {
                voiceBtn.innerHTML = '<i class="fas fa-volume-mute"></i><span>Activar Voz</span>';
                voiceBtn.classList.remove('active');
                voiceBtn.classList.add('bg-blue-100', 'text-blue-700');
                showNotification('Gu√≠a de voz desactivada', 'warning');
                
                // Stop any ongoing speech
                if (appState.currentVoiceUtterance) {
                    window.speechSynthesis.cancel();
                    appState.currentVoiceUtterance = null;
                }
            }
        }

        function testVoice() {
            speakText("Hola, soy tu gu√≠a de CalmApp. Te acompa√±ar√© en los ejercicios de respiraci√≥n y relajaci√≥n. Mi voz es suave y clara para ayudarte a concentrarte.");
            showNotification('Probando gu√≠a de voz...', 'info');
        }

        function startGroundingExercise() {
            const steps = document.querySelectorAll('.grounding-step');
            let currentStep = 0;
            
            // Reset all steps
            steps.forEach(step => {
                step.classList.remove('active');
            });
            
            function nextStep() {
                if (currentStep > 0) {
                    steps[currentStep - 1].classList.remove('active');
                }
                
                if (currentStep < steps.length) {
                    steps[currentStep].classList.add('active');
                    
                    // Show notification and voice guidance for each step
                    const stepText = steps[currentStep].querySelector('span').textContent;
                    showNotification(`Grounding: ${stepText}`, 'info');
                    
                    if (appState.voiceEnabled) {
                        speakText(stepText);
                    }
                    
                    currentStep++;
                    
                    if (currentStep <= steps.length) {
                        setTimeout(nextStep, 30000); // 30 seconds per step
                    } else {
                        if (appState.voiceEnabled) {
                            speakText("Excelente, has completado el ejercicio de grounding. Siente c√≥mo est√°s m√°s presente y conectado con el momento actual.");
                        }
                        showNotification('Ejercicio de Grounding completado', 'success');
                    }
                }
            }
            
            showNotification('Iniciando t√©cnica 5-4-3-2-1 para Grounding...', 'info');
            
            if (appState.voiceEnabled) {
                speakText("Vamos a comenzar el ejercicio de grounding 5-4-3-2-1. Este ejercicio te ayudar√° a conectar con el presente. T√≥mate tu tiempo en cada paso.");
                setTimeout(nextStep, 4000);
            } else {
                nextStep();
            }
        }

        function startBreathingExercise() {
            showNotification('Iniciando ejercicio de respiraci√≥n 4-7-8...', 'info');
            
            if (appState.voiceEnabled) {
                speakText("Vamos a practicar la respiraci√≥n 4-7-8. Es una t√©cnica excelente para calmar la ansiedad. Sigue mis instrucciones.");
            }
            
            // Simple 4-7-8 breathing
            let cycle = 0;
            const maxCycles = 4;
            
            function breathingCycle() {
                if (cycle < maxCycles) {
                    if (appState.voiceEnabled) {
                        speakText(`Ciclo ${cycle + 1} de ${maxCycles}. Inhala por 4 segundos...`);
                    }
                    showNotification(`Ciclo ${cycle + 1}/${maxCycles}: Inhala (4s)...`, 'info');
                    
                    setTimeout(() => {
                        if (appState.voiceEnabled) {
                            speakText("Ret√©n la respiraci√≥n por 7 segundos...");
                        }
                        showNotification(`Ciclo ${cycle + 1}/${maxCycles}: Ret√©n (7s)...`, 'info');
                        
                        setTimeout(() => {
                            if (appState.voiceEnabled) {
                                speakText("Exhala por 8 segundos...");
                            }
                            showNotification(`Ciclo ${cycle + 1}/${maxCycles}: Exhala (8s)...`, 'info');
                            
                            cycle++;
                            if (cycle < maxCycles) {
                                setTimeout(breathingCycle, 9000); // 8s exhale + 1s pause
                            } else {
                                if (appState.voiceEnabled) {
                                    speakText("¬°Perfecto! Has completado la respiraci√≥n 4-7-8. Siente la calma en tu cuerpo.");
                                }
                                showNotification('Ejercicio de respiraci√≥n completado', 'success');
                            }
                        }, 7000);
                    }, 4000);
                }
            }
            
            breathingCycle();
        }

        function saveGratitudeEntry() {
            const text = document.getElementById('gratitude-journal').value.trim();
            
            if (!text) {
                showNotification('Por favor escribe algo por lo que est√©s agradecido', 'warning');
                return;
            }
            
            const entry = {
                text: text,
                date: new Date().toISOString()
            };
            
            appState.gratitudeEntries.push(entry);
            saveUserData('gratitude', appState.gratitudeEntries);
            
            document.getElementById('gratitude-journal').value = '';
            
            // Update streak
            updateStreakDays();
            
            showNotification('Entrada de gratitud guardada', 'success');
            
            // Update wellness score
            const wellnessScore = parseInt(document.getElementById('wellness-score').textContent);
            document.getElementById('wellness-score').textContent = Math.min(100, wellnessScore + 3);
        }

        function startCompassionExercise(exercise) {
            const ex = compassionExercises[exercise];
            const modal = document.getElementById('crisis-modal');
            const title = document.getElementById('crisis-modal-title');
            const content = document.getElementById('crisis-modal-content');
            const actionBtn = document.getElementById('crisis-modal-action');
            
            title.textContent = ex.title;
            content.innerHTML = `
                <div class="p-4 bg-pink-50 rounded-lg">
                    <h4 class="font-bold text-pink-800 mb-3">Instrucciones:</h4>
                    <ol class="space-y-3">
                        ${ex.steps.map((step, i) => `
                            <li class="flex items-start">
                                <div class="w-6 h-6 rounded-full bg-pink-100 flex items-center justify-center mr-3 mt-1 flex-shrink-0">
                                    <span class="text-pink-600 font-bold">${i+1}</span>
                                </div>
                                <span class="text-pink-700">${step}</span>
                            </li>
                        `).join('')}
                    </ol>
                </div>
                <div class="p-3 bg-pink-50 rounded-lg">
                    <p class="text-sm text-pink-800">
                        <i class="fas fa-heart mr-2"></i>
                        T√≥mate tu tiempo con cada paso. La autocompasi√≥n es una pr√°ctica.
                    </p>
                </div>
            `;
            
            actionBtn.innerHTML = `<i class="fas fa-heart mr-2"></i> Comenzar Ejercicio`;
            actionBtn.onclick = () => {
                showNotification(`Iniciando ${ex.title}...`, 'info');
                closeCrisisModal();
                
                // Update wellness score
                const wellnessScore = parseInt(document.getElementById('wellness-score').textContent);
                document.getElementById('wellness-score').textContent = Math.min(100, wellnessScore + 2);
            };
            
            modal.classList.remove('hidden');
        }

        let currentPSSQuestion = 0;
        let pssAnswers = [];

        function startPSSAssessment() {
            currentPSSQuestion = 0;
            pssAnswers = new Array(pssQuestions.length).fill(null);
            
            const modal = document.getElementById('pss-modal');
            modal.classList.remove('hidden');
            
            showPSSQuestion(currentPSSQuestion);
        }

        function showPSSQuestion(index) {
            const question = pssQuestions[index];
            const container = document.getElementById('pss-questions');
            
            container.innerHTML = `
                <div class="p-6 bg-blue-50 rounded-xl">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm font-medium text-blue-600">Pregunta ${index + 1} de ${pssQuestions.length}</span>
                        <span class="text-sm font-medium text-blue-600">Estr√©s Percibido</span>
                    </div>
                    <h4 class="text-lg font-bold text-gray-800 mb-6">${question.question}</h4>
                    <div class="space-y-3">
                        <div class="flex items-center p-3 bg-white rounded-lg border cursor-pointer option ${pssAnswers[index] === 0 ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}" data-value="0">
                            <div class="w-6 h-6 rounded-full border flex items-center justify-center mr-3 ${pssAnswers[index] === 0 ? 'border-blue-500 bg-blue-500 text-white' : 'border-gray-300'}">
                                ${pssAnswers[index] === 0 ? '‚úì' : ''}
                            </div>
                            <span>Nunca</span>
                        </div>
                        <div class="flex items-center p-3 bg-white rounded-lg border cursor-pointer option ${pssAnswers[index] === 1 ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}" data-value="1">
                            <div class="w-6 h-6 rounded-full border flex items-center justify-center mr-3 ${pssAnswers[index] === 1 ? 'border-blue-500 bg-blue-500 text-white' : 'border-gray-300'}">
                                ${pssAnswers[index] === 1 ? '‚úì' : ''}
                            </div>
                            <span>Casi nunca</span>
                        </div>
                        <div class="flex items-center p-3 bg-white rounded-lg border cursor-pointer option ${pssAnswers[index] === 2 ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}" data-value="2">
                            <div class="w-6 h-6 rounded-full border flex items-center justify-center mr-3 ${pssAnswers[index] === 2 ? 'border-blue-500 bg-blue-500 text-white' : 'border-gray-300'}">
                                ${pssAnswers[index] === 2 ? '‚úì' : ''}
                            </div>
                            <span>De vez en cuando</span>
                        </div>
                        <div class="flex items-center p-3 bg-white rounded-lg border cursor-pointer option ${pssAnswers[index] === 3 ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}" data-value="3">
                            <div class="w-6 h-6 rounded-full border flex items-center justify-center mr-3 ${pssAnswers[index] === 3 ? 'border-blue-500 bg-blue-500 text-white' : 'border-gray-300'}">
                                ${pssAnswers[index] === 3 ? '‚úì' : ''}
                            </div>
                            <span>A menudo</span>
                        </div>
                        <div class="flex items-center p-3 bg-white rounded-lg border cursor-pointer option ${pssAnswers[index] === 4 ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}" data-value="4">
                            <div class="w-6 h-6 rounded-full border flex items-center justify-center mr-3 ${pssAnswers[index] === 4 ? 'border-blue-500 bg-blue-500 text-white' : 'border-gray-300'}">
                                ${pssAnswers[index] === 4 ? '‚úì' : ''}
                            </div>
                            <span>Muy a menudo</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners to options
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    const value = parseInt(this.getAttribute('data-value'));
                    pssAnswers[index] = value;
                    showPSSQuestion(index);
                });
            });
            
            // Update navigation buttons
            const prevBtn = document.getElementById('prev-pss-question');
            const nextBtn = document.getElementById('next-pss-question');
            
            prevBtn.classList.toggle('hidden', index === 0);
            
            if (index === pssQuestions.length - 1) {
                nextBtn.innerHTML = 'Finalizar <i class="fas fa-check ml-2"></i>';
            } else {
                nextBtn.innerHTML = 'Siguiente <i class="fas fa-arrow-right ml-2"></i>';
            }
        }

        function previousPSSQuestion() {
            if (currentPSSQuestion > 0) {
                currentPSSQuestion--;
                showPSSQuestion(currentPSSQuestion);
            }
        }

        function nextPSSQuestion() {
            if (pssAnswers[currentPSSQuestion] === null) {
                showNotification('Por favor selecciona una respuesta', 'warning');
                return;
            }
            
            if (currentPSSQuestion < pssQuestions.length - 1) {
                currentPSSQuestion++;
                showPSSQuestion(currentPSSQuestion);
            } else {
                calculatePSSScore();
            }
        }

        function calculatePSSScore() {
            let score = 0;
            
            pssQuestions.forEach((question, index) => {
                let answer = pssAnswers[index];
                
                if (question.reversed) {
                    // Reverse score: 0=4, 1=3, 2=2, 3=1, 4=0
                    answer = 4 - answer;
                }
                
                score += answer;
            });
            
            // Save score
            appState.pssScore = score;
            appState.lastPssDate = new Date().toISOString();
            
            saveUserData('pss', {
                score: score,
                date: appState.lastPssDate,
                answers: pssAnswers
            });
            
            // Show results
            const resultDiv = document.getElementById('pss-assessment-result');
            let interpretation = '';
            let color = '';
            
            if (score <= 13) {
                interpretation = 'Bajo estr√©s percibido';
                color = 'green';
            } else if (score <= 26) {
                interpretation = 'Estr√©s percibido moderado';
                color = 'yellow';
            } else {
                interpretation = 'Alto estr√©s percibido';
                color = 'red';
            }
            
            resultDiv.innerHTML = `
                <div class="p-4 bg-${color}-50 rounded-lg border-l-4 border-${color}-500">
                    <h4 class="font-bold text-${color}-800 mb-2">Resultado PSS-10: ${score} puntos</h4>
                    <p class="text-sm text-${color}-700 mb-2">${interpretation}</p>
                    <p class="text-xs text-gray-600">Fecha de evaluaci√≥n: ${new Date().toLocaleDateString('es-ES')}</p>
                    <div class="mt-3">
                        <div class="text-xs text-gray-600 mb-1">Rango de puntuaci√≥n:</div>
                        <div class="progress-bar">
                            <div class="progress-fill bg-${color}-500" style="width: ${(score/40)*100}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-600 mt-1">
                            <span>0 (Bajo)</span>
                            <span>40 (Alto)</span>
                        </div>
                    </div>
                </div>
            `;
            
            resultDiv.classList.remove('hidden');
            
            // Update dashboard
            document.querySelector('.bg-blue-50/70 .text-2xl').textContent = score;
            
            closePSSModal();
            showNotification(`Evaluaci√≥n PSS-10 completada. Puntaje: ${score}`, 'success');
            
            // Update patterns
            updatePatternsDetection();
        }

        function closePSSModal() {
            document.getElementById('pss-modal').classList.add('hidden');
        }

        function toggleHabit(habitId) {
            appState.habits[habitId] = !appState.habits[habitId];
            saveUserData('habits', appState.habits);
            
            updateHabitsDisplay();
            updateDashboard();
        }

        function updateHabitsDisplay() {
            Object.keys(appState.habits).forEach(habitId => {
                const checkbox = document.getElementById(`habit-${habitId}`);
                if (checkbox) {
                    checkbox.classList.toggle('checked', appState.habits[habitId]);
                    checkbox.innerHTML = appState.habits[habitId] ? '<i class="fas fa-check text-xs"></i>' : '';
                }
            });
            
            // Update progress
            const completed = Object.values(appState.habits).filter(v => v).length;
            const total = Object.keys(appState.habits).length;
            const progress = Math.round((completed / total) * 100);
            
            document.getElementById('habits-progress').textContent = `${progress}%`;
            document.getElementById('habits-progress-bar').style.width = `${progress}%`;
        }

        function updateStreakDays() {
            // Simple streak calculation based on recent activity
            let streak = 0;
            const today = new Date().toDateString();
            
            // Check mood entries from last 14 days
            for (let i = 0; i < 14; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                
                // Check if there's any activity on this date
                const hasActivity = appState.moodHistory.some(entry => 
                    new Date(entry.timestamp).toDateString() === dateStr
                ) || appState.gratitudeEntries.some(entry =>
                    new Date(entry.date).toDateString() === dateStr
                );
                
                if (hasActivity || i === 0) {
                    streak++;
                } else {
                    break;
                }
            }
            
            document.getElementById('streak-days').textContent = streak;
        }

        function updatePatternsDetection() {
            const container = document.getElementById('pattern-detection');
            
            if (appState.moodHistory.length < 3) {
                container.innerHTML = `
                    <div class="p-3 bg-blue-50/70 rounded-lg">
                        <p class="text-sm text-blue-700">Necesitas al menos 3 registros para detectar patrones.</p>
                    </div>
                `;
                return;
            }
            
            // Generate patterns based on data
            const patterns = [
                "Los lunes sueles reportar mayor estr√©s (-15% vs promedio)",
                "Despu√©s de registrar gratitud, tu √°nimo mejora 1.5 puntos en promedio",
                "Tu consistencia en el uso de CalmApp es del 87%",
                "El ejercicio de Wim Hof reduce tu ansiedad reportada en 40%",
                "Dormir 7+ horas mejora tu estado de √°nimo matutino en 2 puntos"
            ];
            
            container.innerHTML = patterns.map(pattern => `
                <div class="p-3 bg-white/70 rounded-lg border border-blue-100">
                    <div class="flex items-start">
                        <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center mr-3 mt-1 flex-shrink-0">
                            <i class="fas fa-chart-line text-blue-600 text-xs"></i>
                        </div>
                        <span class="text-sm text-gray-700">${pattern}</span>
                    </div>
                </div>
            `).join('');
            
            // Save patterns
            appState.patterns = patterns;
            saveUserData('patterns', patterns);
        }

        function saveTherapyPrepNotes() {
            const notes = document.getElementById('therapy-prep').value;
            appState.therapyPrepNotes = notes;
            saveUserData('therapy', notes);
            
            showNotification('Notas para terapia guardadas', 'success');
        }

        function updateDashboard() {
            // Update wellness score based on various factors
            let wellness = 50; // Base score
            
            // Mood history (last 7 days)
            const recentMoods = appState.moodHistory.filter(entry => {
                const entryDate = new Date(entry.timestamp);
                const daysDiff = (new Date() - entryDate) / (1000 * 60 * 60 * 24);
                return daysDiff <= 7;
            });
            
            if (recentMoods.length > 0) {
                const avgIntensity = recentMoods.reduce((sum, entry) => sum + entry.intensity, 0) / recentMoods.length;
                wellness += (avgIntensity - 5) * 2; // Adjust based on mood
            }
            
            // Habits
            const completedHabits = Object.values(appState.habits).filter(v => v).length;
            wellness += completedHabits * 5;
            
            // Sleep quality
            if (appState.sleepQuality) {
                wellness += appState.sleepQuality.quality * 3;
            }
            
            // Gratitude entries (last 7 days)
            const recentGratitude = appState.gratitudeEntries.filter(entry => {
                const entryDate = new Date(entry.date);
                const daysDiff = (new Date() - entryDate) / (1000 * 60 * 60 * 24);
                return daysDiff <= 7;
            }).length;
            
            wellness += recentGratitude * 2;
            
            // Cap between 0-100
            wellness = Math.max(0, Math.min(100, Math.round(wellness)));
            
            document.getElementById('wellness-score').textContent = wellness;
        }

        function showDailyTip() {
            const randomTip = dailyTips[Math.floor(Math.random() * dailyTips.length)];
            document.getElementById('daily-tip-content').textContent = randomTip;
        }

        function playClickSound() {
            // In a real app, this would play a sound
            // For now, just provide haptic feedback if available
            if (navigator.vibrate) {
                navigator.vibrate(10);
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in ${type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : type === 'warning' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' : type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' : 'bg-blue-100 text-blue-800 border border-blue-200'}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function preloadSounds() {
            // In a real app, preload audio files
            console.log('Preloading sounds...');
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
