<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalmDown - Bienestar Integral con IA</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Tone.js para sonidos y m√∫sica -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.9.14/build/Tone.min.js"></script>
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Configuraci√≥n de la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #fffbeb 50%, #fefce8 100%);
            min-height: 100vh;
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .mood-bar {
            height: 10px;
            border-radius: 9999px;
            transition: width 0.5s ease-out;
        }
        .audio-controls button {
            transition: all 0.2s ease;
        }
        .audio-controls button:active {
            transform: scale(0.95);
        }
        .technique-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .technique-card:hover {
            transform: translateY(-5px);
        }
        .active-technique {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        
        <!-- Header con m√°s funcionalidades -->
        <header class="text-center mb-10 bg-white p-8 rounded-3xl shadow-2xl card-shadow border-b-4 border-blue-500">
            <h1 class="text-6xl font-black text-blue-600 mb-2">‚ú® CalmDown üßò‚Äç‚ôÄÔ∏è</h1>
            <p class="text-xl font-medium text-emerald-500 mb-4">Tu espacio integral para la salud mental y el bienestar</p>
            
            <div class="flex flex-wrap justify-center gap-4 mt-6">
                <div class="flex items-center space-x-2 bg-blue-50 px-4 py-2 rounded-full">
                    <i class="fas fa-brain text-blue-500"></i>
                    <span class="text-sm font-medium text-blue-700" id="current-technique">Selecciona una t√©cnica</span>
                </div>
                
                <div class="flex items-center space-x-2 bg-emerald-50 px-4 py-2 rounded-full">
                    <i class="fas fa-music text-emerald-500"></i>
                    <span class="text-sm font-medium text-emerald-700" id="current-sound">Sonido: Desactivado</span>
                </div>
                
                <div id="user-info" class="text-sm text-gray-500 px-4 py-2 bg-gray-100 rounded-full">
                    <!-- ID de usuario se mostrar√° aqu√≠ -->
                </div>
            </div>
            
            <!-- Bot√≥n de inicio para audio -->
            <button id="start-audio-btn" class="mt-6 px-6 py-2 bg-gradient-to-r from-blue-400 to-purple-500 hover:from-blue-500 hover:to-purple-600 text-white font-bold rounded-full text-base transition duration-300 shadow-md">
                <i class="fas fa-play-circle mr-2"></i> Activar Audio y M√∫sica
            </button>
        </header>

        <!-- Contenedor Principal de la App -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Columna Izquierda: T√©cnicas de relajaci√≥n y m√∫sica -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Card: T√©cnicas de Relajaci√≥n -->
                <div class="bg-white p-6 rounded-3xl shadow-xl card-shadow border-b-4 border-indigo-500">
                    <h2 class="text-2xl font-extrabold text-indigo-600 mb-6 flex items-center">
                        <i class="fas fa-spa mr-3 text-indigo-500"></i>
                        T√©cnicas de Relajaci√≥n Guiadas üßò
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="technique-card p-4 bg-blue-50 rounded-2xl border-2 border-blue-200" data-technique="respiraci√≥n">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-wind text-blue-500"></i>
                                </div>
                                <h3 class="font-bold text-blue-700">Respiraci√≥n</h3>
                            </div>
                            <p class="text-sm text-gray-600">Ejercicios de respiraci√≥n controlada para calmar la ansiedad.</p>
                        </div>
                        
                        <div class="technique-card p-4 bg-purple-50 rounded-2xl border-2 border-purple-200" data-technique="meditaci√≥n">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-eye text-purple-500"></i>
                                </div>
                                <h3 class="font-bold text-purple-700">Meditaci√≥n</h3>
                            </div>
                            <p class="text-sm text-gray-600">Sesiones de meditaci√≥n guiada para enfocar la mente.</p>
                        </div>
                        
                        <div class="technique-card p-4 bg-emerald-50 rounded-2xl border-2 border-emerald-200" data-technique="relajaci√≥n">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-couch text-emerald-500"></i>
                                </div>
                                <h3 class="font-bold text-emerald-700">Relajaci√≥n</h3>
                            </div>
                            <p class="text-sm text-gray-600">Relajaci√≥n muscular progresiva y t√©cnicas de calma.</p>
                        </div>
                        
                        <div class="technique-card p-4 bg-amber-50 rounded-2xl border-2 border-amber-200" data-technique="visualizaci√≥n">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center mr-3">
                                    <i class="fas fa-mountain text-amber-500"></i>
                                </div>
                                <h3 class="font-bold text-amber-700">Visualizaci√≥n</h3>
                            </div>
                            <p class="text-sm text-gray-600">Visualizaci√≥n profunda para alcanzar estados de paz interior.</p>
                        </div>
                    </div>
                    
                    <!-- Controles de duraci√≥n -->
                    <div class="mb-6">
                        <h4 class="font-bold text-gray-700 mb-3">Duraci√≥n de la sesi√≥n:</h4>
                        <div class="flex flex-wrap gap-2">
                            <button class="duration-btn px-4 py-2 rounded-full bg-gray-100 hover:bg-blue-100 border border-gray-300" data-minutes="3">3 min</button>
                            <button class="duration-btn px-4 py-2 rounded-full bg-gray-100 hover:bg-blue-100 border border-gray-300" data-minutes="5">5 min</button>
                            <button class="duration-btn px-4 py-2 rounded-full bg-gray-100 hover:bg-blue-100 border border-gray-300" data-minutes="10">10 min</button>
                            <button class="duration-btn px-4 py-2 rounded-full bg-gray-100 hover:bg-blue-100 border border-gray-300" data-minutes="15">15 min</button>
                        </div>
                    </div>
                    
                    <button id="generate-exercise-btn" class="w-full py-4 px-4 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-black rounded-xl transition duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-200">
                        <i class="fas fa-play mr-2"></i> Iniciar Sesi√≥n Guiada
                    </button>
                    
                    <!-- Reproductor de audio -->
                    <div id="exercise-output" class="mt-6 p-5 bg-indigo-50 rounded-xl border border-indigo-300 hidden">
                        <h3 class="font-bold text-indigo-800 mb-4 flex items-center">
                            <i class="fas fa-headphones mr-2"></i> Tu Sesi√≥n de Relajaci√≥n
                        </h3>
                        
                        <div class="flex items-center justify-between mb-4 audio-controls">
                            <button id="play-btn" class="px-5 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-full">
                                <i class="fas fa-play"></i> Reproducir
                            </button>
                            <button id="pause-btn" class="px-5 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-full">
                                <i class="fas fa-pause"></i> Pausar
                            </button>
                            <button id="stop-btn" class="px-5 py-2 bg-red-500 hover:bg-red-600 text-white rounded-full">
                                <i class="fas fa-stop"></i> Detener
                            </button>
                        </div>
                        
                        <div class="flex items-center space-x-4 mb-4">
                            <span class="text-sm text-gray-600" id="current-time">0:00</span>
                            <div class="flex-grow bg-gray-200 rounded-full h-2">
                                <div id="progress-bar" class="bg-indigo-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <span class="text-sm text-gray-600" id="total-time">0:00</span>
                        </div>
                        
                        <p id="exercise-text" class="text-sm text-gray-700 whitespace-pre-wrap mt-4 p-4 bg-white rounded-lg border border-gray-200"></p>
                    </div>

                    <div id="loading-indicator" class="mt-4 text-center hidden">
                        <div class="flex flex-col items-center justify-center space-y-3 text-indigo-700">
                            <div class="pulse-animation">
                                <i class="fas fa-spinner fa-spin text-3xl"></i>
                            </div>
                            <span class="text-sm font-semibold">DeepSeek est√° preparando tu sesi√≥n personalizada...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Card: M√∫sica y Sonidos Ambientales -->
                <div class="bg-white p-6 rounded-3xl shadow-xl card-shadow border-b-4 border-teal-500">
                    <h2 class="text-2xl font-extrabold text-teal-600 mb-6 flex items-center">
                        <i class="fas fa-music mr-3 text-teal-500"></i>
                        M√∫sica y Sonidos para la Relajaci√≥n üéµ
                    </h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="sound-card p-4 bg-teal-50 rounded-2xl border-2 border-teal-200 text-center" data-sound="lluvia">
                            <i class="fas fa-cloud-rain text-2xl text-teal-500 mb-2"></i>
                            <p class="font-bold text-teal-700">Lluvia</p>
                        </div>
                        
                        <div class="sound-card p-4 bg-blue-50 rounded-2xl border-2 border-blue-200 text-center" data-sound="olas">
                            <i class="fas fa-water text-2xl text-blue-500 mb-2"></i>
                            <p class="font-bold text-blue-700">Olas</p>
                        </div>
                        
                        <div class="sound-card p-4 bg-green-50 rounded-2xl border-2 border-green-200 text-center" data-sound="bosque">
                            <i class="fas fa-tree text-2xl text-green-500 mb-2"></i>
                            <p class="font-bold text-green-700">Bosque</p>
                        </div>
                        
                        <div class="sound-card p-4 bg-purple-50 rounded-2xl border-2 border-purple-200 text-center" data-sound="cl√°sica">
                            <i class="fas fa-guitar text-2xl text-purple-500 mb-2"></i>
                            <p class="font-bold text-purple-700">Cl√°sica</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="font-bold text-gray-700 mb-1">Volumen:</p>
                            <input type="range" id="volume-control" min="0" max="100" value="50" class="w-48">
                        </div>
                        
                        <div class="text-right">
                            <p class="font-bold text-gray-700 mb-1">Sonido activo:</p>
                            <p id="active-sound-name" class="text-teal-600 font-medium">Ninguno</p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button id="play-sound-btn" class="flex-1 py-3 bg-teal-500 hover:bg-teal-600 text-white font-bold rounded-xl transition duration-300">
                            <i class="fas fa-play mr-2"></i> Reproducir Sonido
                        </button>
                        <button id="stop-sound-btn" class="flex-1 py-3 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-xl transition duration-300">
                            <i class="fas fa-stop mr-2"></i> Detener Sonido
                        </button>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Seguimiento y an√°lisis -->
            <div class="space-y-8">
                
                <!-- Card: Diario de √Ånimo -->
                <div class="bg-white p-6 rounded-3xl shadow-xl card-shadow border-b-4 border-orange-500">
                    <h2 class="text-2xl font-extrabold text-orange-600 mb-4 flex items-center">
                        <i class="fas fa-heart mr-3 text-orange-500"></i>
                        Diario de √Ånimo de Hoy üß°
                    </h2>
                    
                    <label for="mood-select" class="block text-sm font-semibold text-gray-700 mb-2">¬øC√≥mo te sientes hoy?</label>
                    <select id="mood-select" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-orange-400 focus:border-orange-400 mb-4 transition duration-150">
                        <option value="Excelente">ü•≥ Excelente (¬°Me siento genial!)</option>
                        <option value="Bien">üòä Bien (Todo en orden)</option>
                        <option value="Neutral">üòê Neutral (Normal, sin mucho que decir)</option>
                        <option value="Ansioso">üòü Ansioso (Un poco inquieto)</option>
                        <option value="Estresado">üòì Estresado (Mucha presi√≥n)</option>
                        <option value="Triste">üòî Triste (Necesito un abrazo)</option>
                        <option value="Irritable">üò† Irritable (Me siento frustrado)</option>
                    </select>

                    <label for="mood-notes" class="block text-sm font-semibold text-gray-700 mb-2">Notas del d√≠a (opcional):</label>
                    <textarea id="mood-notes" rows="3" placeholder="Ej: Hoy logr√© completar mi tarea dif√≠cil, me siento orgulloso..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-orange-400 focus:border-orange-400 transition duration-150"></textarea>

                    <button id="save-mood-btn" class="w-full py-3 mt-4 bg-orange-500 hover:bg-orange-600 text-white font-black rounded-xl transition duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-orange-200">
                        <i class="fas fa-save mr-2"></i> Guardar Registro
                    </button>
                    <p id="mood-status" class="text-sm text-center mt-2 font-bold"></p>
                </div>

                <!-- Card: Agente de Conversaci√≥n DeepSeek -->
                <div class="bg-white p-6 rounded-3xl shadow-xl card-shadow border-b-4 border-blue-500">
                    <h2 class="text-2xl font-extrabold text-blue-600 mb-4 flex items-center">
                        <i class="fas fa-robot mr-3 text-blue-500"></i>
                        Conversa con DeepSeek ü§ñ
                    </h2>
                    <p class="text-gray-600 mb-4">Habla con nuestro agente de IA sobre tus pensamientos, emociones o cualquier cosa que necesites.</p>
                    
                    <div class="mb-4">
                        <textarea id="ai-chat-input" rows="3" placeholder="¬øQu√© te gustar√≠a compartir o preguntar hoy?" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-400 focus:border-blue-400 transition duration-150"></textarea>
                    </div>
                    
                    <button id="chat-with-ai-btn" class="w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-black rounded-xl transition duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-200">
                        <i class="fas fa-comment mr-2"></i> Conversar con DeepSeek
                    </button>
                    
                    <div id="ai-chat-output" class="mt-4 p-5 bg-blue-50 rounded-xl border border-blue-300 hidden">
                        <h3 class="font-bold text-blue-800 mb-2">DeepSeek responde:</h3>
                        <p id="ai-chat-text" class="text-gray-700 whitespace-pre-wrap"></p>
                    </div>

                    <div id="chat-loading-indicator" class="mt-4 text-center hidden">
                        <div class="flex items-center justify-center space-x-2 text-blue-700">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span class="text-sm font-semibold">DeepSeek est√° pensando...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Card: Resumen de √Ånimo -->
                <div class="bg-white p-6 rounded-3xl shadow-xl card-shadow border-b-4 border-emerald-500">
                    <h2 class="text-2xl font-extrabold text-emerald-600 mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-3 text-emerald-500"></i>
                        Tu Progreso Emocional üìà
                    </h2>
                    <p class="text-sm text-gray-500 mb-4">Tendencias de tus estados de √°nimo recientes:</p>
                    <div id="mood-chart-container" class="space-y-4 p-2 bg-emerald-50 rounded-lg min-h-[200px] flex items-center justify-center">
                        <p class="text-gray-400 text-sm">Registra tu √°nimo para ver estad√≠sticas.</p>
                    </div>
                    
                    <button id="analyze-mood-btn" class="w-full py-3 mt-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-xl transition duration-300">
                        <i class="fas fa-chart-bar mr-2"></i> Ver An√°lisis Detallado
                    </button>
                </div>

                <!-- Card: Historial de Sesiones -->
                <div class="bg-white p-6 rounded-3xl shadow-xl card-shadow border-b-4 border-purple-500">
                    <h2 class="text-2xl font-extrabold text-purple-600 mb-4 flex items-center">
                        <i class="fas fa-history mr-3 text-purple-500"></i>
                        Tus Sesiones Recientes üïí
                    </h2>
                    <div id="session-history-list" class="space-y-3 max-h-60 overflow-y-auto">
                        <div class="p-3 bg-purple-50 rounded-lg">
                            <p class="font-bold text-purple-700">Nueva sesi√≥n</p>
                            <p class="text-xs text-gray-500">Comienza tu primera sesi√≥n de relajaci√≥n</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- M√≥dulos de Firebase y L√≥gica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setDoc, updateDoc, limit, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ----------------------------------------------------
        // 1. CONFIGURACI√ìN DE AUDIO (TONE.JS PARA M√öSICA Y SONIDOS)
        // ----------------------------------------------------
        let audioContextStarted = false;
        let currentSound = null;
        let currentVolume = 0.5;
        let currentAudioPlayer = null;
        let isPlaying = false;
        let currentDuration = 5; // minutos por defecto
        let currentTechnique = "respiraci√≥n";
        
        // Configuraci√≥n de sintetizadores para sonidos ambientales
        const soundGenerators = {
            'lluvia': null,
            'olas': null,
            'bosque': null,
            'cl√°sica': null
        };
        
        // Sonidos de feedback
        const successSynth = new Tone.MembraneSynth().toDestination();
        const loadingSynth = new Tone.DuoSynth({
            vibratoAmount: 0.5, vibratoRate: 5, harmonicity: 1.5,
            voice0: { volume: -10, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.5 } },
            voice1: { volume: -10, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.5 } }
        }).toDestination();
        
        function playSuccess() {
            if (audioContextStarted) {
                successSynth.triggerAttackRelease("G4", "8n");
                successSynth.triggerAttackRelease("C5", "8n", "+0.2");
            }
        }
        
        function playLoadingStart() {
            if (audioContextStarted) {
                loadingSynth.triggerAttackRelease("C3", "4n");
            }
        }

        function playError() {
            if (audioContextStarted) {
                successSynth.triggerAttackRelease("C2", "8n");
                successSynth.triggerAttackRelease("G#1", "8n", "+0.2");
            }
        }
        
        // Crear sonidos ambientales
        function createRainSound() {
            const noise = new Tone.Noise("pink").start();
            const filter = new Tone.Filter(800, "lowpass").toDestination();
            const volume = new Tone.Volume(-20).connect(filter);
            noise.connect(volume);
            return { noise, filter, volume };
        }
        
        function createWaveSound() {
            const osc = new Tone.Oscillator(60, "sine").start();
            const lfo = new Tone.LFO(0.1, 0.8, 1).start();
            const gain = new Tone.Gain().toDestination();
            const volume = new Tone.Volume(-15).connect(gain);
            
            osc.connect(volume);
            lfo.connect(gain.gain);
            
            return { osc, lfo, volume };
        }
        
        function createForestSound() {
            const noise = new Tone.Noise("brown").start();
            const filter = new Tone.Filter(1200, "lowpass").toDestination();
            const volume = new Tone.Volume(-25).connect(filter);
            noise.connect(volume);
            
            // Agregar algunos p√°jaros
            const birdInterval = setInterval(() => {
                if (audioContextStarted) {
                    const bird = new Tone.Oscillator(1200 + Math.random() * 800, "sine").start();
                    const env = new Tone.AmplitudeEnvelope({
                        attack: 0.01,
                        decay: 0.1,
                        sustain: 0.1,
                        release: 0.2
                    }).toDestination();
                    
                    bird.connect(env);
                    env.triggerAttackRelease(0.1 + Math.random() * 0.2);
                    
                    setTimeout(() => bird.dispose(), 500);
                }
            }, 3000);
            
            return { noise, filter, volume, interval: birdInterval };
        }
        
        function createClassicalMusic() {
            // Simulaci√≥n simple de m√∫sica cl√°sica relajante
            const synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: { attack: 0.1, decay: 0.2, sustain: 0.5, release: 1 }
            }).toDestination();
            
            const volume = new Tone.Volume(-10).connect(synth);
            
            // Patr√≥n simple y relajante
            const notes = ["C4", "E4", "G4", "C5", "G4", "E4", "C4"];
            let noteIndex = 0;
            
            const playNote = () => {
                if (audioContextStarted) {
                    synth.triggerAttackRelease(notes[noteIndex], "2n");
                    noteIndex = (noteIndex + 1) % notes.length;
                }
            };
            
            const interval = setInterval(playNote, 2000);
            
            return { synth, volume, interval };
        }
        
        function playAmbientSound(soundType) {
            stopAllSounds();
            
            if (!audioContextStarted) {
                document.getElementById('current-sound').textContent = "Activa el audio primero";
                return;
            }
            
            let soundGenerator;
            
            switch(soundType) {
                case 'lluvia':
                    soundGenerator = createRainSound();
                    break;
                case 'olas':
                    soundGenerator = createWaveSound();
                    break;
                case 'bosque':
                    soundGenerator = createForestSound();
                    break;
                case 'cl√°sica':
                    soundGenerator = createClassicalMusic();
                    break;
                default:
                    return;
            }
            
            soundGenerators[soundType] = soundGenerator;
            currentSound = soundType;
            
            // Ajustar volumen
            if (soundGenerator.volume) {
                soundGenerator.volume.volume.value = Tone.gainToDb(currentVolume);
            }
            
            document.getElementById('current-sound').textContent = `Sonido: ${soundType.charAt(0).toUpperCase() + soundType.slice(1)}`;
            document.getElementById('active-sound-name').textContent = soundType.charAt(0).toUpperCase() + soundType.slice(1);
            
            // Resaltar tarjeta activa
            document.querySelectorAll('.sound-card').forEach(card => {
                card.classList.remove('border-blue-500', 'bg-blue-100');
            });
            document.querySelector(`.sound-card[data-sound="${soundType}"]`).classList.add('border-blue-500', 'bg-blue-100');
            
            playSuccess();
        }
        
        function stopAllSounds() {
            Object.keys(soundGenerators).forEach(type => {
                if (soundGenerators[type]) {
                    // Detener intervalos
                    if (soundGenerators[type].interval) {
                        clearInterval(soundGenerators[type].interval);
                    }
                    
                    // Detener y desconectar generadores de sonido
                    if (soundGenerators[type].noise) {
                        soundGenerators[type].noise.stop();
                        soundGenerators[type].noise.dispose();
                    }
                    if (soundGenerators[type].osc) {
                        soundGenerators[type].osc.stop();
                        soundGenerators[type].osc.dispose();
                    }
                    if (soundGenerators[type].synth) {
                        soundGenerators[type].synth.dispose();
                    }
                    
                    soundGenerators[type] = null;
                }
            });
            
            if (currentSound) {
                document.querySelector(`.sound-card[data-sound="${currentSound}"]`).classList.remove('border-blue-500', 'bg-blue-100');
                currentSound = null;
            }
            
            document.getElementById('current-sound').textContent = "Sonido: Desactivado";
            document.getElementById('active-sound-name').textContent = "Ninguno";
        }
        
        function updateVolume(value) {
            currentVolume = value / 100;
            
            if (currentSound && soundGenerators[currentSound] && soundGenerators[currentSound].volume) {
                soundGenerators[currentSound].volume.volume.value = Tone.gainToDb(currentVolume);
            }
            
            if (currentAudioPlayer) {
                currentAudioPlayer.volume = currentVolume;
            }
        }

        document.getElementById('start-audio-btn').addEventListener('click', async () => {
            if (Tone.context.state !== 'running') {
                await Tone.start();
                audioContextStarted = true;
                document.getElementById('start-audio-btn').innerHTML = '<i class="fas fa-check-circle mr-2"></i> Audio Activado';
                document.getElementById('start-audio-btn').classList.remove('from-blue-400', 'to-purple-500');
                document.getElementById('start-audio-btn').classList.add('from-green-400', 'to-emerald-500');
                playSuccess();
            }
        });

        if (Tone.context.state !== 'running') {
            document.getElementById('start-audio-btn').classList.remove('hidden');
        } else {
            audioContextStarted = true;
            document.getElementById('start-audio-btn').innerHTML = '<i class="fas fa-check-circle mr-2"></i> Audio Activado';
            document.getElementById('start-audio-btn').classList.remove('from-blue-400', 'to-purple-500');
            document.getElementById('start-audio-btn').classList.add('from-green-400', 'to-emerald-500');
        }
        
        // ----------------------------------------------------
        // 2. CONFIGURACI√ìN DE FIRESTORE
        // ----------------------------------------------------
        const apiKey = ""; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'calmdown-app-v2';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-info').textContent = `Usuario: ${userId.substring(0, 8)}...`;
                    isAuthReady = true;
                    setupFirestoreListeners();
                } else {
                    document.getElementById('user-info').textContent = 'Conectando...';
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error de autenticaci√≥n:", error);
                        document.getElementById('user-info').textContent = 'Error de conexi√≥n';
                        playError();
                    }
                }
            });
        } else {
            document.getElementById('user-info').textContent = 'Modo demo (sin Firebase)';
            isAuthReady = true;
        }

        // ----------------------------------------------------
        // 3. FUNCIONES DE UTILIDAD
        // ----------------------------------------------------
        const MAX_RETRIES = 3;

        async function fetchWithRetry(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries + 1);
                }
                throw error;
            }
        }

        // ----------------------------------------------------
        // 4. GENERACI√ìN DE EJERCICIOS CON DEEPSEEK
        // ----------------------------------------------------
        async function generateExercise() {
            const btn = document.getElementById('generate-exercise-btn');
            const loading = document.getElementById('loading-indicator');
            const outputDiv = document.getElementById('exercise-output');
            const outputText = document.getElementById('exercise-text');

            if (!currentTechnique) {
                alert("Por favor, selecciona una t√©cnica de relajaci√≥n primero.");
                return;
            }

            btn.disabled = true;
            outputDiv.classList.add('hidden');
            loading.classList.remove('hidden');
            outputText.textContent = '';
            
            // Detener audio anterior
            if (currentAudioPlayer) {
                currentAudioPlayer.pause();
                currentAudioPlayer = null;
            }
            
            // Resetear controles de audio
            document.getElementById('current-time').textContent = "0:00";
            document.getElementById('progress-bar').style.width = "0%";
            isPlaying = false;
            
            playLoadingStart();

            // Mapear t√©cnicas a prompts espec√≠ficos
            const techniquePrompts = {
                "respiraci√≥n": `Genera un ejercicio de respiraci√≥n guiada de ${currentDuration} minutos para reducir la ansiedad y el estr√©s. Incluye instrucciones claras para inhalar, retener y exhalar. Usa un tono calmado y profesional.`,
                "meditaci√≥n": `Crea una meditaci√≥n guiada de ${currentDuration} minutos para enfocar la mente y alcanzar un estado de paz interior. Incluye instrucciones para enfocar la atenci√≥n en la respiraci√≥n o en sensaciones corporales.`,
                "relajaci√≥n": `Dise√±a una sesi√≥n de relajaci√≥n muscular progresiva de ${currentDuration} minutos. Gu√≠a al usuario a trav√©s de diferentes grupos musculares, tensando y relajando cada uno. Usa un ritmo pausado.`,
                "visualizaci√≥n": `Genera una visualizaci√≥n guiada de ${currentDuration} minutos para transportar al usuario a un lugar tranquilo y seguro. Describe detalles sensoriales (vista, sonidos, olores, sensaciones).`
            };

            const systemPrompt = `Eres un terapeuta de bienestar especializado en t√©cnicas de relajaci√≥n y mindfulness. Tu tarea es generar ejercicios guiados que sean efectivos, seguros y f√°ciles de seguir.`;
            
            const userPrompt = techniquePrompts[currentTechnique] || `Genera un ejercicio de relajaci√≥n de ${currentDuration} minutos.`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            try {
                // 1. Generar el texto del ejercicio
                const textResponse = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1000
                        }
                    })
                });
                
                const textResult = await textResponse.json();
                const text = textResult.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) {
                    throw new Error("No se pudo generar el texto del ejercicio.");
                }
                
                // 2. Convertir texto a audio usando Web Speech API (fallback)
                outputText.textContent = text;
                outputDiv.classList.remove('hidden');
                
                // Configurar controles de audio
                setupAudioControls(text);
                
                // 3. Guardar sesi√≥n en historial
                saveSessionToHistory(currentTechnique, currentDuration);
                
                playSuccess();

            } catch (error) {
                console.error("Error en la generaci√≥n de IA:", error);
                outputText.textContent = `Error al generar la gu√≠a. Detalles: ${error.message}. Intenta de nuevo.`;
                outputDiv.classList.remove('hidden');
                playError();
            } finally {
                btn.disabled = false;
                loading.classList.add('hidden');
            }
        }
        
        function setupAudioControls(text) {
            // Usar Web Speech API como fallback
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = currentVolume;
                
                currentAudioPlayer = {
                    utterance: utterance,
                    startTime: null,
                    duration: currentDuration * 60 * 1000, // convertir a ms
                    play: function() {
                        window.speechSynthesis.speak(this.utterance);
                        this.startTime = Date.now();
                        isPlaying = true;
                        updateProgressBar();
                    },
                    pause: function() {
                        window.speechSynthesis.pause();
                        isPlaying = false;
                    },
                    resume: function() {
                        window.speechSynthesis.resume();
                        isPlaying = true;
                        updateProgressBar();
                    },
                    stop: function() {
                        window.speechSynthesis.cancel();
                        isPlaying = false;
                        document.getElementById('current-time').textContent = "0:00";
                        document.getElementById('progress-bar').style.width = "0%";
                    }
                };
                
                // Configurar eventos de los botones
                document.getElementById('play-btn').onclick = () => {
                    if (!isPlaying) {
                        if (window.speechSynthesis.speaking && window.speechSynthesis.paused) {
                            currentAudioPlayer.resume();
                        } else {
                            currentAudioPlayer.play();
                        }
                    }
                };
                
                document.getElementById('pause-btn').onclick = () => {
                    if (isPlaying) {
                        currentAudioPlayer.pause();
                    }
                };
                
                document.getElementById('stop-btn').onclick = () => {
                    currentAudioPlayer.stop();
                };
                
                // Configurar tiempo total
                document.getElementById('total-time').textContent = `${currentDuration}:00`;
                
                // Actualizar barra de progreso
                function updateProgressBar() {
                    if (isPlaying && currentAudioPlayer.startTime) {
                        const elapsed = Date.now() - currentAudioPlayer.startTime;
                        const progress = Math.min(elapsed / currentAudioPlayer.duration, 1);
                        
                        const minutes = Math.floor(elapsed / 60000);
                        const seconds = Math.floor((elapsed % 60000) / 1000);
                        document.getElementById('current-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        
                        document.getElementById('progress-bar').style.width = `${progress * 100}%`;
                        
                        if (progress < 1) {
                            requestAnimationFrame(updateProgressBar);
                        } else {
                            isPlaying = false;
                        }
                    }
                }
            } else {
                document.getElementById('exercise-text').innerHTML += `<br><br><span class="text-red-500 text-sm">Nota: Tu navegador no soporta s√≠ntesis de voz. Lee el texto en voz alta o usa auriculares.</span>`;
            }
        }
        
        // ----------------------------------------------------
        // 5. AGENTE DE CONVERSACI√ìN DEEPSEEK
        // ----------------------------------------------------
        async function chatWithAI() {
            const input = document.getElementById('ai-chat-input').value.trim();
            const btn = document.getElementById('chat-with-ai-btn');
            const loading = document.getElementById('chat-loading-indicator');
            const outputDiv = document.getElementById('ai-chat-output');
            const outputText = document.getElementById('ai-chat-text');

            if (!input) {
                alert("Por favor, escribe algo para conversar con DeepSeek.");
                return;
            }

            btn.disabled = true;
            outputDiv.classList.add('hidden');
            loading.classList.remove('hidden');
            outputText.textContent = '';
            
            playLoadingStart();

            const systemPrompt = `Eres DeepSeek, un asistente de IA especializado en salud mental y bienestar emocional. Eres emp√°tico, comprensivo y ofreces apoyo emocional sin juzgar. Tu objetivo es ayudar a las personas a procesar sus emociones, encontrar claridad y desarrollar estrategias de autocuidado. Siempre respondes en espa√±ol.`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: input }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: {
                            temperature: 0.8,
                            maxOutputTokens: 800
                        }
                    })
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, no pude procesar tu mensaje. ¬øPodr√≠as intentarlo de nuevo?";

                outputText.textContent = text;
                outputDiv.classList.remove('hidden');
                playSuccess();
                
                // Limpiar input
                document.getElementById('ai-chat-input').value = '';
                
                // Guardar conversaci√≥n en historial
                saveConversationToHistory(input, text);

            } catch (error) {
                console.error("Error en el chat con IA:", error);
                outputText.textContent = "Error al conectar con DeepSeek. Por favor, intenta de nuevo m√°s tarde.";
                outputDiv.classList.remove('hidden');
                playError();
            } finally {
                btn.disabled = false;
                loading.classList.add('hidden');
            }
        }

        // ----------------------------------------------------
        // 6. FIRESTORE FUNCTIONS
        // ----------------------------------------------------
        function getMoodCollectionRef() {
            if (!userId) return null;
            const collectionPath = `artifacts/${appId}/users/${userId}/mood_entries`;
            return collection(db, collectionPath);
        }

        function getSessionsCollectionRef() {
            if (!userId) return null;
            const collectionPath = `artifacts/${appId}/users/${userId}/sessions`;
            return collection(db, collectionPath);
        }

        function getConversationsCollectionRef() {
            if (!userId) return null;
            const collectionPath = `artifacts/${appId}/users/${userId}/conversations`;
            return collection(db, collectionPath);
        }

        async function saveMoodEntry() {
            const moodRef = getMoodCollectionRef();
            const statusText = document.getElementById('mood-status');

            if (!moodRef) {
                statusText.textContent = 'Error: No se puede guardar sin sesi√≥n activa.';
                statusText.classList.remove('text-emerald-500');
                statusText.classList.add('text-red-500');
                playError();
                return;
            }

            const mood = document.getElementById('mood-select').value;
            const notes = document.getElementById('mood-notes').value;

            try {
                await addDoc(moodRef, {
                    mood: mood,
                    notes: notes,
                    timestamp: serverTimestamp(),
                    technique: currentTechnique
                });
                statusText.textContent = '¬°√Ånimo guardado exitosamente! ‚úÖ';
                statusText.classList.remove('text-red-500');
                statusText.classList.add('text-emerald-500');
                document.getElementById('mood-notes').value = '';
                playSuccess();
                setTimeout(() => statusText.textContent = '', 3000);
            } catch (e) {
                console.error("Error al guardar estado de √°nimo: ", e);
                statusText.textContent = 'Error al guardar.';
                statusText.classList.add('text-red-500');
                playError();
            }
        }

        async function saveSessionToHistory(technique, duration) {
            const sessionsRef = getSessionsCollectionRef();
            if (!sessionsRef) return;

            try {
                await addDoc(sessionsRef, {
                    technique: technique,
                    duration: duration,
                    timestamp: serverTimestamp(),
                    date: new Date().toISOString().split('T')[0]
                });
            } catch (e) {
                console.error("Error al guardar sesi√≥n: ", e);
            }
        }

        async function saveConversationToHistory(userInput, aiResponse) {
            const convRef = getConversationsCollectionRef();
            if (!convRef) return;

            try {
                await addDoc(convRef, {
                    userInput: userInput,
                    aiResponse: aiResponse,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Error al guardar conversaci√≥n: ", e);
            }
        }

        // 7. FUNCIONES DE RENDERIZADO
        const moodColors = {
            'Excelente': 'bg-lime-500', 'Bien': 'bg-green-500', 'Neutral': 'bg-gray-400',
            'Ansioso': 'bg-yellow-400', 'Estresado': 'bg-orange-500', 'Triste': 'bg-sky-500',
            'Irritable': 'bg-red-500',
        };
        
        const moodEmojis = {
            'Excelente': 'ü•≥', 'Bien': 'üòä', 'Neutral': 'üòê', 'Ansioso': 'üòü',
            'Estresado': 'üòì', 'Triste': 'üòî', 'Irritable': 'üò†',
        };

        function renderMoodChart(moodCounts) {
            const container = document.getElementById('mood-chart-container');
            container.innerHTML = '';
            
            const total = Object.values(moodCounts).reduce((sum, count) => sum + count, 0);

            if (total === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm p-2">Registra tu √°nimo para ver estad√≠sticas.</p>';
                return;
            }

            const sortedMoods = Object.entries(moodCounts)
                .sort(([, a], [, b]) => b - a)
                .filter(([, count]) => count > 0);
            
            sortedMoods.forEach(([mood, count]) => {
                const percentage = (count / total) * 100;
                const colorClass = moodColors[mood] || 'bg-gray-400';
                const emoji = moodEmojis[mood] || '‚ùì';
                
                const item = document.createElement('div');
                item.className = 'flex items-center space-x-2';
                item.innerHTML = `
                    <span class="text-sm font-semibold w-1/4">${emoji} ${mood}</span>
                    <div class="flex-grow bg-gray-200 rounded-full">
                        <div class="mood-bar ${colorClass}" style="width: ${percentage.toFixed(1)}%;"></div>
                    </div>
                    <span class="text-xs text-gray-600">${count}</span>
                `;
                container.appendChild(item);
            });
        }

        function setupFirestoreListeners() {
            if (!isAuthReady || !userId) return;

            const moodRef = getMoodCollectionRef();
            const sessionsRef = getSessionsCollectionRef();
            const historyList = document.getElementById('session-history-list');

            // Listener para el Historial de √Ånimo
            const qMood = query(moodRef, orderBy("timestamp", "desc"), limit(10));
            onSnapshot(qMood, (snapshot) => {
                const moodCounts = {};
                
                snapshot.docs.forEach(doc => { 
                    const data = doc.data();
                    moodCounts[data.mood] = (moodCounts[data.mood] || 0) + 1;
                });
                
                renderMoodChart(moodCounts);
            });

            // Listener para Historial de Sesiones
            const qSessions = query(sessionsRef, orderBy("timestamp", "desc"), limit(5));
            onSnapshot(qSessions, (snapshot) => {
                historyList.innerHTML = '';
                
                if (snapshot.empty) {
                    historyList.innerHTML = '<p class="text-gray-500 p-2">A√∫n no has completado sesiones.</p>';
                    return;
                }

                snapshot.docs.forEach(doc => { 
                    const data = doc.data();
                    const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'Hoy';
                    
                    const sessionItem = document.createElement('div');
                    sessionItem.className = 'p-3 bg-purple-50 rounded-lg hover:bg-purple-100 transition duration-150';
                    
                    const techniqueNames = {
                        "respiraci√≥n": "Respiraci√≥n",
                        "meditaci√≥n": "Meditaci√≥n",
                        "relajaci√≥n": "Relajaci√≥n",
                        "visualizaci√≥n": "Visualizaci√≥n"
                    };
                    
                    sessionItem.innerHTML = `
                        <p class="font-bold text-purple-700">${techniqueNames[data.technique] || data.technique}</p>
                        <p class="text-xs text-gray-500">${data.duration} min ‚Ä¢ ${date}</p>
                    `;
                    historyList.appendChild(sessionItem);
                });
            });
        }

        // ----------------------------------------------------
        // 8. ASIGNACI√ìN DE EVENTOS
        // ----------------------------------------------------
        document.getElementById('generate-exercise-btn').addEventListener('click', generateExercise);
        document.getElementById('save-mood-btn').addEventListener('click', saveMoodEntry);
        document.getElementById('chat-with-ai-btn').addEventListener('click', chatWithAI);
        document.getElementById('play-sound-btn').addEventListener('click', () => {
            if (currentSound) {
                playAmbientSound(currentSound);
            } else {
                alert("Selecciona un sonido primero");
            }
        });
        document.getElementById('stop-sound-btn').addEventListener('click', stopAllSounds);
        document.getElementById('volume-control').addEventListener('input', (e) => {
            updateVolume(e.target.value);
        });
        document.getElementById('analyze-mood-btn').addEventListener('click', () => {
            alert("Funci√≥n de an√°lisis detallado en desarrollo. Pr√≥ximamente!");
        });

        // Selecci√≥n de t√©cnicas
        document.querySelectorAll('.technique-card').forEach(card => {
            card.addEventListener('click', () => {
                // Remover selecci√≥n anterior
                document.querySelectorAll('.technique-card').forEach(c => {
                    c.classList.remove('active-technique', 'border-blue-500', 'bg-blue-100');
                });
                
                // Marcar como activa
                card.classList.add('active-technique', 'border-blue-500', 'bg-blue-100');
                
                // Actualizar t√©cnica actual
                currentTechnique = card.getAttribute('data-technique');
                document.getElementById('current-technique').textContent = 
                    `T√©cnica: ${currentTechnique.charAt(0).toUpperCase() + currentTechnique.slice(1)}`;
                
                playSuccess();
            });
        });

        // Selecci√≥n de duraci√≥n
        document.querySelectorAll('.duration-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remover selecci√≥n anterior
                document.querySelectorAll('.duration-btn').forEach(b => {
                    b.classList.remove('bg-blue-500', 'text-white');
                    b.classList.add('bg-gray-100', 'text-gray-700');
                });
                
                // Marcar como activa
                btn.classList.remove('bg-gray-100', 'text-gray-700');
                btn.classList.add('bg-blue-500', 'text-white');
                
                // Actualizar duraci√≥n
                currentDuration = parseInt(btn.getAttribute('data-minutes'));
                
                playSuccess();
            });
        });

        // Selecci√≥n de sonidos
        document.querySelectorAll('.sound-card').forEach(card => {
            card.addEventListener('click', () => {
                const soundType = card.getAttribute('data-sound');
                currentSound = soundType;
                
                // Resaltar selecci√≥n
                document.querySelectorAll('.sound-card').forEach(c => {
                    c.classList.remove('border-blue-500', 'bg-blue-100');
                });
                card.classList.add('border-blue-500', 'bg-blue-100');
                
                document.getElementById('active-sound-name').textContent = 
                    soundType.charAt(0).toUpperCase() + soundType.slice(1);
                
                playSuccess();
            });
        });

        // Seleccionar t√©cnica por defecto
        document.querySelector('.technique-card[data-technique="respiraci√≥n"]').click();
        document.querySelector('.duration-btn[data-minutes="5"]').click();

    </script>
</body>
</html>
