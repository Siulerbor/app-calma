<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalmApp - Bienestar Emocional</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4c7c7c;
            --secondary: #6ee7b7;
            --accent: #a5b4fc;
            --danger: #fda4af;
            --warning: #fcd34d;
            --success: #34d399;
            --background: #E8F4F8;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--background) 0%, #F0F9FF 100%);
            min-height: 100vh;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(76, 124, 124, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.9);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(76, 124, 124, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #5a8f8f 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 124, 124, 0.25);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #10b981 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #fbbf24 100%);
            color: #78350f;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #f87171 100%);
            color: white;
        }
        
        .mood-bar {
            height: 8px;
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sound-btn {
            transition: all 0.3s ease;
        }
        
        .sound-btn.active {
            background: var(--primary) !important;
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(76, 124, 124, 0.2);
        }
        
        .calendar-day {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
        }
        
        .calendar-day:hover {
            background: rgba(76, 124, 124, 0.1);
        }
        
        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }
        
        .calendar-day.has-entry {
            border: 2px solid var(--secondary);
        }
        
        .meditation-guide-text {
            font-size: 1.1rem;
            line-height: 1.6;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 15px;
            border-left: 4px solid var(--primary);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .ai-response {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: linear-gradient(135deg, #f0fdf4 0%, #f7fee7 100%);
            border-radius: 15px;
            border-left: 4px solid #10b981;
        }
        
        .ai-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
        }
        
        .user-message {
            background: rgba(76, 124, 124, 0.1);
            margin-left: 20px;
            border-left: 3px solid var(--primary);
        }
        
        .bot-message {
            background: rgba(16, 185, 129, 0.1);
            margin-right: 20px;
            border-left: 3px solid #10b981;
        }
        
        .meditation-step {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            border-left: 4px solid var(--secondary);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .step-active {
            background: linear-gradient(135deg, rgba(110, 231, 183, 0.2) 0%, rgba(76, 124, 124, 0.2) 100%);
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .click-sound {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .click-sound:active {
            transform: scale(0.95);
        }
        
        /* Breathing Balloon Styles */
        .breathing-balloon-container {
            width: 300px;
            height: 300px;
            margin: 0 auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .breathing-balloon {
            width: 150px;
            height: 200px;
            background: linear-gradient(135deg, #4c7c7c, #6ee7b7);
            border-radius: 50%;
            position: relative;
            transition: all 4s ease-in-out;
            box-shadow: 
                0 10px 30px rgba(76, 124, 124, 0.3),
                inset 0 -10px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .balloon-string {
            position: absolute;
            bottom: -40px;
            width: 2px;
            height: 40px;
            background: #666;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .balloon-knot {
            position: absolute;
            bottom: -40px;
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .breathing-balloon.inhaling {
            animation: inflate 4s ease-in-out forwards;
        }
        
        .breathing-balloon.exhaling {
            animation: deflate 4s ease-in-out forwards;
        }
        
        .breathing-balloon.holding {
            animation: pulse-hold 2s ease-in-out infinite;
        }
        
        @keyframes inflate {
            0% { 
                transform: scale(1); 
                width: 150px;
                height: 200px;
            }
            100% { 
                transform: scale(1.3); 
                width: 195px;
                height: 260px;
            }
        }
        
        @keyframes deflate {
            0% { 
                transform: scale(1.3); 
                width: 195px;
                height: 260px;
            }
            100% { 
                transform: scale(1); 
                width: 150px;
                height: 200px;
            }
        }
        
        @keyframes pulse-hold {
            0%, 100% { transform: scale(1.25); }
            50% { transform: scale(1.28); }
        }
        
        .breathing-info {
            position: absolute;
            bottom: -80px;
            left: 0;
            right: 0;
            text-align: center;
            color: var(--primary);
            font-weight: bold;
        }
        
        /* Digital Detox Styles */
        .detox-checkbox {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
            border: 1px solid #e5e7eb;
        }
        
        .detox-checkbox:hover {
            background: rgba(240, 253, 244, 0.8);
            border-color: var(--secondary);
        }
        
        .detox-checkbox input[type="checkbox"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
        }
        
        .detox-checkbox label {
            flex-grow: 1;
            cursor: pointer;
        }
        
        .detox-checkbox.completed {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }
        
        .ai-analysis-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #3b82f6;
        }
        
        .daily-tip {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #f59e0b;
        }
        
        .daily-tip h3 {
            color: #92400e;
            margin-bottom: 10px;
        }
        
        .daily-tip p {
            color: #78350f;
        }
        
        /* Meditation Timer Styles */
        .meditation-timer {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            border: 2px solid var(--secondary);
        }
        
        .guide-instruction {
            font-style: italic;
            color: #555;
            padding: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            margin: 5px 0;
            border-left: 3px solid var(--accent);
        }
    </style>
</head>
<body>
    <!-- Main App Container -->
    <div id="app-container" class="min-h-screen p-4 md:p-8">
        <div id="app" class="max-w-6xl mx-auto">
            
            <!-- Header -->
            <header class="text-center mb-10">
                <div class="card glass-effect p-8 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full bg-[var(--primary)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-heart text-[var(--primary)] text-xl"></i>
                            </div>
                            <div class="text-left">
                                <!-- Texto eliminado como solicitaste -->
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                                <i class="fas fa-brain text-[var(--primary)] mr-2"></i>
                                <span class="text-sm font-medium">Bienestar: <span id="wellness-score">85</span>/100</span>
                            </div>
                        </div>
                    </div>
                    
                    <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] mb-4">
                        CalmApp üåø
                    </h1>
                    <p class="text-lg md:text-xl text-gray-700 mb-2">Tu espacio para la calma y el bienestar emocional</p>
                    <p class="text-sm text-gray-600">Cuidando tu mente, un momento a la vez</p>
                </div>
                
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                        <i class="fas fa-calendar-alt text-[var(--primary)] mr-2"></i>
                        <span id="current-date" class="text-sm font-medium"></span>
                    </div>
                    <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                        <i class="fas fa-heart text-[var(--primary)] mr-2"></i>
                        <span class="text-sm font-medium">Sesi√≥n: <span id="session-time">00:00</span></span>
                    </div>
                    <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                        <i class="fas fa-user text-[var(--primary)] mr-2"></i>
                        <span class="text-sm font-medium">Modo Universal</span>
                    </div>
                </div>
            </header>

            <!-- Main App Container -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Wellness Tools -->
                <div class="space-y-6">
                    
                    <!-- Card 1: Registro de √Ånimo Diario -->
                    <div class="card p-6 border-t-4 border-[var(--accent)]">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-[var(--accent)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-heart text-[var(--accent)]"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Registro de √Ånimo Diario üíú</h2>
                        </div>
                        
                        <div class="mb-6">
                            <p class="text-gray-700 mb-3">¬øC√≥mo te sientes en este momento?</p>
                            
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="excelente">
                                    <span class="text-2xl mb-2">ü•≥</span>
                                    <span class="font-medium">Excelente</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="bien">
                                    <span class="text-2xl mb-2">üòä</span>
                                    <span class="font-medium">Bien</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="neutral">
                                    <span class="text-2xl mb-2">üòê</span>
                                    <span class="font-medium">Neutral</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="ansioso">
                                    <span class="text-2xl mb-2">üòü</span>
                                    <span class="font-medium">Ansioso</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="estresado">
                                    <span class="text-2xl mb-2">üòì</span>
                                    <span class="font-medium">Estresado</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="triste">
                                    <span class="text-2xl mb-2">üòî</span>
                                    <span class="font-medium">Triste</span>
                                </button>
                            </div>
                            
                            <div class="mb-4">
                                <label for="mood-intensity" class="block text-sm font-medium text-gray-700 mb-2">
                                    Intensidad: <span id="intensity-value">5</span>/10
                                </label>
                                <input type="range" id="mood-intensity" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            
                            <div class="mb-4">
                                <label for="mood-notes" class="block text-sm font-medium text-gray-700 mb-2">
                                    Notas (opcional):
                                </label>
                                <textarea id="mood-notes" rows="3" placeholder="¬øQu√© est√° influyendo en tu estado de √°nimo hoy? Ej: Buen d√≠a de trabajo, dorm√≠ bien, discusi√≥n con amigo..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"></textarea>
                            </div>
                            
                            <button id="save-mood-btn" class="btn-success w-full py-3 click-sound">
                                <i class="far fa-save mr-2"></i>
                                Guardar Registro Emocional
                            </button>
                            
                            <div id="mood-status" class="mt-3 text-center text-sm font-medium"></div>
                        </div>
                    </div>
                    
                    <!-- Card 2: Meditaci√≥n Guiada Completa -->
                    <div class="card p-6 border-t-4 border-[var(--secondary)]">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-[var(--secondary)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-headphones-alt text-[var(--secondary)]"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Meditaci√≥n Guiada üéß</h2>
                        </div>
                        
                        <p class="text-gray-700 mb-6">Selecciona el tipo de meditaci√≥n que necesitas hoy:</p>
                        
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <button class="meditation-option p-3 rounded-xl border border-gray-200 hover:border-[var(--secondary)] transition click-sound" data-theme="respiraci√≥n">
                                <i class="fas fa-wind text-[var(--primary)] mr-2"></i>
                                <span class="font-medium">Respiraci√≥n</span>
                            </button>
                            <button class="meditation-option p-3 rounded-xl border border-gray-200 hover:border-[var(--secondary)] transition click-sound" data-theme="relajaci√≥n">
                                <i class="fas fa-spa text-[var(--primary)] mr-2"></i>
                                <span class="font-medium">Relajaci√≥n</span>
                            </button>
                            <button class="meditation-option p-3 rounded-xl border border-gray-200 hover:border-[var(--secondary)] transition click-sound" data-theme="concentraci√≥n">
                                <i class="fas fa-bullseye text-[var(--primary)] mr-2"></i>
                                <span class="font-medium">Concentraci√≥n</span>
                            </button>
                            <button class="meditation-option p-3 rounded-xl border border-gray-200 hover:border-[var(--secondary)] transition click-sound" data-theme="ansiedad">
                                <i class="fas fa-heart text-[var(--primary)] mr-2"></i>
                                <span class="font-medium">Ansiedad</span>
                            </button>
                        </div>
                        
                        <button id="generate-meditation-btn" class="btn-primary w-full py-3 mb-4 click-sound">
                            <i class="fas fa-magic mr-2"></i>
                            Generar Meditaci√≥n Personalizada
                        </button>
                        
                        <div id="meditation-output" class="mt-6 p-4 bg-gradient-to-r from-green-50/80 to-blue-50/80 rounded-xl border border-green-200 hidden fade-in">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800" id="meditation-title"></h3>
                                <div class="flex space-x-2">
                                    <button id="start-guide-btn" class="text-sm bg-[var(--primary)] text-white px-3 py-1 rounded-lg click-sound">
                                        <i class="fas fa-play mr-1"></i> Iniciar Gu√≠a
                                    </button>
                                    <button id="pause-guide-btn" class="text-sm bg-gray-500 text-white px-3 py-1 rounded-lg click-sound hidden">
                                        <i class="fas fa-pause mr-1"></i> Pausar
                                    </button>
                                    <button id="stop-voice-btn" class="text-sm bg-red-500 text-white px-3 py-1 rounded-lg click-sound hidden">
                                        <i class="fas fa-stop mr-1"></i> Detener
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Timer de Meditaci√≥n -->
                            <div id="meditation-timer" class="meditation-timer hidden">
                                <div id="timer-display">00:00</div>
                                <div id="current-step-text" class="text-sm mt-1"></div>
                            </div>
                            
                            <div id="meditation-guide" class="meditation-guide-text mb-4">
                                <div id="guide-steps" class="space-y-3"></div>
                            </div>
                            
                            <div class="flex justify-between mt-4 pt-3 border-t border-green-200">
                                <button id="save-meditation-btn" class="text-sm text-[var(--primary)] click-sound">
                                    <i class="far fa-bookmark mr-1"></i> Guardar
                                </button>
                                <button id="restart-guide-btn" class="text-sm text-[var(--primary)] click-sound">
                                    <i class="fas fa-redo mr-1"></i> Reiniciar
                                </button>
                            </div>
                        </div>
                        
                        <div id="meditation-loading" class="mt-4 text-center hidden">
                            <div class="inline-flex items-center space-x-2 text-[var(--primary)]">
                                <div class="w-5 h-5 border-2 border-[var(--primary)] border-t-transparent rounded-full animate-spin"></div>
                                <span>Creando tu meditaci√≥n √∫nica...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 3: Diario Emocional -->
                    <div class="card p-6 border-t-4 border-[var(--accent)]">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-[var(--accent)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-book text-[var(--accent)]"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Diario Emocional üìñ</h2>
                        </div>
                        
                        <div class="mb-6">
                            <div id="journal-calendar" class="mb-4 p-3 bg-gray-50/70 rounded-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <button id="prev-month" class="p-2 hover:bg-gray-100 rounded-lg click-sound">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <h4 id="current-month" class="font-bold text-gray-700 text-sm"></h4>
                                    <button id="next-month" class="p-2 hover:bg-gray-100 rounded-lg click-sound">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <div id="calendar-days" class="grid grid-cols-7 gap-1">
                                    <!-- Calendar days will be generated here -->
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="journal-title" class="block text-sm font-medium text-gray-700 mb-2">
                                    T√≠tulo:
                                </label>
                                <input type="text" id="journal-title" placeholder="C√≥mo me siento hoy..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent">
                            </div>
                            
                            <div class="mb-4">
                                <label for="journal-entry" class="block text-sm font-medium text-gray-700 mb-2">
                                    Escribe lo que sientes:
                                </label>
                                <textarea id="journal-entry" rows="6" placeholder="Hoy me siento...\nLo que m√°s me impact√≥ hoy fue...\nEstoy agradecido por..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"></textarea>
                            </div>
                            
                            <div class="flex items-center mb-4">
                                <input type="checkbox" id="journal-private" class="form-checkbox h-5 w-5 text-[var(--accent)] rounded">
                                <label for="journal-private" class="ml-3 text-gray-700">
                                    Esta entrada es privada
                                </label>
                            </div>
                            
                            <button id="save-journal-btn" class="btn-success w-full py-3 click-sound">
                                <i class="far fa-save mr-2"></i>
                                Guardar en mi diario
                            </button>
                            
                            <div id="journal-status" class="mt-3 text-center text-sm font-medium"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Analytics & History -->
                <div class="space-y-6">
                    
                    <!-- Card 4: Wellness Dashboard -->
                    <div class="card p-6 border-t-4 border-[var(--primary)]">
                        <div class="flex items-center mb-6">
                            <div class="w-10 h-10 rounded-full bg-[var(--primary)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-chart-line text-[var(--primary)]"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Tu Tablero de Bienestar üìä</h2>
                        </div>
                        
                        <!-- Consejo del D√≠a -->
                        <div class="daily-tip mb-6">
                            <h3 id="daily-tip-title" class="text-lg font-bold">Consejo del D√≠a üåü</h3>
                            <p id="daily-tip-content" class="text-sm">Cargando consejo del d√≠a...</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50/70 p-4 rounded-xl">
                                <div class="text-sm text-blue-600 mb-1">Estado de √Ånimo Promedio</div>
                                <div class="text-2xl font-bold text-blue-800">7.2</div>
                                <div class="text-xs text-blue-600">/10 esta semana</div>
                            </div>
                            
                            <div class="bg-green-50/70 p-4 rounded-xl">
                                <div class="text-sm text-green-600 mb-1">D√≠as Consecutivos</div>
                                <div class="text-2xl font-bold text-green-800">14</div>
                                <div class="text-xs text-green-600">registrando tu estado</div>
                            </div>
                            
                            <div class="bg-purple-50/70 p-4 rounded-xl">
                                <div class="text-sm text-purple-600 mb-1">Meditaciones Completadas</div>
                                <div class="text-2xl font-bold text-purple-800">8</div>
                                <div class="text-xs text-purple-600">esta semana</div>
                            </div>
                            
                            <div class="bg-yellow-50/70 p-4 rounded-xl">
                                <div class="text-sm text-yellow-600 mb-1">Entradas Diario</div>
                                <div class="text-2xl font-bold text-yellow-800">5</div>
                                <div class="text-xs text-yellow-600">esta semana</div>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="font-bold text-gray-700 mb-3">Distribuci√≥n de Estados de √Ånimo</h3>
                            <div id="mood-chart" class="space-y-3">
                                <!-- Mood bars will be generated here -->
                            </div>
                        </div>
                        
                        <!-- AI Analysis Section -->
                        <div class="ai-analysis-box">
                            <h3 class="font-bold text-blue-800 mb-3">An√°lisis con IA üß†</h3>
                            <p class="text-sm text-blue-700 mb-3">Obt√©n insights personalizados sobre tu bienestar emocional basados en tus datos.</p>
                            <button id="ai-analysis-btn" class="btn-primary w-full py-2 click-sound">
                                <i class="fas fa-robot mr-2"></i>
                                Obtener An√°lisis Personalizado
                            </button>
                            <div id="ai-analysis-result" class="mt-3 p-3 bg-white/80 rounded-lg text-sm hidden">
                                <!-- AI analysis will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 5: Desconexi√≥n Digital -->
                    <div class="card p-6 border-t-4 border-red-400">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mr-3">
                                <i class="fas fa-mobile-alt text-red-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Desconexi√≥n Digital üìµ</h2>
                        </div>
                        
                        <p class="text-gray-700 mb-6">Establece l√≠mites saludables con la tecnolog√≠a para mejorar tu bienestar mental.</p>
                        
                        <div class="mb-4">
                            <h4 class="font-bold text-gray-700 mb-3">Mi plan de desconexi√≥n:</h4>
                            
                            <div class="detox-checkbox">
                                <input type="checkbox" id="detox-notifications" class="detox-check">
                                <label for="detox-notifications" class="font-medium">Silenciar notificaciones no esenciales por 2 horas</label>
                            </div>
                            
                            <div class="detox-checkbox">
                                <input type="checkbox" id="detox-screens" class="detox-check">
                                <label for="detox-screens" class="font-medium">Sin pantallas 1 hora antes de dormir</label>
                            </div>
                            
                            <div class="detox-checkbox">
                                <input type="checkbox" id="detox-meals" class="detox-check">
                                <label for="detox-meals" class="font-medium">Comer sin dispositivos m√≥viles</label>
                            </div>
                            
                            <div class="mb-4">
                                <label for="detox-custom" class="block text-sm font-medium text-gray-700 mb-2 mt-4">
                                    Mi compromiso personalizado:
                                </label>
                                <textarea id="detox-custom" rows="2" placeholder="Ej: Leer un libro en lugar de revisar redes sociales" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-400 focus:border-transparent"></textarea>
                            </div>
                            
                            <button id="activate-detox-btn" class="btn-primary w-full py-3 bg-gradient-to-r from-red-500 to-orange-500 click-sound">
                                <i class="fas fa-power-off mr-2"></i>
                                Activar Modo Desconexi√≥n
                            </button>
                            
                            <div id="detox-status" class="mt-3 text-center text-sm font-medium"></div>
                        </div>
                    </div>
                    
                    <!-- Card 6: Respira conmigo (Wim Hof) con Globo -->
                    <div class="card p-6 border-t-4 border-blue-400">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                <i class="fas fa-lungs text-blue-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Respira conmigo üå¨Ô∏è</h2>
                        </div>
                        
                        <p class="text-gray-700 mb-6">M√©todo Wim Hof: 30 respiraciones profundas + retenci√≥n</p>
                        
                        <div class="breathing-balloon-container">
                            <div class="breathing-balloon" id="breathing-balloon">
                                <div class="balloon-string"></div>
                                <div class="balloon-knot"></div>
                                <div class="text-white text-center">
                                    <div id="breath-phase" class="text-2xl font-bold mb-2">LISTO</div>
                                    <div id="breath-timer" class="text-4xl font-bold">--</div>
                                </div>
                            </div>
                            <div class="breathing-info">
                                <div class="text-sm">ciclo <span id="breath-cycle">0</span>/30</div>
                            </div>
                        </div>
                        
                        <div class="flex justify-center space-x-4 mb-6 mt-12">
                            <button id="start-breathing" class="btn-primary px-6 py-2 click-sound">
                                <i class="fas fa-play mr-2"></i> Comenzar
                            </button>
                            <button id="stop-breathing" class="px-6 py-2 border border-gray-300 rounded-lg click-sound">
                                <i class="fas fa-stop mr-2"></i> Detener
                            </button>
                            <button id="reset-breathing" class="px-6 py-2 border border-gray-300 rounded-lg click-sound">
                                <i class="fas fa-redo mr-2"></i> Reiniciar
                            </button>
                        </div>
                        
                        <div class="bg-blue-50/70 p-4 rounded-xl">
                            <h4 class="font-bold text-blue-800 mb-2">Instrucciones:</h4>
                            <ol class="text-sm text-blue-700 list-decimal pl-4 space-y-1">
                                <li><strong>INHALA</strong> profundamente (4 segundos) - El globo se inflar√°</li>
                                <li><strong>EXHALA</strong> suavemente (4 segundos) - El globo se desinflar√°</li>
                                <li>Repite 30 veces</li>
                                <li>Ret√©n la respiraci√≥n (1 minuto)</li>
                                <li>Inhala profundamente y mant√©n 15 segundos</li>
                            </ol>
                            <p class="text-xs text-blue-600 mt-2">*Observa c√≥mo el globo se coordina con tu respiraci√≥n</p>
                        </div>
                    </div>
                    
                    <!-- Card 7: Conversemos hoy -->
                    <div class="card p-6 border-t-4 border-teal-400">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-teal-100 flex items-center justify-center mr-3">
                                <i class="fas fa-comments text-teal-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Conversemos hoy üí¨</h2>
                        </div>
                        
                        <p class="text-gray-700 mb-6">Cu√©ntame c√≥mo te sientes. Estoy aqu√≠ para escucharte con comprensi√≥n</p>
                        
                        <div id="ai-chat" class="ai-response mb-4">
                            <div class="ai-message bot-message">
                                <strong>CalmApp:</strong> Hola, me alegra que est√©s aqu√≠ hoy. Puedo ver que buscas un espacio para expresar lo que sientes. Estoy aqu√≠ para escucharte con atenci√≥n y sin juicios. ¬øC√≥mo ha sido tu d√≠a hasta ahora?
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="ai-question" class="block text-sm font-medium text-gray-700 mb-2">
                                ¬øQu√© quieres compartir hoy?
                            </label>
                            <textarea id="ai-question" rows="3" placeholder="Cu√©ntame c√≥mo te sientes, qu√© te preocupa, o qu√© te hace feliz hoy..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-400 focus:border-transparent"></textarea>
                        </div>
                        
                        <button id="ask-ai-btn" class="btn-primary w-full py-3 mb-4 click-sound">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Compartir
                        </button>
                        
                        <div id="ai-loading" class="mt-4 text-center hidden">
                            <div class="inline-flex items-center space-x-2 text-teal-600">
                                <div class="w-5 h-5 border-2 border-teal-600 border-t-transparent rounded-full animate-spin"></div>
                                <span>Estoy reflexionando sobre lo que compartes...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="mt-10 pt-6 border-t border-gray-300 text-center">
                <p class="text-gray-700">CalmApp - Cuidando tu bienestar emocional, un d√≠a a la vez <span class="text-red-500">‚ô•</span></p>
                <p class="text-sm text-gray-600 mt-2">Aplicaci√≥n de uso universal sin fines de lucro - Tu bienestar es lo m√°s importante</p>
            </footer>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // App State
        const appState = {
            currentUser: { name: "Usuario", email: "bienestar@calmapp.com" },
            currentMood: 'neutral',
            moodIntensity: 5,
            meditationTheme: 'respiraci√≥n',
            breathingActive: false,
            breathPhase: 'ready',
            breathCount: 0,
            maxBreaths: 30,
            currentJournalDate: new Date(),
            savedJournals: [],
            moodHistory: [],
            meditationGuideActive: false,
            currentStep: 0,
            meditationSteps: [],
            aiConversation: [
                {
                    role: 'bot',
                    message: 'Hola, me alegra que est√©s aqu√≠ hoy. Puedo ver que buscas un espacio para expresar lo que sientes. Estoy aqu√≠ para escucharte con atenci√≥n y sin juicios. ¬øC√≥mo ha sido tu d√≠a hasta ahora?'
                }
            ],
            ttsActive: false,
            ttsVoice: null,
            sessionStartTime: null,
            sessionTimer: null,
            detoxChecks: {
                notifications: false,
                screens: false,
                meals: false
            },
            meditationTimer: null,
            meditationStartTime: null,
            currentMeditationDuration: 0,
            stepStartTime: null,
            stepRemainingTime: 0
        };

        // Mood Configuration with colors
        const moodConfig = {
            excelente: { color: '#10b981', bgColor: '#d1fae5', emoji: 'ü•≥', name: 'Excelente' },
            bien: { color: '#34d399', bgColor: '#a7f3d0', emoji: 'üòä', name: 'Bien' },
            neutral: { color: '#9ca3af', bgColor: '#f3f4f6', emoji: 'üòê', name: 'Neutral' },
            ansioso: { color: '#fbbf24', bgColor: '#fef3c7', emoji: 'üòü', name: 'Ansioso' },
            estresado: { color: '#f97316', bgColor: '#ffedd5', emoji: 'üòì', name: 'Estresado' },
            triste: { color: '#3b82f6', bgColor: '#dbeafe', emoji: 'üòî', name: 'Triste' }
        };

        // Daily Tips Database
        const dailyTips = [
            "Hoy, dedica 5 minutos a observar tu respiraci√≥n sin intentar cambiarla. Solo observa.",
            "Escribe tres cosas por las que est√°s agradecido. La gratitud transforma nuestra perspectiva.",
            "T√≥mate un descanso de 10 minutos sin pantallas. Mira por la ventana o cierra los ojos.",
            "Haz una pausa consciente antes de cada comida: agradece el alimento que nutrir√° tu cuerpo.",
            "Env√≠ale un mensaje amable a alguien que aprecias. La conexi√≥n es esencial para el bienestar.",
            "Camina durante 15 minutos, prestando atenci√≥n a los sonidos y sensaciones alrededor.",
            "Hoy, practica la autocompasi√≥n: habla contigo mismo como lo har√≠as con un buen amigo.",
            "Dedica tiempo a una actividad que te haga perder la noci√≥n del tiempo (flow state).",
            "Antes de dormir, recuerda un momento positivo del d√≠a. Los peque√±os detalles importan.",
            "Establece una intenci√≥n para el d√≠a: ¬øc√≥mo quieres sentirte? ¬øqu√© actitud cultivar?",
            "Escucha m√∫sica que te eleve el √°nimo y baila como si nadie te viera.",
            "Lee algo inspirador por 10 minutos. Alimenta tu mente con pensamientos positivos.",
            "Hoy, s√© consciente de tu postura corporal. Si√©ntate o p√°rate con dignidad y presencia.",
            "T√≥mate un t√© o infusi√≥n lentamente, saboreando cada sorbo.",
            "Dedica 5 minutos a estirar tu cuerpo suavemente, escuchando sus necesidades.",
            "Hoy, s√© curioso en lugar de cr√≠tico contigo mismo. Observa sin juzgar.",
            "Practica el 'no hacer' durante 15 minutos. Simplemente s√©, sin productividad.",
            "Sonr√≠e aunque no tengas ganas. La sonrisa puede cambiar tu estado emocional.",
            "Observa los pensamientos que pasan por tu mente como nubes en el cielo, sin aferrarte a ellos.",
            "Hoy, prioriza una tarea importante y dale tu atenci√≥n plena.",
            "Date permiso para sentir lo que sientes, sin etiquetarlo como 'bueno' o 'malo'.",
            "Encuentra belleza en algo ordinario: una hoja, un rayo de luz, un color.",
            "Recuerda que las emociones son temporales. Esto tambi√©n pasar√°.",
            "Haz algo creativo, aunque sea peque√±o: dibuja, escribe, cocina con atenci√≥n.",
            "Practica decir 'no' a algo que no te beneficia. Los l√≠mites son amor propio.",
            "Date un ba√±o o ducha consciente, sintiendo el agua en tu piel.",
            "Hoy, elige una palabra que te gu√≠e: paz, calma, presencia, amor.",
            "Revisa tus logros de la semana, por peque√±os que sean.",
            "Abre una ventana y respira aire fresco profundamente.",
            "Apaga las notificaciones no esenciales por una hora. Disfruta el silencio digital.",
            "Hoy, s√© tu propio mejor amigo. Tr√°tate con la bondad que mereces."
        ];

        // Breathing sounds
        const inhaleSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-single-breath-inhale-1001.mp3');
        const exhaleSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-human-sigh-relief-1003.mp3');
        const clickSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3');

        // Speech synthesis for TTS
        let speechSynthesis = window.speechSynthesis;
        let voices = [];
        let currentSpeech = null;

        // Initialize App
        function initApp() {
            // App starts directly without login
            initAppAfterLogin();
        }

        // Initialize app after login
        function initAppAfterLogin() {
            // Set current date
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('es-ES', options);
            
            // Start session timer
            startSessionTimer();
            
            // Load user data
            loadUserData();
            
            // Set initial mood button as active
            setActiveMood('neutral');
            
            // Set initial meditation theme
            setActiveMeditationTheme('respiraci√≥n');
            
            // Initialize calendar
            initJournalCalendar();
            
            // Load TTS voices with specific female voice
            loadTTSVoices();
            
            // Setup event listeners
            setupAppEventListeners();
            
            // Update dashboard
            updateDashboard();
            
            // Show daily tip
            showDailyTip();
            
            console.log('CalmApp iniciada correctamente - Modo Universal');
        }

        // Start session timer
        function startSessionTimer() {
            appState.sessionStartTime = new Date();
            
            appState.sessionTimer = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - appState.sessionStartTime) / 1000);
                const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                document.getElementById('session-time').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        // Load user data from localStorage
        function loadUserData() {
            try {
                const savedMoods = localStorage.getItem('calmapp_moods');
                const savedMeditations = localStorage.getItem('calmapp_meditations');
                const savedJournals = localStorage.getItem('calmapp_journals');
                const savedConversation = localStorage.getItem('calmapp_conversation');
                const savedDetox = localStorage.getItem('calmapp_detox');
                
                if (savedMoods) {
                    appState.moodHistory = JSON.parse(savedMoods);
                }
                
                if (savedMeditations) {
                    appState.savedMeditations = JSON.parse(savedMeditations);
                }
                
                if (savedJournals) {
                    appState.savedJournals = JSON.parse(savedJournals);
                }
                
                if (savedConversation) {
                    appState.aiConversation = JSON.parse(savedConversation);
                    updateAIChatDisplay();
                }
                
                if (savedDetox) {
                    appState.detoxChecks = JSON.parse(savedDetox);
                    updateDetoxCheckboxes();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Save user data to localStorage
        function saveUserData(key, data) {
            localStorage.setItem(`calmapp_${key}`, JSON.stringify(data));
        }

        // Load TTS voices with specific female voice
        function loadTTSVoices() {
            voices = speechSynthesis.getVoices();
            
            // Try to find a specific female voice for Spanish
            const preferredVoices = [
                // Spanish female voices
                'Microsoft Helena Desktop - Spanish (Spain)',
                'Google espa√±ol',
                'Microsoft Sabina Desktop - Spanish (Mexico)',
                'Spanish Female',
                'es-ES-Standard-A', // Google Cloud voices
                'es-MX-Standard-A'
            ];
            
            // Try to find preferred voices first
            for (const preferred of preferredVoices) {
                const voice = voices.find(v => v.name.includes(preferred) || 
                    (v.lang.includes('es') && v.name.toLowerCase().includes('female')));
                if (voice) {
                    appState.ttsVoice = voice;
                    console.log('Voz seleccionada:', voice.name, voice.lang);
                    return;
                }
            }
            
            // Fallback: any Spanish voice
            appState.ttsVoice = voices.find(voice => voice.lang.includes('es')) || voices[0];
            
            if (voices.length === 0) {
                speechSynthesis.onvoiceschanged = () => {
                    voices = speechSynthesis.getVoices();
                    loadTTSVoices();
                };
            }
        }

        // Speak text with TTS with feminine, calm voice
        function speakText(text) {
            if (appState.ttsActive && currentSpeech) {
                speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Configure voice for calm, female guidance
            if (appState.ttsVoice) {
                utterance.voice = appState.ttsVoice;
            }
            
            // Optimized settings for meditation guidance
            utterance.lang = 'es-ES';
            utterance.rate = 0.85; // Slower for calm guidance
            utterance.pitch = 1.2; // Slightly higher for feminine tone
            utterance.volume = 1;
            
            // Event listeners
            utterance.onstart = () => {
                appState.ttsActive = true;
                document.getElementById('stop-voice-btn').classList.remove('hidden');
            };
            
            utterance.onend = () => {
                appState.ttsActive = false;
                document.getElementById('stop-voice-btn').classList.add('hidden');
            };
            
            utterance.onerror = () => {
                appState.ttsActive = false;
                document.getElementById('stop-voice-btn').classList.add('hidden');
            };
            
            currentSpeech = utterance;
            speechSynthesis.speak(utterance);
        }

        // Stop TTS
        function stopTTS() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                appState.ttsActive = false;
                document.getElementById('stop-voice-btn').classList.add('hidden');
            }
        }

        // Play click sound
        function playClickSound() {
            if (clickSound) {
                clickSound.currentTime = 0;
                clickSound.play();
            }
        }

        // Initialize journal calendar
        function initJournalCalendar() {
            updateCalendarDisplay();
            
            // Set up calendar navigation
            document.getElementById('prev-month').addEventListener('click', () => {
                appState.currentJournalDate.setMonth(appState.currentJournalDate.getMonth() - 1);
                updateCalendarDisplay();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                appState.currentJournalDate.setMonth(appState.currentJournalDate.getMonth() + 1);
                updateCalendarDisplay();
            });
        }

        // Setup app event listeners
        function setupAppEventListeners() {
            // Mood buttons
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    playClickSound();
                    const mood = this.getAttribute('data-mood');
                    setActiveMood(mood);
                });
            });
            
            // Mood intensity slider
            const intensitySlider = document.getElementById('mood-intensity');
            const intensityValue = document.getElementById('intensity-value');
            intensitySlider.addEventListener('input', function() {
                intensityValue.textContent = this.value;
                appState.moodIntensity = parseInt(this.value);
            });
            
            // Save mood button
            document.getElementById('save-mood-btn').addEventListener('click', () => {
                playClickSound();
                saveMoodEntry();
            });
            
            // Meditation options
            document.querySelectorAll('.meditation-option').forEach(option => {
                option.addEventListener('click', function() {
                    playClickSound();
                    const theme = this.getAttribute('data-theme');
                    setActiveMeditationTheme(theme);
                });
            });
            
            // Generate meditation button
            document.getElementById('generate-meditation-btn').addEventListener('click', () => {
                playClickSound();
                generateMeditation();
            });
            
            // Meditation guide buttons
            document.getElementById('start-guide-btn').addEventListener('click', () => {
                playClickSound();
                startMeditationGuide();
            });
            document.getElementById('pause-guide-btn').addEventListener('click', () => {
                playClickSound();
                pauseMeditationGuide();
            });
            document.getElementById('stop-voice-btn').addEventListener('click', () => {
                playClickSound();
                stopTTS();
            });
            document.getElementById('restart-guide-btn').addEventListener('click', () => {
                playClickSound();
                restartMeditationGuide();
            });
            
            // Save meditation button
            document.getElementById('save-meditation-btn')?.addEventListener('click', () => {
                playClickSound();
                saveMeditation();
            });
            
            // Breathing buttons
            document.getElementById('start-breathing').addEventListener('click', () => {
                playClickSound();
                startBreathing();
            });
            document.getElementById('stop-breathing').addEventListener('click', () => {
                playClickSound();
                stopBreathing();
            });
            document.getElementById('reset-breathing').addEventListener('click', () => {
                playClickSound();
                resetBreathing();
            });
            
            // Save journal button
            document.getElementById('save-journal-btn').addEventListener('click', () => {
                playClickSound();
                saveJournalEntry();
            });
            
            // AI button
            document.getElementById('ask-ai-btn').addEventListener('click', () => {
                playClickSound();
                startConversation();
            });
            
            // AI Analysis button
            document.getElementById('ai-analysis-btn').addEventListener('click', () => {
                playClickSound();
                generateAIAnalysis();
            });
            
            // Detox checkboxes
            document.querySelectorAll('.detox-check').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateDetoxState();
                });
            });
            
            // Activate detox button
            document.getElementById('activate-detox-btn').addEventListener('click', () => {
                playClickSound();
                activateDetoxMode();
            });
        }

        // Set active mood with colors
        function setActiveMood(mood) {
            appState.currentMood = mood;
            const config = moodConfig[mood];
            
            if (!config) return;
            
            // Update UI for all mood buttons
            document.querySelectorAll('.mood-btn').forEach(btn => {
                const btnMood = btn.getAttribute('data-mood');
                const btnConfig = moodConfig[btnMood];
                
                if (btnMood === mood) {
                    // Active state
                    btn.style.backgroundColor = config.bgColor;
                    btn.style.borderColor = config.color;
                    btn.style.color = config.color;
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = `0 4px 12px ${config.color}40`;
                } else {
                    // Inactive state
                    btn.style.backgroundColor = '';
                    btn.style.borderColor = '#e5e7eb';
                    btn.style.color = '#374151';
                    btn.style.transform = '';
                    btn.style.boxShadow = '';
                }
            });
        }

        // Set active meditation theme
        function setActiveMeditationTheme(theme) {
            appState.meditationTheme = theme;
            
            // Update UI
            document.querySelectorAll('.meditation-option').forEach(option => {
                if (option.getAttribute('data-theme') === theme) {
                    option.style.borderColor = 'var(--secondary)';
                    option.style.backgroundColor = 'rgba(110, 231, 183, 0.1)';
                } else {
                    option.style.borderColor = '#e5e7eb';
                    option.style.backgroundColor = '';
                }
            });
        }

        // Generate meditation with guided steps
        function generateMeditation() {
            const btn = document.getElementById('generate-meditation-btn');
            const loading = document.getElementById('meditation-loading');
            const output = document.getElementById('meditation-output');
            const guideSteps = document.getElementById('guide-steps');
            const titleElement = document.getElementById('meditation-title');
            
            // Show loading state
            btn.disabled = true;
            loading.classList.remove('hidden');
            output.classList.add('hidden');
            
            // Get meditation theme
            const theme = appState.meditationTheme;
            
            // Simulate AI generation delay
            setTimeout(() => {
                // Generate meditation steps based on theme
                appState.meditationSteps = generateMeditationSteps(theme);
                
                // Display steps
                guideSteps.innerHTML = '';
                appState.meditationSteps.forEach((step, index) => {
                    const stepElement = document.createElement('div');
                    stepElement.className = 'meditation-step';
                    stepElement.id = `step-${index}`;
                    stepElement.innerHTML = `
                        <div class="flex items-start">
                            <div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center mr-3 mt-1">
                                <span class="text-xs font-bold">${index + 1}</span>
                            </div>
                            <div>
                                <p>${step.text}</p>
                                ${step.duration ? `<p class="text-sm text-gray-500 mt-1"><i class="far fa-clock mr-1"></i>${step.duration}</p>` : ''}
                            </div>
                        </div>
                    `;
                    guideSteps.appendChild(stepElement);
                });
                
                // Set title
                const themeTitles = {
                    'respiraci√≥n': 'Meditaci√≥n de Respiraci√≥n Consciente',
                    'relajaci√≥n': 'Relajaci√≥n Profunda con Ondas',
                    'concentraci√≥n': 'Meditaci√≥n para el Enfoque Mental',
                    'ansiedad': 'Calma para la Ansiedad'
                };
                titleElement.textContent = themeTitles[theme] || 'Meditaci√≥n Guiada';
                
                // Update UI
                loading.classList.add('hidden');
                output.classList.remove('hidden');
                btn.disabled = false;
                
                // Reset guide state
                appState.meditationGuideActive = false;
                appState.currentStep = 0;
                document.getElementById('start-guide-btn').classList.remove('hidden');
                document.getElementById('pause-guide-btn').classList.add('hidden');
                document.getElementById('stop-voice-btn').classList.add('hidden');
                document.getElementById('meditation-timer').classList.add('hidden');
                
                // Play success sound
                playSuccessSound();
            }, 1500);
        }

        // Generate meditation steps based on theme with complete guidance
        function generateMeditationSteps(theme) {
            const steps = [];
            
            switch(theme) {
                case 'respiraci√≥n':
                    steps.push(
                        { 
                            text: 'Hola, soy tu gu√≠a de meditaci√≥n. Te acompa√±ar√© en este ejercicio de respiraci√≥n consciente. Comienza encontrando una posici√≥n c√≥moda, ya sea sentado o acostado. Cierra suavemente los ojos y lleva tu atenci√≥n a este momento presente.', 
                            duration: '1 minuto 30 segundos',
                            detailed: true
                        },
                        { 
                            text: 'Ahora, vamos a comenzar con la respiraci√≥n. Empieza a notar tu respiraci√≥n natural, tal como es en este momento. No la forces, solo observa c√≥mo el aire entra y sale de tu cuerpo. Observa la temperatura del aire al inhalar y al exhalar.', 
                            duration: '1 minuto',
                            detailed: true
                        },
                        { 
                            text: 'Vamos a practicar la t√©cnica 4-7-8. Primero, inhala profundamente por la nariz durante 4 segundos... Siente c√≥mo el aire llena tus pulmones, expande tu abdomen... 1... 2... 3... 4...', 
                            duration: '4 segundos',
                            detailed: true,
                            countdown: true
                        },
                        { 
                            text: 'Ahora mant√©n la respiraci√≥n durante 7 segundos... Permanece en este estado de plenitud... Siente la energ√≠a en tu cuerpo... 1... 2... 3... 4... 5... 6... 7...', 
                            duration: '7 segundos',
                            detailed: true,
                            countdown: true
                        },
                        { 
                            text: 'Exhala lentamente por la boca durante 8 segundos... Libera cualquier tensi√≥n o preocupaci√≥n... Deja ir todo lo que no necesitas en este momento... 1... 2... 3... 4... 5... 6... 7... 8...', 
                            duration: '8 segundos',
                            detailed: true,
                            countdown: true
                        },
                        { 
                            text: 'Excelente. Ahora repite este ciclo de 4-7-8 durante 3 minutos. Con cada exhalaci√≥n, imagina que liberas estr√©s y ansiedad. Con cada inhalaci√≥n, imaginas que recibes calma y paz.', 
                            duration: '3 minutos',
                            detailed: true
                        },
                        { 
                            text: 'Muy bien. Ahora vuelve a tu respiraci√≥n natural. Observa c√≥mo te sientes ahora, m√°s calmado y centrado. Toma nota de las sensaciones en tu cuerpo.', 
                            duration: '1 minuto',
                            detailed: true
                        },
                        { 
                            text: 'Para finalizar, lleva suavemente tu conciencia de vuelta al presente. Empieza a mover lentamente los dedos de las manos y pies. Cuando est√©s listo, abre los ojos con calma.', 
                            duration: '30 segundos',
                            detailed: true
                        }
                    );
                    break;
                    
                case 'relajaci√≥n':
                    steps.push(
                        { 
                            text: 'Bienvenido a esta meditaci√≥n de relajaci√≥n profunda. Soy tu gu√≠a y te acompa√±ar√© en este viaje hacia la calma. Si√©ntate o acu√©state en una posici√≥n c√≥moda. Cierra los ojos y comienza a relajarte.', 
                            duration: '1 minuto',
                            detailed: true
                        },
                        { 
                            text: 'Imagina que est√°s en una playa tranquila al atardecer. Escucha el sonido suave de las olas a lo lejos... El sonido r√≠tmico del mar te invita a relajarte...', 
                            duration: '2 minutos',
                            detailed: true
                        },
                        { 
                            text: 'Siente la brisa suave en tu piel... Nota la calma que te rodea... El aire es fresco y puro... Con cada respiraci√≥n, te sientes m√°s relajado...', 
                            duration: '1 minuto',
                            detailed: true
                        },
                        { 
                            text: 'Con cada ola que llega a la orilla, siente c√≥mo la tensi√≥n abandona tu cuerpo... Imagina que las preocupaciones se van con el agua que retrocede...', 
                            duration: '2 minutos',
                            detailed: true
                        },
                        { 
                            text: 'Permanece en este estado de paz... No hay nada que hacer, solo ser... Eres parte de este momento perfecto...', 
                            duration: '2 minutos',
                            detailed: true
                        },
                        { 
                            text: 'Cuando est√©s listo, comienza a traer lentamente tu conciencia de vuelta... Nota c√≥mo te sientes ahora... M√°s tranquilo, m√°s sereno...', 
                            duration: '1 minuto',
                            detailed: true
                        }
                    );
                    break;
                    
                case 'concentraci√≥n':
                    steps.push(
                        { 
                            text: 'Vamos a practicar una meditaci√≥n para mejorar la concentraci√≥n. Si√©ntate con la espalda recta pero relajada. Fija tu mirada suavemente en un punto frente a ti o cierra los ojos si prefieres.', 
                            duration: '30 segundos',
                            detailed: true
                        },
                        { 
                            text: 'Comienza a contar tus respiraciones. Inhala... cuenta 1... exhala... cuenta 1... Inhala... cuenta 2... exhala... cuenta 2... Contin√∫a as√≠.', 
                            duration: '2 minutos',
                            detailed: true
                        },
                        { 
                            text: 'Si tu mente divaga, amablemente regresa a contar las respiraciones. Sin juicios, solo regresa al conteo. Este es el ejercicio: observar y regresar.', 
                            duration: '2 minutos',
                            detailed: true
                        },
                        { 
                            text: 'Contin√∫a hasta 10, luego comienza de nuevo desde 1. Observa c√≥mo tu concentraci√≥n se fortalece con cada respiraci√≥n.', 
                            duration: '2 minutos',
                            detailed: true
                        },
                        { 
                            text: 'Para finalizar, deja de contar y simplemente observa tu respiraci√≥n por un momento m√°s. Nota la claridad mental que has cultivado.', 
                            duration: '1 minuto',
                            detailed: true
                        }
                    );
                    break;
                    
                case 'ansiedad':
                    steps.push(
                        { 
                            text: 'Hola, te acompa√±o en esta meditaci√≥n para calmar la ansiedad. Primero, reconoce la ansiedad sin luchar contra ella. Di mentalmente: "Estoy sintiendo ansiedad, y est√° bien".', 
                            duration: '1 minuto',
                            detailed: true
                        },
                        { 
                            text: 'Observa d√≥nde sientes la ansiedad en tu cuerpo. ¬øEs en el pecho? ¬øEn el est√≥mago? Solo observa sin juzgar, como si fueras un cient√≠fico curioso.', 
                            duration: '1 minuto',
                            detailed: true
                        },
                        { 
                            text: 'Coloca ambas manos sobre tu coraz√≥n. Siente el calor de tus manos y el latido de tu coraz√≥n. Este gesto activa el sistema de calma natural de tu cuerpo.', 
                            duration: '1 minuto',
                            detailed: true
                        },
                        { 
                            text: 'Con cada exhalaci√≥n, env√≠a compasi√≥n a esa parte de ti que siente ansiedad. Di mentalmente: "Que est√©s en paz, que est√©s a salvo".', 
                            duration: '2 minutos',
                            detailed: true
                        },
                        { 
                            text: 'Recuerda que las emociones son temporales. Esta ansiedad tambi√©n pasar√°. Como las nubes en el cielo, viene y se va.', 
                            duration: '1 minuto',
                            detailed: true
                        },
                        { 
                            text: 'Permanece en este espacio de aceptaci√≥n y cuidado propio. Eres m√°s fuerte de lo que crees.', 
                            duration: '1 minuto',
                            detailed: true
                        }
                    );
                    break;
                    
                default:
                    steps.push(
                        { 
                            text: 'Comencemos nuestra meditaci√≥n. Encuentra una posici√≥n c√≥moda y cierra los ojos.', 
                            duration: '30 segundos',
                            detailed: true
                        },
                        { 
                            text: 'Observa tu respiraci√≥n natural sin intentar cambiarla. Solo s√© testigo de c√≥mo tu cuerpo respira por s√≠ mismo.', 
                            duration: '2 minutos',
                            detailed: true
                        },
                        { 
                            text: 'Si tu mente divaga, amablemente regresa a la respiraci√≥n. Este es el coraz√≥n de la pr√°ctica: darse cuenta y regresar.', 
                            duration: '2 minutos',
                            detailed: true
                        },
                        { 
                            text: 'Permanece en este estado de presencia consciente. Eres conciencia pura observando la experiencia.', 
                            duration: '1 minuto',
                            detailed: true
                        }
                    );
            }
            
            return steps;
        }

        // Start meditation guide with complete guidance
        function startMeditationGuide() {
            if (appState.meditationSteps.length === 0) return;
            
            appState.meditationGuideActive = true;
            appState.currentStep = 0;
            appState.meditationStartTime = new Date();
            
            document.getElementById('start-guide-btn').classList.add('hidden');
            document.getElementById('pause-guide-btn').classList.remove('hidden');
            document.getElementById('meditation-timer').classList.remove('hidden');
            
            // Start guiding through steps with complete guidance
            guideNextStepWithCompleteGuidance();
        }

        // Pause meditation guide
        function pauseMeditationGuide() {
            appState.meditationGuideActive = false;
            
            document.getElementById('start-guide-btn').classList.remove('hidden');
            document.getElementById('pause-guide-btn').classList.add('hidden');
            
            // Stop TTS
            stopTTS();
            
            // Clear any active timeouts
            if (appState.guideTimeout) {
                clearTimeout(appState.guideTimeout);
            }
            if (appState.meditationTimer) {
                clearInterval(appState.meditationTimer);
            }
            if (appState.stepTimer) {
                clearInterval(appState.stepTimer);
            }
        }

        // Restart meditation guide
        function restartMeditationGuide() {
            pauseMeditationGuide();
            
            // Reset steps highlighting
            document.querySelectorAll('.meditation-step').forEach(step => {
                step.classList.remove('step-active');
            });
            
            appState.currentStep = 0;
            document.getElementById('timer-display').textContent = '00:00';
            document.getElementById('current-step-text').textContent = '';
            document.getElementById('meditation-timer').classList.add('hidden');
            
            // Start again
            setTimeout(() => {
                startMeditationGuide();
            }, 500);
        }

        // Guide through meditation steps with complete guidance
        function guideNextStepWithCompleteGuidance() {
            if (!appState.meditationGuideActive || appState.currentStep >= appState.meditationSteps.length) {
                // Meditation complete
                completeMeditation();
                return;
            }
            
            // Highlight current step
            document.querySelectorAll('.meditation-step').forEach(step => {
                step.classList.remove('step-active');
            });
            
            const currentStepElement = document.getElementById(`step-${appState.currentStep}`);
            if (currentStepElement) {
                currentStepElement.classList.add('step-active');
                currentStepElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Get current step
            const step = appState.meditationSteps[appState.currentStep];
            const stepDuration = parseDurationToSeconds(step.duration);
            
            // Update timer display
            document.getElementById('current-step-text').textContent = `Paso ${appState.currentStep + 1} de ${appState.meditationSteps.length}`;
            
            // Speak the step using TTS with feminine voice
            speakMeditationStep(step, stepDuration);
            
            // Start step timer
            startStepTimer(stepDuration, step.text);
            
            // Move to next step after duration
            appState.guideTimeout = setTimeout(() => {
                appState.currentStep++;
                guideNextStepWithCompleteGuidance();
            }, (stepDuration * 1000) + 1000); // Extra second for TTS completion
        }

        // Speak meditation step with feminine guidance
        function speakMeditationStep(step, duration) {
            let textToSpeak = step.text;
            
            // Add time guidance for countdown steps
            if (step.countdown && duration <= 30) {
                // For short countdown steps, speak each second
                speakCountdownStep(step, duration);
                return;
            }
            
            // For longer steps, add time information
            if (duration > 30) {
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                let timeInfo = '';
                
                if (minutes > 0) {
                    timeInfo = `Durante ${minutes} minuto${minutes > 1 ? 's' : ''}`;
                    if (seconds > 0) {
                        timeInfo += ` y ${seconds} segundo${seconds > 1 ? 's' : ''}`;
                    }
                } else {
                    timeInfo = `Durante ${seconds} segundo${seconds > 1 ? 's' : ''}`;
                }
                
                textToSpeak = `${step.text} ${timeInfo}. Te guiar√© durante este tiempo.`;
            }
            
            speakText(textToSpeak);
        }

        // Speak countdown step with second-by-second guidance
        function speakCountdownStep(step, duration) {
            let currentSecond = 1;
            const stepText = step.text.replace(/\d+\.\.\./g, '').trim();
            
            // Speak initial instruction
            speakText(stepText + ' Comenzamos ahora.');
            
            // Start countdown
            const countdownInterval = setInterval(() => {
                if (currentSecond <= duration) {
                    // Speak count at certain intervals
                    if (currentSecond === 1 || currentSecond === Math.floor(duration/2) || currentSecond === duration) {
                        speakText(currentSecond.toString());
                    }
                    currentSecond++;
                } else {
                    clearInterval(countdownInterval);
                    speakText('Muy bien.');
                }
            }, 1000);
            
            appState.countdownInterval = countdownInterval;
        }

        // Parse duration string to seconds
        function parseDurationToSeconds(duration) {
            if (!duration) return 60; // Default 1 minute
            
            let totalSeconds = 0;
            
            // Check for minutes
            const minutesMatch = duration.match(/(\d+)\s*minuto/);
            if (minutesMatch) {
                totalSeconds += parseInt(minutesMatch[1]) * 60;
            }
            
            // Check for seconds
            const secondsMatch = duration.match(/(\d+)\s*segundo/);
            if (secondsMatch) {
                totalSeconds += parseInt(secondsMatch[1]);
            }
            
            return totalSeconds || 60; // Default to 60 seconds if parsing fails
        }

        // Start step timer
        function startStepTimer(duration, stepText) {
            appState.stepRemainingTime = duration;
            appState.stepStartTime = new Date();
            
            // Update timer immediately
            updateStepTimer();
            
            // Start timer interval
            appState.stepTimer = setInterval(() => {
                appState.stepRemainingTime--;
                updateStepTimer();
                
                if (appState.stepRemainingTime <= 0) {
                    clearInterval(appState.stepTimer);
                }
            }, 1000);
        }

        // Update step timer display
        function updateStepTimer() {
            const minutes = Math.floor(appState.stepRemainingTime / 60);
            const seconds = appState.stepRemainingTime % 60;
            document.getElementById('timer-display').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update total meditation timer
            if (appState.meditationStartTime) {
                const totalSeconds = Math.floor((new Date() - appState.meditationStartTime) / 1000);
                const totalMinutes = Math.floor(totalSeconds / 60);
                const remainingSeconds = totalSeconds % 60;
                // You could display total time if needed
            }
        }

        // Complete meditation
        function completeMeditation() {
            pauseMeditationGuide();
            
            // Highlight completion
            const guideSteps = document.getElementById('guide-steps');
            guideSteps.innerHTML += `
                <div class="meditation-step step-active">
                    <div class="flex items-center justify-center text-green-600">
                        <i class="fas fa-check-circle text-2xl mr-3"></i>
                        <div>
                            <p class="font-bold">¬°Meditaci√≥n completada!</p>
                            <p class="text-sm">T√≥mate un momento para notar c√≥mo te sientes.</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Speak completion message with feminine voice
            speakText('Excelente trabajo. Has completado la meditaci√≥n. T√≥mate unos momentos para notar c√≥mo te sientes ahora. Observa las sensaciones en tu cuerpo, la calma en tu mente. Cuando est√©s listo, puedes abrir suavemente los ojos y continuar con tu d√≠a llevando esta paz contigo.');
            
            // Hide timer
            document.getElementById('meditation-timer').classList.add('hidden');
        }

        // Save mood entry
        function saveMoodEntry() {
            const notes = document.getElementById('mood-notes').value.trim();
            const moodEntry = {
                mood: appState.currentMood,
                intensity: appState.moodIntensity,
                notes: notes,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('es-ES')
            };
            
            appState.moodHistory.unshift(moodEntry);
            
            // Limit to last 50 entries
            if (appState.moodHistory.length > 50) {
                appState.moodHistory = appState.moodHistory.slice(0, 50);
            }
            
            // Save to localStorage
            saveUserData('moods', appState.moodHistory);
            
            // Update UI
            document.getElementById('mood-status').textContent = '‚úÖ Estado registrado exitosamente';
            document.getElementById('mood-status').style.color = 'var(--success)';
            
            // Clear notes
            document.getElementById('mood-notes').value = '';
            
            // Update dashboard
            updateDashboard();
            
            // Update wellness score
            updateWellnessScore();
            
            // Update daily tip based on mood
            showDailyTip();
            
            // Play success sound
            playSuccessSound();
            
            // Hide status message after 3 seconds
            setTimeout(() => {
                document.getElementById('mood-status').textContent = '';
            }, 3000);
        }

        // Save journal entry
        function saveJournalEntry() {
            const title = document.getElementById('journal-title').value.trim();
            const content = document.getElementById('journal-entry').value.trim();
            const isPrivate = document.getElementById('journal-private').checked;
            
            if (!content) {
                alert('Por favor, escribe algo en tu diario antes de guardar.');
                return;
            }
            
            const journalEntry = {
                title: title || 'Sin t√≠tulo',
                content: content,
                private: isPrivate,
                date: new Date().toISOString(),
                mood: appState.currentMood
            };
            
            // Add to saved journals
            appState.savedJournals.unshift(journalEntry);
            
            // Save to localStorage
            saveUserData('journals', appState.savedJournals);
            
            // Update UI
            document.getElementById('journal-status').textContent = '‚úÖ Entrada guardada en tu diario';
            document.getElementById('journal-status').style.color = 'var(--success)';
            
            // Clear fields
            document.getElementById('journal-title').value = '';
            document.getElementById('journal-entry').value = '';
            
            // Update calendar
            updateCalendarDisplay();
            
            // Play success sound
            playSuccessSound();
            
            // Hide status message after 3 seconds
            setTimeout(() => {
                document.getElementById('journal-status').textContent = '';
            }, 3000);
        }

        // Start Wim Hof breathing with balloon animation
        function startBreathing() {
            if (appState.breathingActive) {
                stopBreathing();
                return;
            }
            
            appState.breathingActive = true;
            appState.breathCount = 0;
            appState.breathPhase = 'inhale';
            
            document.getElementById('start-breathing').innerHTML = '<i class="fas fa-pause mr-2"></i> Pausar';
            document.getElementById('breath-phase').textContent = 'INHALA';
            document.getElementById('breath-timer').textContent = '4';
            document.getElementById('breath-cycle').textContent = '0';
            
            // Start breathing cycle with balloon animation
            breathingCycleWithBalloon();
        }

        // Stop breathing
        function stopBreathing() {
            appState.breathingActive = false;
            document.getElementById('start-breathing').innerHTML = '<i class="fas fa-play mr-2"></i> Comenzar';
            document.getElementById('breath-phase').textContent = 'LISTO';
            document.getElementById('breath-timer').textContent = '--';
            
            // Reset balloon
            const balloon = document.getElementById('breathing-balloon');
            balloon.classList.remove('inhaling', 'exhaling', 'holding');
            balloon.style.transform = 'scale(1)';
            balloon.style.width = '150px';
            balloon.style.height = '200px';
            
            // Clear any active timeouts
            if (appState.breathingTimeout) {
                clearTimeout(appState.breathingTimeout);
            }
        }

        // Reset breathing
        function resetBreathing() {
            stopBreathing();
            appState.breathCount = 0;
            appState.breathPhase = 'ready';
            document.getElementById('breath-cycle').textContent = '0';
            document.getElementById('breath-phase').textContent = 'LISTO';
            document.getElementById('breath-timer').textContent = '--';
        }

        // Breathing cycle with balloon animation
        function breathingCycleWithBalloon() {
            if (!appState.breathingActive) return;
            
            const breathPhase = document.getElementById('breath-phase');
            const breathTimer = document.getElementById('breath-timer');
            const breathCycle = document.getElementById('breath-cycle');
            const balloon = document.getElementById('breathing-balloon');
            
            let timer = 4; // 4 seconds for inhale/exhale
            
            function updateTimer() {
                if (!appState.breathingActive) return;
                
                breathTimer.textContent = timer;
                breathCycle.textContent = appState.breathCount;
                
                if (timer > 0) {
                    timer--;
                    appState.breathingTimeout = setTimeout(updateTimer, 1000);
                } else {
                    // Play click sound on phase change
                    playClickSound();
                    
                    // Switch phase with balloon animation
                    if (appState.breathPhase === 'inhale') {
                        // Play exhale sound
                        exhaleSound.currentTime = 0;
                        exhaleSound.play();
                        
                        // Animate balloon deflating
                        balloon.classList.remove('inhaling');
                        balloon.classList.add('exhaling');
                        
                        appState.breathPhase = 'exhale';
                        breathPhase.textContent = 'EXHALA';
                        appState.breathCount++;
                        
                        if (appState.breathCount >= appState.maxBreaths) {
                            // Start retention phase
                            breathPhase.textContent = 'RETEN';
                            breathTimer.textContent = '60';
                            
                            // Balloon holds inflated
                            balloon.classList.remove('exhaling');
                            balloon.classList.add('holding');
                            
                            playClickSound();
                            appState.breathingTimeout = setTimeout(() => {
                                if (appState.breathingActive) {
                                    // Final inhale with click and balloon animation
                                    playClickSound();
                                    inhaleSound.currentTime = 0;
                                    inhaleSound.play();
                                    
                                    // Final balloon inflation
                                    balloon.classList.remove('holding');
                                    balloon.classList.add('inhaling');
                                    
                                    breathPhase.textContent = 'INHALA FINAL';
                                    breathTimer.textContent = '15';
                                    
                                    appState.breathingTimeout = setTimeout(() => {
                                        stopBreathing();
                                        // Play completion sound
                                        playSuccessSound();
                                        speakText('Excelente. Has completado la sesi√≥n de respiraci√≥n. T√≥mate un momento para notar c√≥mo te sientes.');
                                    }, 15000);
                                }
                            }, 60000);
                            return;
                        }
                    } else {
                        // Play inhale sound
                        inhaleSound.currentTime = 0;
                        inhaleSound.play();
                        
                        // Animate balloon inflating
                        balloon.classList.remove('exhaling');
                        balloon.classList.add('inhaling');
                        
                        appState.breathPhase = 'inhale';
                        breathPhase.textContent = 'INHALA';
                    }
                    
                    // Reset timer
                    timer = 4;
                    appState.breathingTimeout = setTimeout(updateTimer, 1000);
                }
            }
            
            // Start first inhale with sound, click and balloon animation
            playClickSound();
            inhaleSound.currentTime = 0;
            inhaleSound.play();
            balloon.classList.add('inhaling');
            updateTimer();
        }

        // Save meditation
        function saveMeditation() {
            if (appState.meditationSteps.length === 0) return;
            
            const meditation = {
                theme: appState.meditationTheme,
                steps: appState.meditationSteps,
                timestamp: new Date().toISOString(),
                guided: true
            };
            
            appState.savedMeditations.unshift(meditation);
            
            // Save to localStorage
            saveUserData('meditations', appState.savedMeditations);
            
            // Show confirmation
            const saveBtn = document.getElementById('save-meditation-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-check mr-1"></i> ¬°Guardada!';
            saveBtn.style.color = 'var(--success)';
            
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.style.color = '';
            }, 2000);
            
            playSuccessSound();
        }

        // Update dashboard
        function updateDashboard() {
            // Update mood chart
            updateMoodChart();
            
            // Update stats
            updateStats();
        }

        // Update mood chart
        function updateMoodChart() {
            const chartContainer = document.getElementById('mood-chart');
            
            if (appState.moodHistory.length === 0) {
                chartContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Registra tu estado de √°nimo para ver estad√≠sticas</p>';
                return;
            }
            
            // Get mood counts for last 7 entries
            const recentMoods = appState.moodHistory.slice(0, 7);
            const moodCounts = {};
            
            recentMoods.forEach(entry => {
                moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
            });
            
            // Calculate percentages
            const total = recentMoods.length;
            chartContainer.innerHTML = '';
            
            Object.entries(moodCounts).forEach(([mood, count]) => {
                const percentage = (count / total) * 100;
                const config = moodConfig[mood];
                
                if (config) {
                    const bar = document.createElement('div');
                    bar.className = 'flex items-center';
                    bar.innerHTML = `
                        <div class="w-1/4 flex items-center">
                            <span class="text-lg mr-2">${config.emoji}</span>
                            <span class="text-sm font-medium">${config.name}</span>
                        </div>
                        <div class="flex-grow bg-gray-200 rounded-full overflow-hidden">
                            <div class="mood-bar h-2 rounded-full" style="width: ${percentage}%; background-color: ${config.color};"></div>
                        </div>
                        <div class="w-16 text-right">
                            <span class="text-xs font-medium">${percentage.toFixed(0)}%</span>
                        </div>
                    `;
                    chartContainer.appendChild(bar);
                }
            });
        }

        // Update stats
        function updateStats() {
            // Update consecutive days
            const consecutiveDays = calculateConsecutiveDays();
            document.querySelector('.bg-green-50\\/70 .text-2xl').textContent = consecutiveDays;
            
            // Update meditation count
            const meditationCount = (appState.savedMeditations ? appState.savedMeditations.length : 0) + 3;
            document.querySelector('.bg-purple-50\\/70 .text-2xl').textContent = meditationCount;
            
            // Update journal entries count
            const journalCount = appState.savedJournals.length;
            document.querySelector('.bg-yellow-50\\/70 .text-2xl').textContent = journalCount;
            
            // Update average mood
            if (appState.moodHistory.length > 0) {
                const avgIntensity = appState.moodHistory
                    .slice(0, 7)
                    .reduce((sum, entry) => sum + entry.intensity, 0) / 
                    Math.min(appState.moodHistory.length, 7);
                document.querySelector('.bg-blue-50\\/70 .text-2xl').textContent = avgIntensity.toFixed(1);
            }
        }

        // Calculate consecutive days
        function calculateConsecutiveDays() {
            if (appState.moodHistory.length === 0) return 0;
            
            let consecutive = 1;
            
            for (let i = 0; i < appState.moodHistory.length - 1; i++) {
                const currentDate = new Date(appState.moodHistory[i].timestamp);
                const nextDate = new Date(appState.moodHistory[i + 1].timestamp);
                const diffDays = Math.floor((currentDate - nextDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    consecutive++;
                } else if (diffDays > 1) {
                    break;
                }
            }
            
            return consecutive;
        }

        // Update wellness score
        function updateWellnessScore() {
            let score = 85; // Base score
            
            // Bonus for consistent tracking
            if (appState.moodHistory.length >= 7) score += 5;
            if (appState.moodHistory.length >= 14) score += 5;
            
            // Bonus for saved meditations
            score += Math.min((appState.savedMeditations ? appState.savedMeditations.length : 0) * 2, 10);
            
            // Bonus for journal entries
            score += Math.min(appState.savedJournals.length * 2, 10);
            
            // Bonus for AI conversation engagement
            if (appState.aiConversation.length > 2) score += 5;
            
            // Cap at 100
            score = Math.min(score, 100);
            
            document.getElementById('wellness-score').textContent = score;
        }

        // Show daily tip
        function showDailyTip() {
            // Get day of month (1-31)
            const dayOfMonth = new Date().getDate();
            let tipIndex = (dayOfMonth - 1) % dailyTips.length;
            
            // Adjust tip based on user's mood if available
            if (appState.moodHistory.length > 0) {
                const latestMood = appState.moodHistory[0].mood;
                
                // Adjust tip based on mood
                if (latestMood === 'triste' || latestMood === 'ansioso') {
                    // Show more comforting tips
                    tipIndex = (tipIndex + 10) % dailyTips.length;
                } else if (latestMood === 'excelente' || latestMood === 'bien') {
                    // Show more uplifting or growth-oriented tips
                    tipIndex = (tipIndex + 20) % dailyTips.length;
                }
            }
            
            document.getElementById('daily-tip-title').textContent = `Consejo del D√≠a üåü`;
            document.getElementById('daily-tip-content').textContent = dailyTips[tipIndex];
        }

        // Generate AI Analysis
        function generateAIAnalysis() {
            const btn = document.getElementById('ai-analysis-btn');
            const resultDiv = document.getElementById('ai-analysis-result');
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analizando...';
            resultDiv.classList.add('hidden');
            
            // Simulate AI processing delay
            setTimeout(() => {
                // Generate analysis based on user data
                const analysis = generatePersonalizedAnalysis();
                
                // Display results
                resultDiv.innerHTML = `
                    <h4 class="font-bold text-blue-800 mb-2">üìà Tu An√°lisis Personalizado:</h4>
                    <div class="space-y-3">
                        ${analysis.map(item => `
                            <div class="p-2 bg-white rounded border-l-4 ${item.color}">
                                <p class="font-medium">${item.title}</p>
                                <p class="text-sm">${item.content}</p>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-xs text-blue-600 mt-3 italic">Basado en tus datos de los √∫ltimos ${appState.moodHistory.length > 0 ? '7 d√≠as' : 'pocos d√≠as'}.</p>
                `;
                
                resultDiv.classList.remove('hidden');
                
                // Reset button
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-robot mr-2"></i>Obtener An√°lisis Personalizado';
                
                // Play success sound
                playSuccessSound();
            }, 2000);
        }

        // Generate personalized analysis
        function generatePersonalizedAnalysis() {
            const analysis = [];
            
            if (appState.moodHistory.length === 0) {
                analysis.push({
                    title: "üí≠ Bienvenida/o",
                    content: "Veo que est√°s comenzando tu camino en CalmApp. Registra tu estado de √°nimo diario para obtener an√°lisis m√°s personalizados.",
                    color: "border-blue-400"
                });
                analysis.push({
                    title: "üåü Primer Paso",
                    content: "Te recomiendo comenzar con la meditaci√≥n guiada de respiraci√≥n para establecer una rutina diaria.",
                    color: "border-green-400"
                });
                analysis.push({
                    title: "üìù Consejo Inicial",
                    content: "Intenta escribir en el diario emocional al menos 2 veces por semana para procesar tus emociones.",
                    color: "border-purple-400"
                });
                return analysis;
            }
            
            // Calculate average mood
            const avgMood = appState.moodHistory
                .slice(0, 7)
                .reduce((sum, entry) => sum + entry.intensity, 0) / 
                Math.min(appState.moodHistory.length, 7);
            
            // Mood analysis
            if (avgMood >= 7) {
                analysis.push({
                    title: "üòä Estado Positivo",
                    content: "Tu estado de √°nimo promedio es positivo. Esto indica que est√°s manejando bien el estr√©s diario.",
                    color: "border-green-400"
                });
            } else if (avgMood >= 5) {
                analysis.push({
                    title: "üòê Estado Neutral",
                    content: "Tu estado de √°nimo se mantiene en niveles promedio. Considera incorporar m√°s actividades que te generen bienestar.",
                    color: "border-yellow-400"
                });
            } else {
                analysis.push({
                    title: "üòî Estado Bajo",
                    content: "Noto que tu estado de √°nimo promedio est√° bajo. Te recomiendo practicar la meditaci√≥n para ansiedad y escribir en tu diario.",
                    color: "border-red-400"
                });
            }
            
            // Consistency analysis
            const consecutiveDays = calculateConsecutiveDays();
            if (consecutiveDays >= 7) {
                analysis.push({
                    title: "üìÖ Excelente Consistencia",
                    content: `Llevas ${consecutiveDays} d√≠as consecutivos registrando tu estado. Esta consistencia es clave para el autoconocimiento.`,
                    color: "border-blue-400"
                });
            } else if (consecutiveDays >= 3) {
                analysis.push({
                    title: "üìÖ Buena Regularidad",
                    content: `Llevas ${consecutiveDays} d√≠as consecutivos. Sigue as√≠ para establecer un h√°bito saludable.`,
                    color: "border-green-400"
                });
            }
            
            // Journal analysis
            const journalCount = appState.savedJournals.length;
            if (journalCount >= 5) {
                analysis.push({
                    title: "üìñ Diario Activo",
                    content: "Tienes varias entradas en tu diario. Esta pr√°ctica te ayuda a procesar emociones y ganar claridad.",
                    color: "border-purple-400"
                });
            } else if (journalCount > 0) {
                analysis.push({
                    title: "üìñ Comenzando el Diario",
                    content: "Has empezado a escribir en tu diario. Intenta hacerlo regularmente para mayores beneficios.",
                    color: "border-indigo-400"
                });
            }
            
            // Meditation analysis
            const meditationCount = (appState.savedMeditations ? appState.savedMeditations.length : 0);
            if (meditationCount >= 3) {
                analysis.push({
                    title: "üßò‚Äç‚ôÄÔ∏è Pr√°ctica de Meditaci√≥n",
                    content: "Has completado varias meditaciones. La pr√°ctica regular mejora la concentraci√≥n y reduce el estr√©s.",
                    color: "border-teal-400"
                });
            }
            
            // Detox recommendation
            analysis.push({
                title: "üìµ Desconexi√≥n Digital",
                content: "Basado en tu actividad, te recomiendo activar el modo desconexi√≥n al menos 2 horas al d√≠a.",
                color: "border-orange-400"
            });
            
            // General recommendation
            analysis.push({
                title: "üí° Recomendaci√≥n Personalizada",
                content: getPersonalizedRecommendation(avgMood, consecutiveDays),
                color: "border-pink-400"
            });
            
            return analysis;
        }

        // Get personalized recommendation
        function getPersonalizedRecommendation(avgMood, consecutiveDays) {
            if (avgMood < 5) {
                return "Te sugiero practicar la meditaci√≥n para ansiedad y establecer rutinas de autocuidado diarias.";
            } else if (avgMood < 7) {
                return "Incorpora m√°s actividades que disfrutes y considera establecer l√≠mites digitales saludables.";
            } else {
                return "Mant√©n tus buenos h√°bitos. Explora nuevas formas de meditaci√≥n para continuar tu crecimiento personal.";
            }
        }

        // Update detox state
        function updateDetoxState() {
            appState.detoxChecks = {
                notifications: document.getElementById('detox-notifications').checked,
                screens: document.getElementById('detox-screens').checked,
                meals: document.getElementById('detox-meals').checked
            };
            
            // Update UI for checked items
            document.querySelectorAll('.detox-checkbox').forEach(checkbox => {
                const input = checkbox.querySelector('input');
                if (input.checked) {
                    checkbox.classList.add('completed');
                } else {
                    checkbox.classList.remove('completed');
                }
            });
            
            // Save detox state
            saveUserData('detox', appState.detoxChecks);
        }

        // Update detox checkboxes from state
        function updateDetoxCheckboxes() {
            document.getElementById('detox-notifications').checked = appState.detoxChecks.notifications;
            document.getElementById('detox-screens').checked = appState.detoxChecks.screens;
            document.getElementById('detox-meals').checked = appState.detoxChecks.meals;
            
            updateDetoxState(); // This will update the UI
        }

        // Activate detox mode
        function activateDetoxMode() {
            const customCommitment = document.getElementById('detox-custom').value.trim();
            let activeCommitments = [];
            
            if (appState.detoxChecks.notifications) activeCommitments.push('Notificaciones silenciadas por 2 horas');
            if (appState.detoxChecks.screens) activeCommitments.push('Sin pantallas 1 hora antes de dormir');
            if (appState.detoxChecks.meals) activeCommitments.push('Comer sin dispositivos m√≥viles');
            if (customCommitment) activeCommitments.push(customCommitment);
            
            if (activeCommitments.length === 0) {
                document.getElementById('detox-status').textContent = '‚ö†Ô∏è Selecciona al menos un compromiso';
                document.getElementById('detox-status').style.color = '#f59e0b';
                return;
            }
            
            // Set detox timer
            const detoxEndTime = new Date(Date.now() + 2 * 60 * 60 * 1000); // 2 hours from now
            
            // Save detox session
            const detoxSession = {
                commitments: activeCommitments,
                startTime: new Date().toISOString(),
                endTime: detoxEndTime.toISOString(),
                customCommitment: customCommitment
            };
            
            saveUserData('detox_session', detoxSession);
            
            // Update UI
            document.getElementById('detox-status').innerHTML = `
                <div class="text-green-600">
                    <i class="fas fa-check-circle mr-2"></i>
                    Modo Desconexi√≥n Activado
                </div>
                <p class="text-xs mt-1">Compromisos activos: ${activeCommitments.join(', ')}</p>
                <p class="text-xs">Hasta las ${detoxEndTime.getHours()}:${detoxEndTime.getMinutes().toString().padStart(2, '0')}</p>
            `;
            
            // Clear custom commitment
            document.getElementById('detox-custom').value = '';
            
            // Play success sound
            playSuccessSound();
            
            // Reset after 5 seconds
            setTimeout(() => {
                document.getElementById('detox-status').innerHTML = '';
            }, 5000);
        }

        // Play success sound
        function playSuccessSound() {
            // Create a pleasant success sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator1 = audioContext.createOscillator();
            const oscillator2 = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator1.connect(gainNode);
            oscillator2.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator1.frequency.value = 800;
            oscillator2.frequency.value = 1200;
            oscillator1.type = 'sine';
            oscillator2.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
            
            oscillator1.start();
            oscillator2.start();
            oscillator1.stop(audioContext.currentTime + 0.8);
            oscillator2.stop(audioContext.currentTime + 0.8);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
