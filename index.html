<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalmApp - Bienestar Emocional</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4c7c7c;
            --secondary: #6ee7b7;
            --accent: #a5b4fc;
            --danger: #fda4af;
            --warning: #fcd34d;
            --success: #34d399;
            --background: #E8F4F8;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--background) 0%, #F0F9FF 100%);
            min-height: 100vh;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(76, 124, 124, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.9);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(76, 124, 124, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #5a8f8f 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 124, 124, 0.25);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #10b981 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #fbbf24 100%);
            color: #78350f;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #f87171 100%);
            color: white;
        }
        
        .mood-bar {
            height: 8px;
            border-radius: 4px;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sound-btn {
            transition: all 0.3s ease;
        }
        
        .sound-btn.active {
            background: var(--primary) !important;
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(76, 124, 124, 0.2);
        }
        
        .calendar-day {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
        }
        
        .calendar-day:hover {
            background: rgba(76, 124, 124, 0.1);
        }
        
        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }
        
        .calendar-day.has-entry {
            border: 2px solid var(--secondary);
        }
        
        .meditation-guide-text {
            font-size: 1.1rem;
            line-height: 1.6;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 15px;
            border-left: 4px solid var(--primary);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .ai-response {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: linear-gradient(135deg, #f0fdf4 0%, #f7fee7 100%);
            border-radius: 15px;
            border-left: 4px solid #10b981;
        }
        
        .ai-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
        }
        
        .user-message {
            background: rgba(76, 124, 124, 0.1);
            margin-left: 20px;
            border-left: 3px solid var(--primary);
        }
        
        .bot-message {
            background: rgba(16, 185, 129, 0.1);
            margin-right: 20px;
            border-left: 3px solid #10b981;
        }
        
        .meditation-step {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            border-left: 4px solid var(--secondary);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .step-active {
            background: linear-gradient(135deg, rgba(110, 231, 183, 0.2) 0%, rgba(76, 124, 124, 0.2) 100%);
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .click-sound {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .click-sound:active {
            transform: scale(0.95);
        }
        
        /* Breathing Balloon Styles */
        .breathing-balloon-container {
            width: 300px;
            height: 300px;
            margin: 0 auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .breathing-balloon {
            width: 150px;
            height: 200px;
            background: linear-gradient(135deg, #4c7c7c, #6ee7b7);
            border-radius: 50%;
            position: relative;
            transition: all 4s ease-in-out;
            box-shadow: 
                0 10px 30px rgba(76, 124, 124, 0.3),
                inset 0 -10px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .balloon-string {
            position: absolute;
            bottom: -40px;
            width: 2px;
            height: 40px;
            background: #666;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .balloon-knot {
            position: absolute;
            bottom: -40px;
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .breathing-balloon.inhaling {
            animation: inflate 4s ease-in-out forwards;
        }
        
        .breathing-balloon.exhaling {
            animation: deflate 4s ease-in-out forwards;
        }
        
        .breathing-balloon.holding {
            animation: pulse-hold 2s ease-in-out infinite;
        }
        
        @keyframes inflate {
            0% { 
                transform: scale(1); 
                width: 150px;
                height: 200px;
            }
            100% { 
                transform: scale(1.3); 
                width: 195px;
                height: 260px;
            }
        }
        
        @keyframes deflate {
            0% { 
                transform: scale(1.3); 
                width: 195px;
                height: 260px;
            }
            100% { 
                transform: scale(1); 
                width: 150px;
                height: 200px;
            }
        }
        
        @keyframes pulse-hold {
            0%, 100% { transform: scale(1.25); }
            50% { transform: scale(1.28); }
        }
        
        /* Cycle Counter Styles */
        .cycle-counter {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .cycle-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 80px;
        }
        
        /* Chat Styles Mejoradas */
        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc 0%, #f0f9ff 100%);
            border-radius: 15px;
            border: 1px solid #e2e8f0;
        }
        
        .chat-message {
            margin-bottom: 12px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: linear-gradient(135deg, var(--primary) 0%, #5a8f8f 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .assistant-message {
            background: white;
            color: #333;
            margin-right: auto;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 5px;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            max-width: 85%;
            margin-right: auto;
            border: 1px solid #e2e8f0;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        
        /* Voice Controls */
        .voice-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .voice-btn {
            padding: 8px 16px;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .voice-btn:hover {
            opacity: 0.9;
        }
        
        .voice-btn.active {
            background: var(--secondary);
            color: #333;
        }
        
        /* Responsive Improvements */
        @media (max-width: 768px) {
            .cycle-counter {
                position: relative;
                top: auto;
                right: auto;
                transform: none;
                margin-top: 20px;
                display: flex;
                justify-content: center;
            }
            
            .breathing-balloon-container {
                height: 350px;
            }
            
            .text-5xl, .text-6xl {
                font-size: 2.5rem;
            }
            
            .chat-message {
                max-width: 90%;
            }
        }
        
        /* Neuropsic√≥logo Styles */
        .neuro-chat {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }
        
        .neuro-message {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid #8b5cf6;
        }
        
        .technique-box {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #10b981;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .emotional-analysis {
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdfa 100%);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #a7f3d0;
        }
    </style>
</head>
<body>
    <!-- Main App Container -->
    <div id="app-container" class="min-h-screen p-4 md:p-8">
        <div id="app" class="max-w-6xl mx-auto">
            
            <!-- Header -->
            <header class="text-center mb-10">
                <div class="card glass-effect p-8 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full bg-[var(--primary)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-heart text-[var(--primary)] text-xl"></i>
                            </div>
                            <div class="text-left">
                                <!-- Espacio para logo/t√≠tulo adicional -->
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                                <i class="fas fa-brain text-[var(--primary)] mr-2"></i>
                                <span class="text-sm font-medium">Bienestar: <span id="wellness-score">85</span>/100</span>
                            </div>
                        </div>
                    </div>
                    
                    <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-[var(--primary)] to-[var(--secondary)] mb-4">
                        CalmApp üåø
                    </h1>
                    <p class="text-lg md:text-xl text-gray-700 mb-2">Tu espacio para la calma y el bienestar emocional</p>
                    <p class="text-sm text-gray-600">Cuidando tu mente, un momento a la vez</p>
                </div>
                
                <div class="flex flex-wrap justify-center gap-4 mb-8">
                    <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                        <i class="fas fa-calendar-alt text-[var(--primary)] mr-2"></i>
                        <span id="current-date" class="text-sm font-medium"></span>
                    </div>
                    <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                        <i class="fas fa-heart text-[var(--primary)] mr-2"></i>
                        <span class="text-sm font-medium">Sesi√≥n: <span id="session-time">00:00</span></span>
                    </div>
                    <div class="flex items-center bg-white/90 px-4 py-2 rounded-full shadow-sm">
                        <i class="fas fa-user text-[var(--primary)] mr-2"></i>
                        <span class="text-sm font-medium">Modo Universal</span>
                    </div>
                </div>
            </header>

            <!-- Main App Container -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Left Column: Wellness Tools -->
                <div class="space-y-6">
                    
                    <!-- Card 1: Registro de √Ånimo Diario -->
                    <div class="card p-6 border-t-4 border-[var(--accent)]">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-[var(--accent)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-heart text-[var(--accent)]"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Registro de √Ånimo Diario üíú</h2>
                        </div>
                        
                        <div class="mb-6">
                            <p class="text-gray-700 mb-3">¬øC√≥mo te sientes en este momento?</p>
                            
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="excelente">
                                    <span class="text-2xl mb-2">ü•≥</span>
                                    <span class="font-medium">Excelente</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="bien">
                                    <span class="text-2xl mb-2">üòä</span>
                                    <span class="font-medium">Bien</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="neutral">
                                    <span class="text-2xl mb-2">üòê</span>
                                    <span class="font-medium">Neutral</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="ansioso">
                                    <span class="text-2xl mb-2">üòü</span>
                                    <span class="font-medium">Ansioso</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="estresado">
                                    <span class="text-2xl mb-2">üòì</span>
                                    <span class="font-medium">Estresado</span>
                                </button>
                                <button class="mood-btn px-4 py-4 rounded-xl border transition flex flex-col items-center justify-center click-sound" data-mood="triste">
                                    <span class="text-2xl mb-2">üòî</span>
                                    <span class="font-medium">Triste</span>
                                </button>
                            </div>
                            
                            <div class="mb-4">
                                <label for="mood-intensity" class="block text-sm font-medium text-gray-700 mb-2">
                                    Intensidad: <span id="intensity-value">5</span>/10
                                </label>
                                <input type="range" id="mood-intensity" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            
                            <div class="mb-4">
                                <label for="mood-notes" class="block text-sm font-medium text-gray-700 mb-2">
                                    Notas (opcional):
                                </label>
                                <textarea id="mood-notes" rows="3" placeholder="¬øQu√© est√° influyendo en tu estado de √°nimo hoy? Ej: Buen d√≠a de trabajo, dorm√≠ bien, discusi√≥n con amigo..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"></textarea>
                            </div>
                            
                            <button id="save-mood-btn" class="btn-success w-full py-3 click-sound">
                                <i class="far fa-save mr-2"></i>
                                Guardar Registro Emocional
                            </button>
                            
                            <div id="mood-status" class="mt-3 text-center text-sm font-medium"></div>
                        </div>
                    </div>
                    
                    <!-- Card 2: Meditaci√≥n Guiada Completa -->
                    <div class="card p-6 border-t-4 border-[var(--secondary)]">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-[var(--secondary)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-headphones-alt text-[var(--secondary)]"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Meditaci√≥n Guiada üéß</h2>
                        </div>
                        
                        <p class="text-gray-700 mb-6">Selecciona el tipo de meditaci√≥n que necesitas hoy:</p>
                        
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <button class="meditation-option p-3 rounded-xl border border-gray-200 hover:border-[var(--secondary)] transition click-sound" data-theme="respiraci√≥n">
                                <i class="fas fa-wind text-[var(--primary)] mr-2"></i>
                                <span class="font-medium">Respiraci√≥n</span>
                            </button>
                            <button class="meditation-option p-3 rounded-xl border border-gray-200 hover:border-[var(--secondary)] transition click-sound" data-theme="relajaci√≥n">
                                <i class="fas fa-spa text-[var(--primary)] mr-2"></i>
                                <span class="font-medium">Relajaci√≥n</span>
                            </button>
                            <button class="meditation-option p-3 rounded-xl border border-gray-200 hover:border-[var(--secondary)] transition click-sound" data-theme="concentraci√≥n">
                                <i class="fas fa-bullseye text-[var(--primary)] mr-2"></i>
                                <span class="font-medium">Concentraci√≥n</span>
                            </button>
                            <button class="meditation-option p-3 rounded-xl border border-gray-200 hover:border-[var(--secondary)] transition click-sound" data-theme="ansiedad">
                                <i class="fas fa-heart text-[var(--primary)] mr-2"></i>
                                <span class="font-medium">Ansiedad</span>
                            </button>
                        </div>
                        
                        <!-- Control de Voz para Meditaci√≥n -->
                        <div class="voice-controls mb-4">
                            <button id="toggle-meditation-voice" class="voice-btn click-sound active">
                                <i class="fas fa-microphone mr-2"></i>
                                Voz Masculina Natural
                            </button>
                            <button id="test-meditation-voice" class="voice-btn click-sound" style="background: var(--accent);">
                                <i class="fas fa-volume-up mr-2"></i>
                                Probar Voz
                            </button>
                        </div>
                        
                        <button id="generate-meditation-btn" class="btn-primary w-full py-3 mb-4 click-sound">
                            <i class="fas fa-magic mr-2"></i>
                            Generar Meditaci√≥n Personalizada
                        </button>
                        
                        <div id="meditation-output" class="mt-6 p-4 bg-gradient-to-r from-green-50/80 to-blue-50/80 rounded-xl border border-green-200 hidden fade-in">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800" id="meditation-title"></h3>
                                <div class="flex space-x-2">
                                    <button id="start-guide-btn" class="text-sm bg-[var(--primary)] text-white px-3 py-1 rounded-lg click-sound">
                                        <i class="fas fa-play mr-1"></i> Iniciar Gu√≠a
                                    </button>
                                    <button id="pause-guide-btn" class="text-sm bg-gray-500 text-white px-3 py-1 rounded-lg click-sound hidden">
                                        <i class="fas fa-pause mr-1"></i> Pausar
                                    </button>
                                    <button id="stop-voice-btn" class="text-sm bg-red-500 text-white px-3 py-1 rounded-lg click-sound hidden">
                                        <i class="fas fa-stop mr-1"></i> Detener
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Timer de Meditaci√≥n -->
                            <div id="meditation-timer" class="meditation-timer hidden">
                                <div id="timer-display">00:00</div>
                                <div id="current-step-text" class="text-sm mt-1"></div>
                            </div>
                            
                            <div id="meditation-guide" class="meditation-guide-text mb-4">
                                <div id="guide-steps" class="space-y-3"></div>
                            </div>
                            
                            <div class="flex justify-between mt-4 pt-3 border-t border-green-200">
                                <button id="save-meditation-btn" class="text-sm text-[var(--primary)] click-sound">
                                    <i class="far fa-bookmark mr-1"></i> Guardar
                                </button>
                                <button id="restart-guide-btn" class="text-sm text-[var(--primary)] click-sound">
                                    <i class="fas fa-redo mr-1"></i> Reiniciar
                                </button>
                            </div>
                        </div>
                        
                        <div id="meditation-loading" class="mt-4 text-center hidden">
                            <div class="inline-flex items-center space-x-2 text-[var(--primary)]">
                                <div class="w-5 h-5 border-2 border-[var(--primary)] border-t-transparent rounded-full animate-spin"></div>
                                <span>Creando tu meditaci√≥n √∫nica...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 3: Diario Emocional -->
                    <div class="card p-6 border-t-4 border-[var(--accent)]">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-[var(--accent)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-book text-[var(--accent)]"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Diario Emocional üìñ</h2>
                        </div>
                        
                        <div class="mb-6">
                            <div id="journal-calendar" class="mb-4 p-3 bg-gray-50/70 rounded-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <button id="prev-month" class="p-2 hover:bg-gray-100 rounded-lg click-sound">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <h4 id="current-month" class="font-bold text-gray-700 text-sm"></h4>
                                    <button id="next-month" class="p-2 hover:bg-gray-100 rounded-lg click-sound">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <div id="calendar-days" class="grid grid-cols-7 gap-1">
                                    <!-- Calendar days will be generated here -->
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="journal-title" class="block text-sm font-medium text-gray-700 mb-2">
                                    T√≠tulo:
                                </label>
                                <input type="text" id="journal-title" placeholder="C√≥mo me siento hoy..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent">
                            </div>
                            
                            <div class="mb-4">
                                <label for="journal-entry" class="block text-sm font-medium text-gray-700 mb-2">
                                    Escribe lo que sientes:
                                </label>
                                <textarea id="journal-entry" rows="6" placeholder="Hoy me siento...\nLo que m√°s me impact√≥ hoy fue...\nEstoy agradecido por..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-[var(--accent)] focus:border-transparent"></textarea>
                            </div>
                            
                            <div class="flex items-center mb-4">
                                <input type="checkbox" id="journal-private" class="form-checkbox h-5 w-5 text-[var(--accent)] rounded">
                                <label for="journal-private" class="ml-3 text-gray-700">
                                    Esta entrada es privada
                                </label>
                            </div>
                            
                            <button id="save-journal-btn" class="btn-success w-full py-3 click-sound">
                                <i class="far fa-save mr-2"></i>
                                Guardar en mi diario
                            </button>
                            
                            <div id="journal-status" class="mt-3 text-center text-sm font-medium"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Analytics & History -->
                <div class="space-y-6">
                    
                    <!-- Card 4: Wellness Dashboard -->
                    <div class="card p-6 border-t-4 border-[var(--primary)]">
                        <div class="flex items-center mb-6">
                            <div class="w-10 h-10 rounded-full bg-[var(--primary)]/20 flex items-center justify-center mr-3">
                                <i class="fas fa-chart-line text-[var(--primary)]"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Tu Tablero de Bienestar üìä</h2>
                        </div>
                        
                        <!-- Consejo del D√≠a -->
                        <div class="daily-tip mb-6">
                            <h3 id="daily-tip-title" class="text-lg font-bold">Consejo del D√≠a üåü</h3>
                            <p id="daily-tip-content" class="text-sm">Cargando consejo del d√≠a...</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-blue-50/70 p-4 rounded-xl">
                                <div class="text-sm text-blue-600 mb-1">Estado de √Ånimo Promedio</div>
                                <div class="text-2xl font-bold text-blue-800">7.2</div>
                                <div class="text-xs text-blue-600">/10 esta semana</div>
                            </div>
                            
                            <div class="bg-green-50/70 p-4 rounded-xl">
                                <div class="text-sm text-green-600 mb-1">D√≠as Consecutivos</div>
                                <div class="text-2xl font-bold text-green-800">14</div>
                                <div class="text-xs text-green-600">registrando tu estado</div>
                            </div>
                            
                            <div class="bg-purple-50/70 p-4 rounded-xl">
                                <div class="text-sm text-purple-600 mb-1">Meditaciones Completadas</div>
                                <div class="text-2xl font-bold text-purple-800">8</div>
                                <div class="text-xs text-purple-600">esta semana</div>
                            </div>
                            
                            <div class="bg-yellow-50/70 p-4 rounded-xl">
                                <div class="text-sm text-yellow-600 mb-1">Entradas Diario</div>
                                <div class="text-2xl font-bold text-yellow-800">5</div>
                                <div class="text-xs text-yellow-600">esta semana</div>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="font-bold text-gray-700 mb-3">Distribuci√≥n de Estados de √Ånimo</h3>
                            <div id="mood-chart" class="space-y-3">
                                <!-- Mood bars will be generated here -->
                            </div>
                        </div>
                        
                        <!-- AI Analysis Section -->
                        <div class="ai-analysis-box">
                            <h3 class="font-bold text-blue-800 mb-3">An√°lisis con IA üß†</h3>
                            <p class="text-sm text-blue-700 mb-3">Obt√©n insights personalizados sobre tu bienestar emocional basados en tus datos.</p>
                            <button id="ai-analysis-btn" class="btn-primary w-full py-2 click-sound">
                                <i class="fas fa-robot mr-2"></i>
                                Obtener An√°lisis Personalizado
                            </button>
                            <div id="ai-analysis-result" class="mt-3 p-3 bg-white/80 rounded-lg text-sm hidden">
                                <!-- AI analysis will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card 5: Desconexi√≥n Digital -->
                    <div class="card p-6 border-t-4 border-red-400">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mr-3">
                                <i class="fas fa-mobile-alt text-red-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Desconexi√≥n Digital üìµ</h2>
                        </div>
                        
                        <p class="text-gray-700 mb-6">Establece l√≠mites saludables con la tecnolog√≠a para mejorar tu bienestar mental.</p>
                        
                        <div class="mb-4">
                            <h4 class="font-bold text-gray-700 mb-3">Mi plan de desconexi√≥n:</h4>
                            
                            <div class="detox-checkbox">
                                <input type="checkbox" id="detox-notifications" class="detox-check">
                                <label for="detox-notifications" class="font-medium">Silenciar notificaciones no esenciales por 2 horas</label>
                            </div>
                            
                            <div class="detox-checkbox">
                                <input type="checkbox" id="detox-screens" class="detox-check">
                                <label for="detox-screens" class="font-medium">Sin pantallas 1 hora antes de dormir</label>
                            </div>
                            
                            <div class="detox-checkbox">
                                <input type="checkbox" id="detox-meals" class="detox-check">
                                <label for="detox-meals" class="font-medium">Comer sin dispositivos m√≥viles</label>
                            </div>
                            
                            <div class="mb-4">
                                <label for="detox-custom" class="block text-sm font-medium text-gray-700 mb-2 mt-4">
                                    Mi compromiso personalizado:
                                </label>
                                <textarea id="detox-custom" rows="2" placeholder="Ej: Leer un libro en lugar de revisar redes sociales" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-400 focus:border-transparent"></textarea>
                            </div>
                            
                            <button id="activate-detox-btn" class="btn-primary w-full py-3 bg-gradient-to-r from-red-500 to-orange-500 click-sound">
                                <i class="fas fa-power-off mr-2"></i>
                                Activar Modo Desconexi√≥n
                            </button>
                            
                            <div id="detox-status" class="mt-3 text-center text-sm font-medium"></div>
                        </div>
                    </div>
                    
                    <!-- Card 6: Respira conmigo (Wim Hof) con Globo -->
                    <div class="card p-6 border-t-4 border-blue-400">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                <i class="fas fa-lungs text-blue-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Respira conmigo üå¨Ô∏è</h2>
                        </div>
                        
                        <p class="text-gray-700 mb-6">M√©todo Wim Hof: 30 respiraciones profundas + retenci√≥n</p>
                        
                        <!-- Control de Voz para Respiraci√≥n -->
                        <div class="voice-controls mb-4">
                            <button id="toggle-breathing-voice" class="voice-btn click-sound active">
                                <i class="fas fa-microphone mr-2"></i>
                                Voz de Wim Hof Activada
                            </button>
                            <button id="test-breathing-voice" class="voice-btn click-sound" style="background: var(--accent);">
                                <i class="fas fa-volume-up mr-2"></i>
                                Probar Voz
                            </button>
                        </div>
                        
                        <div class="breathing-balloon-container">
                            <div class="breathing-balloon" id="breathing-balloon">
                                <div class="balloon-string"></div>
                                <div class="balloon-knot"></div>
                                <div class="text-white text-center">
                                    <div id="breath-phase" class="text-2xl font-bold mb-2">LISTO</div>
                                    <div id="breath-timer" class="text-4xl font-bold">--</div>
                                </div>
                            </div>
                            
                            <!-- Contador de ciclo al costado derecho -->
                            <div class="cycle-counter">
                                <div class="cycle-box">
                                    <div class="text-xs text-gray-600 mb-1">Ciclo</div>
                                    <div id="breath-cycle" class="text-2xl font-bold text-[var(--primary)]">0</div>
                                    <div class="text-xs text-gray-500">/30</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-center space-x-4 mb-6 mt-12">
                            <button id="start-breathing" class="btn-primary px-6 py-2 click-sound">
                                <i class="fas fa-play mr-2"></i> Comenzar
                            </button>
                            <button id="stop-breathing" class="px-6 py-2 border border-gray-300 rounded-lg click-sound">
                                <i class="fas fa-stop mr-2"></i> Detener
                            </button>
                            <button id="reset-breathing" class="px-6 py-2 border border-gray-300 rounded-lg click-sound">
                                <i class="fas fa-redo mr-2"></i> Reiniciar
                            </button>
                        </div>
                        
                        <div class="bg-blue-50/70 p-4 rounded-xl">
                            <h4 class="font-bold text-blue-800 mb-2">Instrucciones:</h4>
                            <ol class="text-sm text-blue-700 list-decimal pl-4 space-y-1">
                                <li><strong>INHALA</strong> profundamente (4 segundos) - El globo se inflar√°</li>
                                <li><strong>EXHALA</strong> suavemente (4 segundos) - El globo se desinflar√°</li>
                                <li>Repite 30 veces</li>
                                <li>Ret√©n la respiraci√≥n (1 minuto)</li>
                                <li>Inhala profundamente y mant√©n 15 segundos</li>
                            </ol>
                            <p class="text-xs text-blue-600 mt-2">*Observa c√≥mo el globo se coordina con tu respiraci√≥n</p>
                        </div>
                    </div>
                    
                    <!-- Card 7: Conversemos hoy CON IA MEJORADA -->
                    <div class="card p-6 border-t-4 border-teal-400">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full bg-teal-100 flex items-center justify-center mr-3">
                                <i class="fas fa-comments text-teal-600"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-800">Conversemos hoy üí¨</h2>
                        </div>
                        
                        <p class="text-gray-700 mb-6">Cu√©ntame c√≥mo te sientes. Estoy aqu√≠ para escucharte con comprensi√≥n y empat√≠a.</p>
                        
                        <!-- Chat Container Mejorado -->
                        <div class="chat-container neuro-chat mb-4" id="chat-container">
                            <div class="chat-message assistant-message neuro-message">
                                <strong>Asistente IA:</strong> ¬°Hola! üëã Soy tu asistente de bienestar emocional. Estoy aqu√≠ para escucharte, entenderte y acompa√±arte en tu d√≠a. Puedes contarme c√≥mo te sientes, qu√© te preocupa, qu√© te gusta hacer, o simplemente conversar. ¬øC√≥mo te sientes hoy?
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="user-message" class="block text-sm font-medium text-gray-700 mb-2">
                                Escribe tu mensaje:
                            </label>
                            <textarea id="user-message" rows="3" placeholder="Cu√©ntame c√≥mo te sientes, qu√© te preocupa, qu√© te gusta hacer, o qu√© te hace feliz..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-400 focus:border-transparent"></textarea>
                        </div>
                        
                        <div class="flex justify-between">
                            <button id="send-message-btn" class="btn-primary px-6 py-3 click-sound">
                                <i class="fas fa-paper-plane mr-2"></i>
                                Enviar
                            </button>
                            <button id="clear-chat-btn" class="px-4 py-3 border border-gray-300 rounded-lg click-sound">
                                <i class="fas fa-trash-alt mr-2"></i>
                                Limpiar
                            </button>
                        </div>
                        
                        <div id="ai-loading" class="mt-4 text-center hidden">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <span class="ml-2 text-gray-600">Asistente est√° pensando...</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-xs text-gray-500">
                            <i class="fas fa-lightbulb mr-1"></i> 
                            <span id="chat-model-info">Chat inteligente con an√°lisis emocional</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <footer class="mt-10 pt-6 border-t border-gray-300 text-center">
                <p class="text-gray-700">CalmApp - Cuidando tu bienestar emocional, un d√≠a a la vez <span class="text-red-500">‚ô•</span></p>
                <p class="text-sm text-gray-600 mt-2">Aplicaci√≥n de uso universal sin fines de lucro - Tu bienestar es lo m√°s importante</p>
            </footer>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // App State
        const appState = {
            currentUser: { name: "Usuario", email: "bienestar@calmapp.com" },
            currentMood: 'neutral',
            moodIntensity: 5,
            meditationTheme: 'respiraci√≥n',
            breathingActive: false,
            breathPhase: 'ready',
            breathCount: 0,
            maxBreaths: 30,
            currentJournalDate: new Date(),
            savedJournals: [],
            moodHistory: [],
            meditationGuideActive: false,
            currentStep: 0,
            meditationSteps: [],
            chatHistory: [
                {
                    role: 'assistant',
                    content: '¬°Hola! üëã Soy tu asistente de bienestar emocional. Estoy aqu√≠ para escucharte, entenderte y acompa√±arte en tu d√≠a. Puedes contarme c√≥mo te sientes, qu√© te preocupa, qu√© te gusta hacer, o simplemente conversar. ¬øC√≥mo te sientes hoy?'
                }
            ],
            ttsActive: false,
            ttsVoice: null,
            sessionStartTime: null,
            sessionTimer: null,
            detoxChecks: {
                notifications: false,
                screens: false,
                meals: false
            },
            meditationTimer: null,
            meditationStartTime: null,
            currentMeditationDuration: 0,
            stepStartTime: null,
            stepRemainingTime: 0,
            savedMeditations: [],
            breathingVoiceEnabled: true,
            meditationVoiceEnabled: true,
            wimHofVoice: null,
            meditationMaleVoice: null
        };

        // Mood Configuration with colors
        const moodConfig = {
            excelente: { color: '#10b981', bgColor: '#d1fae5', emoji: 'ü•≥', name: 'Excelente' },
            bien: { color: '#34d399', bgColor: '#a7f3d0', emoji: 'üòä', name: 'Bien' },
            neutral: { color: '#9ca3af', bgColor: '#f3f4f6', emoji: 'üòê', name: 'Neutral' },
            ansioso: { color: '#fbbf24', bgColor: '#fef3c7', emoji: 'üòü', name: 'Ansioso' },
            estresado: { color: '#f97316', bgColor: '#ffedd5', emoji: 'üòì', name: 'Estresado' },
            triste: { color: '#3b82f6', bgColor: '#dbeafe', emoji: 'üòî', name: 'Triste' }
        };

        // Daily Tips Database
        const dailyTips = [
            "Hoy, dedica 5 minutos a observar tu respiraci√≥n sin intentar cambiarla. Solo observa.",
            "Escribe tres cosas por las que est√°s agradecido. La gratitud transforma nuestra perspectiva.",
            "T√≥mate un descanso de 10 minutos sin pantallas. Mira por la ventana o cierra los ojos.",
            "Haz una pausa consciente antes de cada comida: agradece el alimento que nutrir√° tu cuerpo.",
            "Env√≠ale un mensaje amable a alguien que aprecias. La conexi√≥n es esencial para el bienestar.",
            "Camina durante 15 minutos, prestando atenci√≥n a los sonidos y sensaciones alrededor.",
            "Hoy, practica la autocompasi√≥n: habla contigo mismo como lo har√≠as con un buen amigo.",
            "Dedica tiempo a una actividad que te haga perder la noci√≥n del tiempo (flow state).",
            "Antes de dormir, recuerda un momento positivo del d√≠a. Los peque√±os detalles importan.",
            "Establece una intenci√≥n para el d√≠a: ¬øc√≥mo quieres sentirte? ¬øqu√© actitud cultivar?",
            "Escucha m√∫sica que te eleve el √°nimo y baila como si nadie te viera.",
            "Lee algo inspirador por 10 minutos. Alimenta tu mente con pensamientos positivos.",
            "Hoy, s√© consciente de tu postura corporal. Si√©ntate o p√°rate con dignidad y presencia.",
            "T√≥mate un t√© o infusi√≥n lentamente, saboreando cada sorbo.",
            "Dedica 5 minutos a estirar tu cuerpo suavemente, escuchando sus necesidades.",
            "Hoy, s√© curioso en lugar de cr√≠tico contigo mismo. Observa sin juzgar.",
            "Practica el 'no hacer' durante 15 minutos. Simplemente s√©, sin productividad.",
            "Sonr√≠e aunque no tengas ganas. La sonrisa puede cambiar tu estado emocional.",
            "Observa los pensamientos que pasan por tu mente como nubes en el cielo, sin aferrarte a ellos.",
            "Hoy, prioriza una tarea importante y dale tu atenci√≥n plena.",
            "Date permiso para sentir lo que sientes, sin etiquetarlo como 'bueno' o 'malo'.",
            "Encuentra belleza en algo ordinario: una hoja, un rayo de luz, un color.",
            "Recuerda que las emociones son temporales. Esto tambi√©n pasar√°.",
            "Haz algo creativo, aunque sea peque√±o: dibuja, escribe, cocina con atenci√≥n.",
            "Practica decir 'no' a algo que no te beneficia. Los l√≠mites son amor propio.",
            "Date un ba√±o o ducha consciente, sintiendo el agua en tu piel.",
            "Hoy, elige una palabra que te gu√≠e: paz, calma, presencia, amor.",
            "Revisa tus logros de la semana, por peque√±os que sean.",
            "Abre una ventana y respira aire fresco profundamente.",
            "Apaga las notificaciones no esenciales por una hora. Disfruta el silencio digital.",
            "Hoy, s√© tu propio mejor amigo. Tr√°tate con la bondad que mereces."
        ];

        // Breathing sounds
        const inhaleSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-single-breath-inhale-1001.mp3');
        const exhaleSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-human-sigh-relief-1003.mp3');
        const clickSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3');

        // Speech synthesis for TTS
        let speechSynthesis = window.speechSynthesis;
        let voices = [];
        let currentSpeech = null;
        let wimHofSpeech = null;
        let meditationSpeech = null;

        // Initialize App
        function initApp() {
            // App starts directly without login
            initAppAfterLogin();
        }

        // Initialize app after login
        function initAppAfterLogin() {
            // Set current date
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('es-ES', options);
            
            // Start session timer
            startSessionTimer();
            
            // Load user data
            loadUserData();
            
            // Set initial mood button as active
            setActiveMood('neutral');
            
            // Set initial meditation theme
            setActiveMeditationTheme('respiraci√≥n');
            
            // Initialize calendar
            initJournalCalendar();
            
            // Load TTS voices
            loadTTSVoices();
            
            // Setup event listeners
            setupAppEventListeners();
            
            // Update dashboard
            updateDashboard();
            
            // Show daily tip
            showDailyTip();
            
            console.log('CalmApp iniciada correctamente - Modo Universal');
        }

        // Start session timer
        function startSessionTimer() {
            appState.sessionStartTime = new Date();
            
            appState.sessionTimer = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - appState.sessionStartTime) / 1000);
                const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                document.getElementById('session-time').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        // Load user data from localStorage
        function loadUserData() {
            try {
                const savedMoods = localStorage.getItem('calmapp_moods');
                const savedMeditations = localStorage.getItem('calmapp_meditations');
                const savedJournals = localStorage.getItem('calmapp_journals');
                const savedChat = localStorage.getItem('calmapp_chat');
                const savedDetox = localStorage.getItem('calmapp_detox');
                
                if (savedMoods) {
                    appState.moodHistory = JSON.parse(savedMoods);
                }
                
                if (savedMeditations) {
                    appState.savedMeditations = JSON.parse(savedMeditations);
                }
                
                if (savedJournals) {
                    appState.savedJournals = JSON.parse(savedJournals);
                }
                
                if (savedChat) {
                    appState.chatHistory = JSON.parse(savedChat);
                    updateChatDisplay();
                }
                
                if (savedDetox) {
                    appState.detoxChecks = JSON.parse(savedDetox);
                    updateDetoxCheckboxes();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Save user data to localStorage
        function saveUserData(key, data) {
            localStorage.setItem(`calmapp_${key}`, JSON.stringify(data));
        }

        // Load TTS voices with male voice
        function loadTTSVoices() {
            voices = speechSynthesis.getVoices();
            
            // Find male voice for meditation and Wim Hof
            const maleVoices = [
                'Microsoft Pablo Desktop - Spanish (Spain)',
                'Google espa√±ol (Spain)',
                'Spanish Male',
                'es-ES-Standard-B',
                'es-MX-Standard-B'
            ];
            
            // Try to find preferred male voice
            for (const preferred of maleVoices) {
                const voice = voices.find(v => v.name.includes(preferred));
                if (voice) {
                    appState.meditationMaleVoice = voice;
                    appState.wimHofVoice = voice;
                    console.log('Voz masculina seleccionada:', voice.name);
                    break;
                }
            }
            
            // Fallbacks
            if (!appState.meditationMaleVoice) {
                appState.meditationMaleVoice = voices.find(voice => 
                    voice.lang.includes('es') && 
                    (voice.name.toLowerCase().includes('male') || voice.name.toLowerCase().includes('hombre'))
                ) || voices.find(voice => voice.lang.includes('es')) || voices[0];
            }
            
            if (!appState.wimHofVoice) {
                appState.wimHofVoice = voices.find(voice => 
                    voice.lang.includes('es') && 
                    (voice.name.toLowerCase().includes('male') || voice.name.toLowerCase().includes('hombre'))
                ) || voices.find(voice => voice.lang.includes('es')) || voices[0];
            }
            
            if (voices.length === 0) {
                speechSynthesis.onvoiceschanged = () => {
                    voices = speechSynthesis.getVoices();
                    loadTTSVoices();
                };
            }
        }

        // Speak text with Wim Hof style voice
        function speakWimHof(text) {
            if (!appState.breathingVoiceEnabled) return;
            
            if (wimHofSpeech) {
                speechSynthesis.cancel(wimHofSpeech);
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (appState.wimHofVoice) {
                utterance.voice = appState.wimHofVoice;
            }
            
            utterance.lang = 'es-ES';
            utterance.rate = 0.8;
            utterance.pitch = 0.9;
            utterance.volume = 1;
            
            wimHofSpeech = utterance;
            speechSynthesis.speak(utterance);
        }

        // Speak text with meditation male voice
        function speakMeditation(text) {
            if (!appState.meditationVoiceEnabled) return;
            
            if (meditationSpeech) {
                speechSynthesis.cancel(meditationSpeech);
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (appState.meditationMaleVoice) {
                utterance.voice = appState.meditationMaleVoice;
            }
            
            utterance.lang = 'es-ES';
            utterance.rate = 0.85;
            utterance.pitch = 0.9;
            utterance.volume = 1;
            
            meditationSpeech = utterance;
            speechSynthesis.speak(utterance);
        }

        // Stop all TTS
        function stopAllTTS() {
            speechSynthesis.cancel();
            currentSpeech = null;
            wimHofSpeech = null;
            meditationSpeech = null;
            appState.ttsActive = false;
            document.getElementById('stop-voice-btn').classList.add('hidden');
        }

        // Play click sound
        function playClickSound() {
            if (clickSound) {
                clickSound.currentTime = 0;
                clickSound.play();
            }
        }

        // Initialize journal calendar
        function initJournalCalendar() {
            updateCalendarDisplay();
            
            // Set up calendar navigation
            document.getElementById('prev-month').addEventListener('click', () => {
                appState.currentJournalDate.setMonth(appState.currentJournalDate.getMonth() - 1);
                updateCalendarDisplay();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                appState.currentJournalDate.setMonth(appState.currentJournalDate.getMonth() + 1);
                updateCalendarDisplay();
            });
        }

        // Setup app event listeners
        function setupAppEventListeners() {
            // Mood buttons
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    playClickSound();
                    const mood = this.getAttribute('data-mood');
                    setActiveMood(mood);
                });
            });
            
            // Mood intensity slider
            const intensitySlider = document.getElementById('mood-intensity');
            const intensityValue = document.getElementById('intensity-value');
            intensitySlider.addEventListener('input', function() {
                intensityValue.textContent = this.value;
                appState.moodIntensity = parseInt(this.value);
            });
            
            // Save mood button
            document.getElementById('save-mood-btn').addEventListener('click', () => {
                playClickSound();
                saveMoodEntry();
            });
            
            // Meditation options
            document.querySelectorAll('.meditation-option').forEach(option => {
                option.addEventListener('click', function() {
                    playClickSound();
                    const theme = this.getAttribute('data-theme');
                    setActiveMeditationTheme(theme);
                });
            });
            
            // Generate meditation button
            document.getElementById('generate-meditation-btn').addEventListener('click', () => {
                playClickSound();
                generateMeditation();
            });
            
            // Meditation guide buttons
            document.getElementById('start-guide-btn').addEventListener('click', () => {
                playClickSound();
                startMeditationGuide();
            });
            document.getElementById('pause-guide-btn').addEventListener('click', () => {
                playClickSound();
                pauseMeditationGuide();
            });
            document.getElementById('stop-voice-btn').addEventListener('click', () => {
                playClickSound();
                stopAllTTS();
            });
            document.getElementById('restart-guide-btn').addEventListener('click', () => {
                playClickSound();
                restartMeditationGuide();
            });
            
            // Voice control buttons
            document.getElementById('toggle-breathing-voice').addEventListener('click', () => {
                playClickSound();
                appState.breathingVoiceEnabled = !appState.breathingVoiceEnabled;
                const btn = document.getElementById('toggle-breathing-voice');
                if (appState.breathingVoiceEnabled) {
                    btn.innerHTML = '<i class="fas fa-microphone mr-2"></i> Voz de Wim Hof Activada';
                    btn.classList.add('active');
                } else {
                    btn.innerHTML = '<i class="fas fa-microphone-slash mr-2"></i> Voz de Wim Hof Desactivada';
                    btn.classList.remove('active');
                }
            });
            
            document.getElementById('test-breathing-voice').addEventListener('click', () => {
                playClickSound();
                testWimHofVoice();
            });
            
            document.getElementById('toggle-meditation-voice').addEventListener('click', () => {
                playClickSound();
                appState.meditationVoiceEnabled = !appState.meditationVoiceEnabled;
                const btn = document.getElementById('toggle-meditation-voice');
                if (appState.meditationVoiceEnabled) {
                    btn.innerHTML = '<i class="fas fa-microphone mr-2"></i> Voz Masculina Natural';
                    btn.classList.add('active');
                } else {
                    btn.innerHTML = '<i class="fas fa-microphone-slash mr-2"></i> Voz Desactivada';
                    btn.classList.remove('active');
                }
            });
            
            document.getElementById('test-meditation-voice').addEventListener('click', () => {
                playClickSound();
                testMeditationVoice();
            });
            
            // Save meditation button
            document.getElementById('save-meditation-btn')?.addEventListener('click', () => {
                playClickSound();
                saveMeditation();
            });
            
            // Breathing buttons
            document.getElementById('start-breathing').addEventListener('click', () => {
                playClickSound();
                startBreathing();
            });
            document.getElementById('stop-breathing').addEventListener('click', () => {
                playClickSound();
                stopBreathing();
            });
            document.getElementById('reset-breathing').addEventListener('click', () => {
                playClickSound();
                resetBreathing();
            });
            
            // Save journal button
            document.getElementById('save-journal-btn').addEventListener('click', () => {
                playClickSound();
                saveJournalEntry();
            });
            
            // Chat buttons
            document.getElementById('send-message-btn').addEventListener('click', () => {
                playClickSound();
                sendMessage();
            });
            
            document.getElementById('clear-chat-btn').addEventListener('click', () => {
                playClickSound();
                clearChat();
            });
            
            // AI Analysis button
            document.getElementById('ai-analysis-btn').addEventListener('click', () => {
                playClickSound();
                generateAIAnalysis();
            });
            
            // Detox checkboxes
            document.querySelectorAll('.detox-check').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateDetoxState();
                });
            });
            
            // Activate detox button
            document.getElementById('activate-detox-btn').addEventListener('click', () => {
                playClickSound();
                activateDetoxMode();
            });
            
            // Enter key for chat
            document.getElementById('user-message').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('send-message-btn').click();
                }
            });
        }

        // Test Wim Hof voice
        function testWimHofVoice() {
            const testTexts = [
                "Inhala profundamente",
                "Exhala suavemente",
                "Mant√©n la respiraci√≥n",
                "Libera todo el aire"
            ];
            
            const randomText = testTexts[Math.floor(Math.random() * testTexts.length)];
            speakWimHof(randomText);
        }

        // Test meditation voice
        function testMeditationVoice() {
            const testTexts = [
                "Bienvenido a esta meditaci√≥n guiada",
                "Encuentra una posici√≥n c√≥moda",
                "Cierra suavemente los ojos",
                "Observa tu respiraci√≥n"
            ];
            
            const randomText = testTexts[Math.floor(Math.random() * testTexts.length)];
            speakMeditation(randomText);
        }

        // Set active mood with colors
        function setActiveMood(mood) {
            appState.currentMood = mood;
            const config = moodConfig[mood];
            
            if (!config) return;
            
            // Update UI for all mood buttons
            document.querySelectorAll('.mood-btn').forEach(btn => {
                const btnMood = btn.getAttribute('data-mood');
                const btnConfig = moodConfig[btnMood];
                
                if (btnMood === mood) {
                    // Active state
                    btn.style.backgroundColor = config.bgColor;
                    btn.style.borderColor = config.color;
                    btn.style.color = config.color;
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = `0 4px 12px ${config.color}40`;
                } else {
                    // Inactive state
                    btn.style.backgroundColor = '';
                    btn.style.borderColor = '#e5e7eb';
                    btn.style.color = '#374151';
                    btn.style.transform = '';
                    btn.style.boxShadow = '';
                }
            });
        }

        // Set active meditation theme
        function setActiveMeditationTheme(theme) {
            appState.meditationTheme = theme;
            
            // Update UI
            document.querySelectorAll('.meditation-option').forEach(option => {
                if (option.getAttribute('data-theme') === theme) {
                    option.style.borderColor = 'var(--secondary)';
                    option.style.backgroundColor = 'rgba(110, 231, 183, 0.1)';
                } else {
                    option.style.borderColor = '#e5e7eb';
                    option.style.backgroundColor = '';
                }
            });
        }

        // Generate meditation with guided steps
        function generateMeditation() {
            const btn = document.getElementById('generate-meditation-btn');
            const loading = document.getElementById('meditation-loading');
            const output = document.getElementById('meditation-output');
            const guideSteps = document.getElementById('guide-steps');
            const titleElement = document.getElementById('meditation-title');
            
            // Show loading state
            btn.disabled = true;
            loading.classList.remove('hidden');
            output.classList.add('hidden');
            
            // Get meditation theme
            const theme = appState.meditationTheme;
            
            // Simulate AI generation delay
            setTimeout(() => {
                // Generate meditation steps based on theme
                appState.meditationSteps = generateMeditationSteps(theme);
                
                // Display steps
                guideSteps.innerHTML = '';
                appState.meditationSteps.forEach((step, index) => {
                    const stepElement = document.createElement('div');
                    stepElement.className = 'meditation-step';
                    stepElement.id = `step-${index}`;
                    stepElement.innerHTML = `
                        <div class="flex items-start">
                            <div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center mr-3 mt-1">
                                <span class="text-xs font-bold">${index + 1}</span>
                            </div>
                            <div>
                                <p>${step.text}</p>
                                ${step.duration ? `<p class="text-sm text-gray-500 mt-1"><i class="far fa-clock mr-1"></i>${step.duration}</p>` : ''}
                            </div>
                        </div>
                    `;
                    guideSteps.appendChild(stepElement);
                });
                
                // Set title
                const themeTitles = {
                    'respiraci√≥n': 'Meditaci√≥n de Respiraci√≥n Consciente',
                    'relajaci√≥n': 'Relajaci√≥n Profunda con Ondas',
                    'concentraci√≥n': 'Meditaci√≥n para el Enfoque Mental',
                    'ansiedad': 'Calma para la Ansiedad'
                };
                titleElement.textContent = themeTitles[theme] || 'Meditaci√≥n Guiada';
                
                // Update UI
                loading.classList.add('hidden');
                output.classList.remove('hidden');
                btn.disabled = false;
                
                // Reset guide state
                appState.meditationGuideActive = false;
                appState.currentStep = 0;
                document.getElementById('start-guide-btn').classList.remove('hidden');
                document.getElementById('pause-guide-btn').classList.add('hidden');
                document.getElementById('stop-voice-btn').classList.add('hidden');
                document.getElementById('meditation-timer').classList.add('hidden');
                
                // Play success sound
                playSuccessSound();
            }, 1500);
        }

        // Generate meditation steps based on theme
        function generateMeditationSteps(theme) {
            const steps = [];
            
            switch(theme) {
                case 'respiraci√≥n':
                    steps.push(
                        { 
                            text: 'Comienza encontrando una posici√≥n c√≥moda, ya sea sentado o acostado. Cierra suavemente los ojos y lleva tu atenci√≥n a este momento presente.', 
                            duration: '1 minuto'
                        },
                        { 
                            text: 'INHALA profundamente por la nariz durante 4 segundos. Siente c√≥mo el aire llena tus pulmones.', 
                            duration: '4 segundos'
                        },
                        { 
                            text: 'EXHALA lentamente por la boca durante 8 segundos. Libera cualquier tensi√≥n o preocupaci√≥n.', 
                            duration: '8 segundos'
                        },
                        { 
                            text: 'Repite este ciclo de respiraci√≥n durante 3 minutos. Con cada exhalaci√≥n, imagina que liberas estr√©s.', 
                            duration: '3 minutos'
                        },
                        { 
                            text: 'Vuelve a tu respiraci√≥n natural. Observa c√≥mo te sientes ahora, m√°s calmado y centrado.', 
                            duration: '1 minuto'
                        }
                    );
                    break;
                    
                case 'relajaci√≥n':
                    steps.push(
                        { 
                            text: 'Si√©ntate o acu√©state en una posici√≥n c√≥moda. Cierra los ojos y comienza a relajarte.', 
                            duration: '1 minuto'
                        },
                        { 
                            text: 'Imagina que est√°s en una playa tranquila al atardecer. Escucha el sonido suave de las olas.', 
                            duration: '2 minutos'
                        },
                        { 
                            text: 'Siente la brisa suave en tu piel. Nota la calma que te rodea. Con cada respiraci√≥n, te sientes m√°s relajado.', 
                            duration: '2 minutos'
                        },
                        { 
                            text: 'Permanece en este estado de paz. No hay nada que hacer, solo ser.', 
                            duration: '2 minutos'
                        }
                    );
                    break;
                    
                case 'concentraci√≥n':
                    steps.push(
                        { 
                            text: 'Si√©ntate con la espalda recta pero relajada. Fija tu mirada suavemente en un punto frente a ti.', 
                            duration: '30 segundos'
                        },
                        { 
                            text: 'Comienza a contar tus respiraciones. Inhala... cuenta 1... exhala... cuenta 2... Contin√∫a as√≠.', 
                            duration: '2 minutos'
                        },
                        { 
                            text: 'Si tu mente divaga, amablemente regresa a contar las respiraciones. Sin juicios, solo regresa al conteo.', 
                            duration: '2 minutos'
                        },
                        { 
                            text: 'Para finalizar, deja de contar y simplemente observa tu respiraci√≥n. Nota la claridad mental.', 
                            duration: '1 minuto'
                        }
                    );
                    break;
                    
                case 'ansiedad':
                    steps.push(
                        { 
                            text: 'Reconoce la ansiedad sin luchar contra ella. Di mentalmente: "Estoy sintiendo ansiedad, y est√° bien".', 
                            duration: '1 minuto'
                        },
                        { 
                            text: 'Observa d√≥nde sientes la ansiedad en tu cuerpo. Solo observa sin juzgar.', 
                            duration: '1 minuto'
                        },
                        { 
                            text: 'Coloca ambas manos sobre tu coraz√≥n. Siente el calor de tus manos y el latido de tu coraz√≥n.', 
                            duration: '1 minuto'
                        },
                        { 
                            text: 'Con cada exhalaci√≥n, env√≠a compasi√≥n a esa parte de ti que siente ansiedad.', 
                            duration: '2 minutos'
                        }
                    );
                    break;
                    
                default:
                    steps.push(
                        { 
                            text: 'Comencemos nuestra meditaci√≥n. Encuentra una posici√≥n c√≥moda y cierra los ojos.', 
                            duration: '30 segundos'
                        },
                        { 
                            text: 'Observa tu respiraci√≥n natural sin intentar cambiarla. Solo s√© testigo de c√≥mo tu cuerpo respira.', 
                            duration: '2 minutos'
                        },
                        { 
                            text: 'Si tu mente divaga, amablemente regresa a la respiraci√≥n. Este es el coraz√≥n de la pr√°ctica.', 
                            duration: '2 minutos'
                        },
                        { 
                            text: 'Permanece en este estado de presencia consciente.', 
                            duration: '1 minuto'
                        }
                    );
            }
            
            return steps;
        }

        // Start meditation guide
        function startMeditationGuide() {
            if (appState.meditationSteps.length === 0) return;
            
            appState.meditationGuideActive = true;
            appState.currentStep = 0;
            appState.meditationStartTime = new Date();
            
            document.getElementById('start-guide-btn').classList.add('hidden');
            document.getElementById('pause-guide-btn').classList.remove('hidden');
            document.getElementById('meditation-timer').classList.remove('hidden');
            
            // Start guiding through steps
            guideNextStep();
        }

        // Pause meditation guide
        function pauseMeditationGuide() {
            appState.meditationGuideActive = false;
            
            document.getElementById('start-guide-btn').classList.remove('hidden');
            document.getElementById('pause-guide-btn').classList.add('hidden');
            
            // Stop TTS
            stopAllTTS();
            
            // Clear any active timeouts
            if (appState.guideTimeout) {
                clearTimeout(appState.guideTimeout);
            }
            if (appState.meditationTimer) {
                clearInterval(appState.meditationTimer);
            }
            if (appState.stepTimer) {
                clearInterval(appState.stepTimer);
            }
        }

        // Restart meditation guide
        function restartMeditationGuide() {
            pauseMeditationGuide();
            
            // Reset steps highlighting
            document.querySelectorAll('.meditation-step').forEach(step => {
                step.classList.remove('step-active');
            });
            
            appState.currentStep = 0;
            document.getElementById('timer-display').textContent = '00:00';
            document.getElementById('current-step-text').textContent = '';
            document.getElementById('meditation-timer').classList.add('hidden');
            
            // Start again
            setTimeout(() => {
                startMeditationGuide();
            }, 500);
        }

        // Guide through meditation steps
        function guideNextStep() {
            if (!appState.meditationGuideActive || appState.currentStep >= appState.meditationSteps.length) {
                // Meditation complete
                completeMeditation();
                return;
            }
            
            // Highlight current step
            document.querySelectorAll('.meditation-step').forEach(step => {
                step.classList.remove('step-active');
            });
            
            const currentStepElement = document.getElementById(`step-${appState.currentStep}`);
            if (currentStepElement) {
                currentStepElement.classList.add('step-active');
                currentStepElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Get current step
            const step = appState.meditationSteps[appState.currentStep];
            const stepDuration = parseDurationToSeconds(step.duration);
            
            // Update timer display
            document.getElementById('current-step-text').textContent = `Paso ${appState.currentStep + 1} de ${appState.meditationSteps.length}`;
            
            // Speak the step using male voice
            speakMeditation(step.text);
            
            // Start step timer
            startStepTimer(stepDuration);
            
            // Move to next step after duration
            appState.guideTimeout = setTimeout(() => {
                appState.currentStep++;
                guideNextStep();
            }, stepDuration * 1000);
        }

        // Parse duration string to seconds
        function parseDurationToSeconds(duration) {
            if (!duration) return 60;
            
            let totalSeconds = 0;
            
            // Check for minutes
            const minutesMatch = duration.match(/(\d+)\s*minuto/);
            if (minutesMatch) {
                totalSeconds += parseInt(minutesMatch[1]) * 60;
            }
            
            // Check for seconds
            const secondsMatch = duration.match(/(\d+)\s*segundo/);
            if (secondsMatch) {
                totalSeconds += parseInt(secondsMatch[1]);
            }
            
            return totalSeconds || 60;
        }

        // Start step timer
        function startStepTimer(duration) {
            appState.stepRemainingTime = duration;
            appState.stepStartTime = new Date();
            
            // Update timer immediately
            updateStepTimer();
            
            // Start timer interval
            appState.stepTimer = setInterval(() => {
                appState.stepRemainingTime--;
                updateStepTimer();
                
                if (appState.stepRemainingTime <= 0) {
                    clearInterval(appState.stepTimer);
                }
            }, 1000);
        }

        // Update step timer display
        function updateStepTimer() {
            const minutes = Math.floor(appState.stepRemainingTime / 60);
            const seconds = appState.stepRemainingTime % 60;
            document.getElementById('timer-display').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Complete meditation
        function completeMeditation() {
            pauseMeditationGuide();
            
            // Highlight completion
            const guideSteps = document.getElementById('guide-steps');
            guideSteps.innerHTML += `
                <div class="meditation-step step-active">
                    <div class="flex items-center justify-center text-green-600">
                        <i class="fas fa-check-circle text-2xl mr-3"></i>
                        <div>
                            <p class="font-bold">¬°Meditaci√≥n completada!</p>
                            <p class="text-sm">T√≥mate un momento para notar c√≥mo te sientes.</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Speak completion message
            speakMeditation('Excelente trabajo. Has completado la meditaci√≥n.');
            
            // Hide timer
            document.getElementById('meditation-timer').classList.add('hidden');
        }

        // Save mood entry
        function saveMoodEntry() {
            const notes = document.getElementById('mood-notes').value.trim();
            const moodEntry = {
                mood: appState.currentMood,
                intensity: appState.moodIntensity,
                notes: notes,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('es-ES')
            };
            
            appState.moodHistory.unshift(moodEntry);
            
            // Limit to last 50 entries
            if (appState.moodHistory.length > 50) {
                appState.moodHistory = appState.moodHistory.slice(0, 50);
            }
            
            // Save to localStorage
            saveUserData('moods', appState.moodHistory);
            
            // Update UI
            document.getElementById('mood-status').textContent = '‚úÖ Estado registrado exitosamente';
            document.getElementById('mood-status').style.color = 'var(--success)';
            
            // Clear notes
            document.getElementById('mood-notes').value = '';
            
            // Update dashboard
            updateDashboard();
            
            // Update wellness score
            updateWellnessScore();
            
            // Update daily tip based on mood
            showDailyTip();
            
            // Play success sound
            playSuccessSound();
            
            // Hide status message after 3 seconds
            setTimeout(() => {
                document.getElementById('mood-status').textContent = '';
            }, 3000);
        }

        // Save journal entry
        function saveJournalEntry() {
            const title = document.getElementById('journal-title').value.trim();
            const content = document.getElementById('journal-entry').value.trim();
            const isPrivate = document.getElementById('journal-private').checked;
            
            if (!content) {
                alert('Por favor, escribe algo en tu diario antes de guardar.');
                return;
            }
            
            const journalEntry = {
                title: title || 'Sin t√≠tulo',
                content: content,
                private: isPrivate,
                date: new Date().toISOString(),
                mood: appState.currentMood
            };
            
            // Add to saved journals
            appState.savedJournals.unshift(journalEntry);
            
            // Save to localStorage
            saveUserData('journals', appState.savedJournals);
            
            // Update UI
            document.getElementById('journal-status').textContent = '‚úÖ Entrada guardada en tu diario';
            document.getElementById('journal-status').style.color = 'var(--success)';
            
            // Clear fields
            document.getElementById('journal-title').value = '';
            document.getElementById('journal-entry').value = '';
            
            // Update calendar
            updateCalendarDisplay();
            
            // Play success sound
            playSuccessSound();
            
            // Hide status message after 3 seconds
            setTimeout(() => {
                document.getElementById('journal-status').textContent = '';
            }, 3000);
        }

        // Start Wim Hof breathing with balloon animation and voice
        function startBreathing() {
            if (appState.breathingActive) {
                stopBreathing();
                return;
            }
            
            appState.breathingActive = true;
            appState.breathCount = 0;
            appState.breathPhase = 'inhale';
            
            document.getElementById('start-breathing').innerHTML = '<i class="fas fa-pause mr-2"></i> Pausar';
            document.getElementById('breath-phase').textContent = 'INHALA';
            document.getElementById('breath-timer').textContent = '4';
            document.getElementById('breath-cycle').textContent = '0';
            
            // Speak initial instruction
            if (appState.breathingVoiceEnabled) {
                speakWimHof("Comencemos. M√©todo Wim Hof. Inhala profundamente.");
            }
            
            // Start breathing cycle with balloon animation and voice
            breathingCycleWithBalloonAndVoice();
        }

        // Stop breathing
        function stopBreathing() {
            appState.breathingActive = false;
            document.getElementById('start-breathing').innerHTML = '<i class="fas fa-play mr-2"></i> Comenzar';
            document.getElementById('breath-phase').textContent = 'LISTO';
            document.getElementById('breath-timer').textContent = '--';
            
            // Stop voice
            if (wimHofSpeech) {
                speechSynthesis.cancel(wimHofSpeech);
            }
            
            // Reset balloon
            const balloon = document.getElementById('breathing-balloon');
            balloon.classList.remove('inhaling', 'exhaling', 'holding');
            balloon.style.transform = 'scale(1)';
            balloon.style.width = '150px';
            balloon.style.height = '200px';
            
            // Clear any active timeouts
            if (appState.breathingTimeout) {
                clearTimeout(appState.breathingTimeout);
            }
            if (appState.countdownInterval) {
                clearInterval(appState.countdownInterval);
            }
        }

        // Reset breathing
        function resetBreathing() {
            stopBreathing();
            appState.breathCount = 0;
            appState.breathPhase = 'ready';
            document.getElementById('breath-cycle').textContent = '0';
            document.getElementById('breath-phase').textContent = 'LISTO';
            document.getElementById('breath-timer').textContent = '--';
        }

        // Breathing cycle with balloon animation and Wim Hof voice
        function breathingCycleWithBalloonAndVoice() {
            if (!appState.breathingActive) return;
            
            const breathPhase = document.getElementById('breath-phase');
            const breathTimer = document.getElementById('breath-timer');
            const balloon = document.getElementById('breathing-balloon');
            
            let timer = 4;
            
            function updateTimer() {
                if (!appState.breathingActive) return;
                
                breathTimer.textContent = timer;
                document.getElementById('breath-cycle').textContent = appState.breathCount;
                
                if (timer > 0) {
                    timer--;
                    appState.breathingTimeout = setTimeout(updateTimer, 1000);
                } else {
                    // Play click sound on phase change
                    playClickSound();
                    
                    // Switch phase with balloon animation
                    if (appState.breathPhase === 'inhale') {
                        // Play exhale sound
                        exhaleSound.currentTime = 0;
                        exhaleSound.play();
                        
                        // Speak exhale instruction
                        if (appState.breathingVoiceEnabled) {
                            speakWimHof("Exhala suavemente");
                        }
                        
                        // Animate balloon deflating
                        balloon.classList.remove('inhaling');
                        balloon.classList.add('exhaling');
                        
                        appState.breathPhase = 'exhale';
                        breathPhase.textContent = 'EXHALA';
                        appState.breathCount++;
                        
                        if (appState.breathCount >= appState.maxBreaths) {
                            // Start retention phase
                            breathPhase.textContent = 'RETEN';
                            breathTimer.textContent = '60';
                            
                            // Balloon holds inflated
                            balloon.classList.remove('exhaling');
                            balloon.classList.add('holding');
                            
                            // Speak retention instruction
                            if (appState.breathingVoiceEnabled) {
                                speakWimHof("Ret√©n la respiraci√≥n");
                            }
                            
                            playClickSound();
                            appState.breathingTimeout = setTimeout(() => {
                                if (appState.breathingActive) {
                                    // Final inhale with click and balloon animation
                                    playClickSound();
                                    inhaleSound.currentTime = 0;
                                    inhaleSound.play();
                                    
                                    // Final balloon inflation
                                    balloon.classList.remove('holding');
                                    balloon.classList.add('inhaling');
                                    
                                    breathPhase.textContent = 'INHALA FINAL';
                                    breathTimer.textContent = '15';
                                    
                                    // Speak final instruction
                                    if (appState.breathingVoiceEnabled) {
                                        speakWimHof("Inhala profundamente y mant√©n");
                                    }
                                    
                                    appState.breathingTimeout = setTimeout(() => {
                                        stopBreathing();
                                        // Play completion sound
                                        playSuccessSound();
                                        if (appState.breathingVoiceEnabled) {
                                            speakWimHof("Excelente. Sesi√≥n completada.");
                                        }
                                    }, 15000);
                                }
                            }, 60000);
                            return;
                        }
                    } else {
                        // Play inhale sound
                        inhaleSound.currentTime = 0;
                        inhaleSound.play();
                        
                        // Speak inhale instruction
                        if (appState.breathingVoiceEnabled) {
                            speakWimHof("Inhala profundamente");
                        }
                        
                        // Animate balloon inflating
                        balloon.classList.remove('exhaling');
                        balloon.classList.add('inhaling');
                        
                        appState.breathPhase = 'inhale';
                        breathPhase.textContent = 'INHALA';
                    }
                    
                    // Reset timer
                    timer = 4;
                    appState.breathingTimeout = setTimeout(updateTimer, 1000);
                }
            }
            
            // Start first inhale with sound, click and balloon animation
            playClickSound();
            inhaleSound.currentTime = 0;
            inhaleSound.play();
            balloon.classList.add('inhaling');
            updateTimer();
        }

        // Save meditation
        function saveMeditation() {
            if (appState.meditationSteps.length === 0) return;
            
            const meditation = {
                theme: appState.meditationTheme,
                steps: appState.meditationSteps,
                timestamp: new Date().toISOString(),
                guided: true
            };
            
            appState.savedMeditations.unshift(meditation);
            
            // Save to localStorage
            saveUserData('meditations', appState.savedMeditations);
            
            // Show confirmation
            const saveBtn = document.getElementById('save-meditation-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-check mr-1"></i> ¬°Guardada!';
            saveBtn.style.color = 'var(--success)';
            
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.style.color = '';
            }, 2000);
            
            playSuccessSound();
        }

        // Update dashboard
        function updateDashboard() {
            // Update mood chart
            updateMoodChart();
            
            // Update stats
            updateStats();
        }

        // Update mood chart
        function updateMoodChart() {
            const chartContainer = document.getElementById('mood-chart');
            
            if (appState.moodHistory.length === 0) {
                chartContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Registra tu estado de √°nimo para ver estad√≠sticas</p>';
                return;
            }
            
            // Get mood counts for last 7 entries
            const recentMoods = appState.moodHistory.slice(0, 7);
            const moodCounts = {};
            
            recentMoods.forEach(entry => {
                moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
            });
            
            // Calculate percentages
            const total = recentMoods.length;
            chartContainer.innerHTML = '';
            
            Object.entries(moodCounts).forEach(([mood, count]) => {
                const percentage = (count / total) * 100;
                const config = moodConfig[mood];
                
                if (config) {
                    const bar = document.createElement('div');
                    bar.className = 'flex items-center';
                    bar.innerHTML = `
                        <div class="w-1/4 flex items-center">
                            <span class="text-lg mr-2">${config.emoji}</span>
                            <span class="text-sm font-medium">${config.name}</span>
                        </div>
                        <div class="flex-grow bg-gray-200 rounded-full overflow-hidden">
                            <div class="mood-bar h-2 rounded-full" style="width: ${percentage}%; background-color: ${config.color};"></div>
                        </div>
                        <div class="w-16 text-right">
                            <span class="text-xs font-medium">${percentage.toFixed(0)}%</span>
                        </div>
                    `;
                    chartContainer.appendChild(bar);
                }
            });
        }

        // Update stats
        function updateStats() {
            // Update consecutive days
            const consecutiveDays = calculateConsecutiveDays();
            document.querySelector('.bg-green-50\\/70 .text-2xl').textContent = consecutiveDays;
            
            // Update meditation count
            const meditationCount = (appState.savedMeditations ? appState.savedMeditations.length : 0) + 3;
            document.querySelector('.bg-purple-50\\/70 .text-2xl').textContent = meditationCount;
            
            // Update journal entries count
            const journalCount = appState.savedJournals.length;
            document.querySelector('.bg-yellow-50\\/70 .text-2xl').textContent = journalCount;
            
            // Update average mood
            if (appState.moodHistory.length > 0) {
                const avgIntensity = appState.moodHistory
                    .slice(0, 7)
                    .reduce((sum, entry) => sum + entry.intensity, 0) / 
                    Math.min(appState.moodHistory.length, 7);
                document.querySelector('.bg-blue-50\\/70 .text-2xl').textContent = avgIntensity.toFixed(1);
            }
        }

        // Calculate consecutive days
        function calculateConsecutiveDays() {
            if (appState.moodHistory.length === 0) return 0;
            
            let consecutive = 1;
            
            for (let i = 0; i < appState.moodHistory.length - 1; i++) {
                const currentDate = new Date(appState.moodHistory[i].timestamp);
                const nextDate = new Date(appState.moodHistory[i + 1].timestamp);
                const diffDays = Math.floor((currentDate - nextDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    consecutive++;
                } else if (diffDays > 1) {
                    break;
                }
            }
            
            return consecutive;
        }

        // Update wellness score
        function updateWellnessScore() {
            let score = 85; // Base score
            
            // Bonus for consistent tracking
            if (appState.moodHistory.length >= 7) score += 5;
            if (appState.moodHistory.length >= 14) score += 5;
            
            // Bonus for saved meditations
            score += Math.min((appState.savedMeditations ? appState.savedMeditations.length : 0) * 2, 10);
            
            // Bonus for journal entries
            score += Math.min(appState.savedJournals.length * 2, 10);
            
            // Bonus for chat engagement
            if (appState.chatHistory.length > 2) score += 5;
            
            // Cap at 100
            score = Math.min(score, 100);
            
            document.getElementById('wellness-score').textContent = score;
        }

        // Show daily tip
        function showDailyTip() {
            // Get day of month (1-31)
            const dayOfMonth = new Date().getDate();
            let tipIndex = (dayOfMonth - 1) % dailyTips.length;
            
            // Adjust tip based on user's mood if available
            if (appState.moodHistory.length > 0) {
                const latestMood = appState.moodHistory[0].mood;
                
                // Adjust tip based on mood
                if (latestMood === 'triste' || latestMood === 'ansioso') {
                    // Show more comforting tips
                    tipIndex = (tipIndex + 10) % dailyTips.length;
                } else if (latestMood === 'excelente' || latestMood === 'bien') {
                    // Show more uplifting tips
                    tipIndex = (tipIndex + 20) % dailyTips.length;
                }
            }
            
            document.getElementById('daily-tip-title').textContent = `Consejo del D√≠a üåü`;
            document.getElementById('daily-tip-content').textContent = dailyTips[tipIndex];
        }

        // Generate AI Analysis
        function generateAIAnalysis() {
            const btn = document.getElementById('ai-analysis-btn');
            const resultDiv = document.getElementById('ai-analysis-result');
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analizando...';
            resultDiv.classList.add('hidden');
            
            // Simulate AI processing delay
            setTimeout(() => {
                // Generate analysis based on user data
                const analysis = generatePersonalizedAnalysis();
                
                // Display results
                resultDiv.innerHTML = `
                    <h4 class="font-bold text-blue-800 mb-2">üìà Tu An√°lisis Personalizado:</h4>
                    <div class="space-y-3">
                        ${analysis.map(item => `
                            <div class="p-2 bg-white rounded border-l-4 ${item.color}">
                                <p class="font-medium">${item.title}</p>
                                <p class="text-sm">${item.content}</p>
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-xs text-blue-600 mt-3 italic">Basado en tus datos de los √∫ltimos ${appState.moodHistory.length > 0 ? '7 d√≠as' : 'pocos d√≠as'}.</p>
                `;
                
                resultDiv.classList.remove('hidden');
                
                // Reset button
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-robot mr-2"></i>Obtener An√°lisis Personalizado';
                
                // Play success sound
                playSuccessSound();
            }, 2000);
        }

        // Generate personalized analysis
        function generatePersonalizedAnalysis() {
            const analysis = [];
            
            if (appState.moodHistory.length === 0) {
                analysis.push({
                    title: "üí≠ Bienvenida/o",
                    content: "Veo que est√°s comenzando tu camino en CalmApp. Registra tu estado de √°nimo diario para obtener an√°lisis m√°s personalizados.",
                    color: "border-blue-400"
                });
                analysis.push({
                    title: "üåü Primer Paso",
                    content: "Te recomiendo comenzar con la meditaci√≥n guiada de respiraci√≥n para establecer una rutina diaria.",
                    color: "border-green-400"
                });
                analysis.push({
                    title: "üìù Consejo Inicial",
                    content: "Intenta escribir en el diario emocional al menos 2 veces por semana para procesar tus emociones.",
                    color: "border-purple-400"
                });
                return analysis;
            }
            
            // Calculate average mood
            const avgMood = appState.moodHistory
                .slice(0, 7)
                .reduce((sum, entry) => sum + entry.intensity, 0) / 
                Math.min(appState.moodHistory.length, 7);
            
            // Mood analysis
            if (avgMood >= 7) {
                analysis.push({
                    title: "üòä Estado Positivo",
                    content: "Tu estado de √°nimo promedio es positivo. Esto indica que est√°s manejando bien el estr√©s diario.",
                    color: "border-green-400"
                });
            } else if (avgMood >= 5) {
                analysis.push({
                    title: "üòê Estado Neutral",
                    content: "Tu estado de √°nimo se mantiene en niveles promedio. Considera incorporar m√°s actividades que te generen bienestar.",
                    color: "border-yellow-400"
                });
            } else {
                analysis.push({
                    title: "üòî Estado Bajo",
                    content: "Noto que tu estado de √°nimo promedio est√° bajo. Te recomiendo practicar la meditaci√≥n para ansiedad y escribir en tu diario.",
                    color: "border-red-400"
                });
            }
            
            // Consistency analysis
            const consecutiveDays = calculateConsecutiveDays();
            if (consecutiveDays >= 7) {
                analysis.push({
                    title: "üìÖ Excelente Consistencia",
                    content: `Llevas ${consecutiveDays} d√≠as consecutivos registrando tu estado. Esta consistencia es clave para el autoconocimiento.`,
                    color: "border-blue-400"
                });
            } else if (consecutiveDays >= 3) {
                analysis.push({
                    title: "üìÖ Buena Regularidad",
                    content: `Llevas ${consecutiveDays} d√≠as consecutivos. Sigue as√≠ para establecer un h√°bito saludable.`,
                    color: "border-green-400"
                });
            }
            
            // Journal analysis
            const journalCount = appState.savedJournals.length;
            if (journalCount >= 5) {
                analysis.push({
                    title: "üìñ Diario Activo",
                    content: "Tienes varias entradas en tu diario. Esta pr√°ctica te ayuda a procesar emociones y ganar claridad.",
                    color: "border-purple-400"
                });
            }
            
            // Meditation analysis
            const meditationCount = (appState.savedMeditations ? appState.savedMeditations.length : 0);
            if (meditationCount >= 3) {
                analysis.push({
                    title: "üßò‚Äç‚ôÄÔ∏è Pr√°ctica de Meditaci√≥n",
                    content: "Has completado varias meditaciones. La pr√°ctica regular mejora la concentraci√≥n y reduce el estr√©s.",
                    color: "border-teal-400"
                });
            }
            
            // General recommendation
            analysis.push({
                title: "üí° Recomendaci√≥n Personalizada",
                content: getPersonalizedRecommendation(avgMood, consecutiveDays),
                color: "border-pink-400"
            });
            
            return analysis;
        }

        // Get personalized recommendation
        function getPersonalizedRecommendation(avgMood, consecutiveDays) {
            if (avgMood < 5) {
                return "Te sugiero practicar la meditaci√≥n para ansiedad y establecer rutinas de autocuidado diarias.";
            } else if (avgMood < 7) {
                return "Incorpora m√°s actividades que disfrutes y considera establecer l√≠mites digitales saludables.";
            } else {
                return "Mant√©n tus buenos h√°bitos. Explora nuevas formas de meditaci√≥n para continuar tu crecimiento personal.";
            }
        }

        // Update detox state
        function updateDetoxState() {
            appState.detoxChecks = {
                notifications: document.getElementById('detox-notifications').checked,
                screens: document.getElementById('detox-screens').checked,
                meals: document.getElementById('detox-meals').checked
            };
            
            // Save detox state
            saveUserData('detox', appState.detoxChecks);
        }

        // Update detox checkboxes from state
        function updateDetoxCheckboxes() {
            document.getElementById('detox-notifications').checked = appState.detoxChecks.notifications;
            document.getElementById('detox-screens').checked = appState.detoxChecks.screens;
            document.getElementById('detox-meals').checked = appState.detoxChecks.meals;
            
            updateDetoxState();
        }

        // Activate detox mode
        function activateDetoxMode() {
            const customCommitment = document.getElementById('detox-custom').value.trim();
            let activeCommitments = [];
            
            if (appState.detoxChecks.notifications) activeCommitments.push('Notificaciones silenciadas por 2 horas');
            if (appState.detoxChecks.screens) activeCommitments.push('Sin pantallas 1 hora antes de dormir');
            if (appState.detoxChecks.meals) activeCommitments.push('Comer sin dispositivos m√≥viles');
            if (customCommitment) activeCommitments.push(customCommitment);
            
            if (activeCommitments.length === 0) {
                document.getElementById('detox-status').textContent = '‚ö†Ô∏è Selecciona al menos un compromiso';
                document.getElementById('detox-status').style.color = '#f59e0b';
                return;
            }
            
            // Update UI
            document.getElementById('detox-status').innerHTML = `
                <div class="text-green-600">
                    <i class="fas fa-check-circle mr-2"></i>
                    Modo Desconexi√≥n Activado
                </div>
                <p class="text-xs mt-1">Compromisos activos: ${activeCommitments.join(', ')}</p>
            `;
            
            // Clear custom commitment
            document.getElementById('detox-custom').value = '';
            
            // Play success sound
            playSuccessSound();
            
            // Reset after 5 seconds
            setTimeout(() => {
                document.getElementById('detox-status').innerHTML = '';
            }, 5000);
        }

        // Play success sound
        function playSuccessSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator1 = audioContext.createOscillator();
            const oscillator2 = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator1.connect(gainNode);
            oscillator2.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator1.frequency.value = 800;
            oscillator2.frequency.value = 1200;
            oscillator1.type = 'sine';
            oscillator2.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
            
            oscillator1.start();
            oscillator2.start();
            oscillator1.stop(audioContext.currentTime + 0.8);
            oscillator2.stop(audioContext.currentTime + 0.8);
        }

        // Calendar display functions
        function updateCalendarDisplay() {
            const monthYear = document.getElementById('current-month');
            const calendarDays = document.getElementById('calendar-days');
            
            const year = appState.currentJournalDate.getFullYear();
            const month = appState.currentJournalDate.getMonth();
            
            // Set month/year display
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            monthYear.textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Clear calendar
            calendarDays.innerHTML = '';
            
            // Add day labels
            const dayLabels = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
            dayLabels.forEach(label => {
                const dayLabel = document.createElement('div');
                dayLabel.className = 'text-center text-xs font-medium text-gray-500';
                dayLabel.textContent = label;
                calendarDays.appendChild(dayLabel);
            });
            
            // Add empty cells for days before first day of month
            const firstDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                calendarDays.appendChild(emptyDay);
            }
            
            // Add days of month
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const currentDate = new Date(year, month, day);
                
                // Check if today
                if (currentDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('selected');
                }
                
                // Check if has journal entry
                if (hasJournalEntry(currentDate)) {
                    dayElement.classList.add('has-entry');
                }
                
                // Add click event
                dayElement.addEventListener('click', () => {
                    selectCalendarDay(day);
                });
                
                calendarDays.appendChild(dayElement);
            }
        }

        function hasJournalEntry(date) {
            const dateString = date.toISOString().split('T')[0];
            return appState.savedJournals.some(entry => 
                new Date(entry.date).toISOString().split('T')[0] === dateString
            );
        }

        function selectCalendarDay(day) {
            // Update selected day
            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                dayEl.classList.remove('selected');
            });
            
            const year = appState.currentJournalDate.getFullYear();
            const month = appState.currentJournalDate.getMonth();
            const selectedDate = new Date(year, month, day);
            
            // Find and select the clicked day
            const dayElements = document.querySelectorAll('.calendar-day');
            const clickedElement = Array.from(dayElements).find(el => 
                el.textContent == day && el.classList.contains('calendar-day')
            );
            
            if (clickedElement) {
                clickedElement.classList.add('selected');
                
                // Check if there's a journal entry for this date
                const journalEntry = appState.savedJournals.find(entry => {
                    const entryDate = new Date(entry.date);
                    return entryDate.getFullYear() === year &&
                           entryDate.getMonth() === month &&
                           entryDate.getDate() === day;
                });
                
                if (journalEntry) {
                    // Load journal entry
                    document.getElementById('journal-title').value = journalEntry.title;
                    document.getElementById('journal-entry').value = journalEntry.content;
                    document.getElementById('journal-private').checked = journalEntry.private;
                } else {
                    // Clear fields for new entry
                    document.getElementById('journal-title').value = '';
                    document.getElementById('journal-entry').value = '';
                    document.getElementById('journal-private').checked = false;
                }
            }
        }

        // Chat functions
        function updateChatDisplay() {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '';
            
            appState.chatHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.role === 'user' ? 'user-message' : 'assistant-message neuro-message'}`;
                messageDiv.innerHTML = `<strong>${msg.role === 'user' ? 'T√∫' : 'Asistente IA'}:</strong> ${formatMessage(msg.content)}`;
                chatContainer.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function formatMessage(content) {
            return content;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('user-message');
            const message = messageInput.value.trim();
            const loadingDiv = document.getElementById('ai-loading');
            
            if (!message) {
                alert('Por favor, escribe un mensaje.');
                return;
            }
            
            // Add user message
            appState.chatHistory.push({
                role: 'user',
                content: message
            });
            
            updateChatDisplay();
            
            // Show loading
            loadingDiv.classList.remove('hidden');
            messageInput.disabled = true;
            document.getElementById('send-message-btn').disabled = true;
            
            // Clear input
            messageInput.value = '';
            
            try {
                // Generate intelligent response
                const response = await getIntelligentResponse(message);
                
                // Add AI response
                appState.chatHistory.push({
                    role: 'assistant',
                    content: response
                });
                
                updateChatDisplay();
                
                // Save chat history
                saveUserData('chat', appState.chatHistory);
                
            } catch (error) {
                console.error('Error con la IA:', error);
                
                // Fallback a respuestas locales inteligentes
                const fallbackResponse = getFallbackResponse(message);
                
                appState.chatHistory.push({
                    role: 'assistant',
                    content: fallbackResponse
                });
                
                updateChatDisplay();
                
                // Update model info
                document.getElementById('chat-model-info').textContent = 'Usando respuestas locales mejoradas';
            }
            
            // Hide loading
            loadingDiv.classList.add('hidden');
            messageInput.disabled = false;
            document.getElementById('send-message-btn').disabled = false;
            
            // Play success sound
            playSuccessSound();
        }

        async function getIntelligentResponse(message) {
            // Analizar el mensaje
            const lowerMessage = message.toLowerCase();
            
            // Detectar emociones
            const emotions = detectEmotions(lowerMessage);
            
            // Generar respuesta basada en an√°lisis
            return generateContextualResponse(message, emotions);
        }

        function detectEmotions(message) {
            const emotions = [];
            const emotionKeywords = {
                'feliz': ['feliz', 'contento', 'alegre', 'emocionado'],
                'triste': ['triste', 'deprimido', 'desanimado', 'melanc√≥lico'],
                'ansioso': ['ansioso', 'nervioso', 'preocupado', 'agitado'],
                'estresado': ['estresado', 'agobiado', 'presionado'],
                'enfadado': ['enfadado', 'enojado', 'frustrado', 'irritado'],
                'calmado': ['calmado', 'tranquilo', 'relajado', 'pac√≠fico']
            };
            
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                if (keywords.some(keyword => message.includes(keyword))) {
                    emotions.push(emotion);
                }
            }
            
            return emotions;
        }

        function generateContextualResponse(message, emotions) {
            if (emotions.length > 0) {
                const emotion = emotions[0];
                const emotionResponses = {
                    'feliz': `Me alegra mucho que te sientas ${emotion}. ¬øQuieres compartir qu√© est√° contribuyendo a esta buena energ√≠a? Podr√≠as aprovechar este estado para practicar alguna actividad que disfrutes.`,
                    'triste': `Entiendo que te sientas ${emotion}. La tristeza es una emoci√≥n v√°lida y necesaria. ¬øTe gustar√≠a hablar m√°s sobre lo que te hace sentir as√≠? Podr√≠a sugerirte la meditaci√≥n para el √°nimo bajo.`,
                    'ansioso': `Veo que est√°s sintiendo ${emotion}. La ansiedad puede ser abrumadora, pero hay formas de manejarla. ¬øHas probado el ejercicio de respiraci√≥n con el globo? Podr√≠a ayudarte a calmarte.`,
                    'estresado': `El ${emotion} es com√∫n en nuestro ritmo de vida. Te sugiero probar la desconexi√≥n digital o una meditaci√≥n de relajaci√≥n. ¬øQu√© te est√° causando m√°s estr√©s actualmente?`,
                    'enfadado': `La ${emotion} es una emoci√≥n protectora. Identificar qu√© la desencadena puede ayudar. ¬øQuieres explorar eso juntos? Podr√≠as probar escribir en tu diario sobre ello.`,
                    'calmado': `Qu√© bien que te sientas ${emotion}. Este es un estado ideal para la pr√°ctica de mindfulness. ¬øTe gustar√≠a intentar una meditaci√≥n de concentraci√≥n?`
                };
                
                if (emotionResponses[emotion]) {
                    return emotionResponses[emotion];
                }
            }
            
            // Respuesta general emp√°tica
            const empatheticResponses = [
                'Gracias por compartir eso conmigo. Me ayuda a entender mejor c√≥mo puedo apoyarte.',
                'Escucho lo que dices y valido lo que sientes. ¬øHay algo espec√≠fico en lo que te gustar√≠a que te ayude hoy?',
                'Me haces reflexionar sobre lo complejas que pueden ser nuestras experiencias emocionales. ¬øQuieres seguir explorando esto?',
                'Aprecio tu confianza al compartir esto. Como asistente de bienestar, te recuerdo que estoy aqu√≠ para apoyarte.',
                'Cada persona tiene su propio ritmo en el camino del bienestar emocional. ¬øC√≥mo sientes que va el tuyo?',
                'La autocompasi√≥n es clave en momentos as√≠. ¬øHas sido amable contigo mismo hoy?',
                'A veces, el simple hecho de ser escuchado puede hacer una gran diferencia. Estoy aqu√≠ para eso.',
                'Tu bienestar emocional es un viaje, no un destino. Celebro cada paso que das.'
            ];
            
            return empatheticResponses[Math.floor(Math.random() * empatheticResponses.length)];
        }

        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Respuesta emocionalmente inteligente
            const emotionalWords = {
                'triste': 'Entiendo que te sientas as√≠. La tristeza es una emoci√≥n v√°lida y natural. ¬øQuieres hablar m√°s sobre lo que te hace sentir as√≠?',
                'ansioso': 'La ansiedad puede ser dif√≠cil de manejar. Te sugiero probar el ejercicio de respiraci√≥n o la meditaci√≥n para ansiedad. ¬øTe gustar√≠a que te gu√≠e?',
                'estresado': 'El estr√©s acumulado puede ser agotador. Recuerda tomarte pausas breves durante el d√≠a. ¬øQu√© te est√° causando m√°s estr√©s actualmente?',
                'feliz': '¬°Qu√© maravilloso! Celebrar los momentos felices es tan importante como procesar los dif√≠ciles. ¬øQuieres compartir qu√© te hace sentir as√≠?',
                'solo': 'A veces nos sentimos solos incluso rodeados de gente. Estoy aqu√≠ para ti. ¬øHay alguien con quien podr√≠as conectarte hoy?',
                'confundido': 'La confusi√≥n es parte del proceso de crecimiento. A veces, escribir en el diario ayuda a clarificar pensamientos. ¬øHas intentado eso?',
                'cansado': 'El agotamiento puede ser f√≠sico, mental o emocional. Es importante descansar. ¬øHas dormido bien √∫ltimamente?',
                'enfadado': 'La ira es una emoci√≥n protectora. Identificar qu√© la desencadena puede ayudar a manejarla. ¬øQuieres explorar eso juntos?'
            };
            
            for (const [word, response] of Object.entries(emotionalWords)) {
                if (lowerMessage.includes(word)) {
                    return response;
                }
            }
            
            // Respuesta general emp√°tica
            const empatheticResponses = [
                'Gracias por compartir eso conmigo. Cada experiencia que compartes me ayuda a entender mejor c√≥mo acompa√±arte en tu camino de bienestar.',
                'Valoro tu honestidad al expresar lo que sientes. El autoconocimiento emocional es un paso importante hacia el equilibrio interno.',
                'Me haces reflexionar sobre la complejidad de nuestras experiencias humanas. ¬øHay alg√∫n aspecto espec√≠fico de lo que compartes que te gustar√≠a explorar m√°s?',
                'Aprecio que conf√≠es en m√≠ con tus pensamientos. Como tu asistente de bienestar, mi prop√≥sito es ofrecerte un espacio seguro para la expresi√≥n emocional.',
                'Cada persona tiene su propio ritmo en el proceso de autodescubrimiento emocional. No hay prisa, solo presencia en el camino.'
            ];
            
            return empatheticResponses[Math.floor(Math.random() * empatheticResponses.length)];
        }

        function clearChat() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar toda la conversaci√≥n?')) {
                appState.chatHistory = [{
                    role: 'assistant',
                    content: '¬°Hola! üëã Soy tu asistente de bienestar emocional. Estoy aqu√≠ para escucharte, entenderte y acompa√±arte en tu d√≠a. Puedes contarme c√≥mo te sientes, qu√© te preocupa, qu√© te gusta hacer, o simplemente conversar. ¬øC√≥mo te sientes hoy?'
                }];
                
                updateChatDisplay();
                saveUserData('chat', appState.chatHistory);
                
                // Reset model info
                document.getElementById('chat-model-info').textContent = 'Chat inteligente con an√°lisis emocional';
                
                playSuccessSound();
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
